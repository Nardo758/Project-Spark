<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - OppGrid</title>
    <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --stone-50: #fafaf9;
            --stone-100: #f5f5f4;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-400: #a8a29e;
            --stone-500: #78716c;
            --stone-600: #57534e;
            --stone-700: #44403c;
            --stone-800: #292524;
            --stone-900: #1c1917;
            --violet-50: #f5f3ff;
            --violet-100: #ede9fe;
            --violet-200: #ddd6fe;
            --violet-600: #1c1917;
            --violet-700: #292524;
            --red-50: #fef2f2;
            --red-100: #fee2e2;
            --red-500: #ef4444;
            --red-600: #dc2626;
            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-500: #22c55e;
            --green-600: #16a34a;
            --amber-50: #fffbeb;
            --amber-100: #fef3c7;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--stone-100);
            color: var(--stone-900);
            min-height: 100vh;
            line-height: 1.6;
        }

        .spektral {
            font-family: 'Spectral', serif;
        }

        nav {
            background: var(--stone-900);
            border-bottom: 1px solid var(--stone-700);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .logo-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--white);
        }

        .admin-badge {
            background: var(--violet-600);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-user span {
            color: var(--stone-300);
            font-size: 14px;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--stone-600);
            color: var(--stone-300);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: var(--stone-800);
            border-color: var(--stone-500);
        }

        .admin-layout {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        .sidebar {
            width: 240px;
            background: var(--white);
            border-right: 1px solid var(--stone-200);
            padding: 24px 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            text-decoration: none;
            color: var(--stone-600);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-nav li a:hover {
            background: var(--stone-50);
            color: var(--stone-900);
        }

        .sidebar-nav li a.active {
            background: var(--violet-50);
            color: var(--violet-700);
            border-left-color: var(--violet-600);
        }

        .sidebar-nav li a svg {
            width: 20px;
            height: 20px;
        }

        .main-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-family: 'Spectral', serif;
            font-size: 28px;
            color: var(--stone-900);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--stone-500);
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--stone-200);
        }

        .stat-card .stat-label {
            font-size: 13px;
            color: var(--stone-500);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .stat-card .stat-change {
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-card .stat-change.positive {
            color: var(--green-600);
        }

        .stat-card .stat-change.negative {
            color: var(--red-500);
        }

        .content-section {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--stone-200);
            margin-bottom: 24px;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .section-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            padding: 8px 16px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
            width: 250px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--violet-600);
        }

        .filter-select {
            padding: 8px 16px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
            background: var(--white);
            cursor: pointer;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 14px 24px;
            background: var(--stone-50);
            font-size: 12px;
            font-weight: 600;
            color: var(--stone-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--stone-200);
        }

        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--stone-100);
            font-size: 14px;
        }

        .data-table tr:hover {
            background: var(--stone-50);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--violet-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--violet-700);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            color: var(--stone-900);
        }

        .user-email {
            font-size: 12px;
            color: var(--stone-500);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-admin {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-verified {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-banned {
            background: var(--red-100);
            color: var(--red-600);
        }

        .badge-free {
            background: var(--stone-100);
            color: var(--stone-600);
        }

        .badge-pro {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .badge-business {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-enterprise {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        .badge-active {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-canceled {
            background: var(--red-100);
            color: var(--red-600);
        }

        .badge-pending {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        /* Partner outreach statuses */
        .badge-identified {
            background: var(--stone-100);
            color: var(--stone-600);
        }

        .badge-contacted {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .badge-in_talks {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-paused {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        .badge-rejected {
            background: var(--red-100);
            color: var(--red-600);
        }

        /* Job run statuses */
        .badge-running {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        .badge-succeeded {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-failed {
            background: var(--red-100);
            color: var(--red-600);
        }

        /* Lead statuses */
        .badge-new {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .badge-qualified {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-nurturing {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-converted {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-lost {
            background: var(--red-100);
            color: var(--red-600);
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--violet-600);
            color: white;
        }

        .btn-primary:hover {
            background: var(--violet-700);
        }

        .btn-danger {
            background: var(--red-50);
            color: var(--red-600);
            border: 1px solid var(--red-200);
        }

        .btn-danger:hover {
            background: var(--red-100);
        }

        .btn-secondary {
            background: var(--stone-100);
            color: var(--stone-700);
            border: 1px solid var(--stone-200);
        }

        .btn-secondary:hover {
            background: var(--stone-200);
        }

        .btn-success {
            background: var(--green-50);
            color: var(--green-600);
            border: 1px solid var(--green-200);
        }

        .btn-success:hover {
            background: var(--green-100);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--stone-500);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--stone-500);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--white);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--stone-500);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--stone-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--stone-700);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--violet-600);
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: var(--green-600);
            color: white;
        }

        .toast-error {
            background: var(--red-600);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <div style="display: flex; align-items: center;">
                <a href="index.html" class="logo">
                    <span class="logo-text">OppGrid</span>
                </a>
                <span class="admin-badge">Admin Panel</span>
            </div>
            <div class="nav-user">
                <span id="admin-name">Loading...</span>
                <button class="btn-logout" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </nav>

    <div class="admin-layout">
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li>
                    <a href="#dashboard" class="active" data-section="dashboard">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#tracking" data-section="tracking">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 14l3-3 4 4 6-6"/>
                        </svg>
                        Tracking
                    </a>
                </li>
                <li>
                    <a href="#ops" data-section="ops">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V3m0 3a3 3 0 1 0 0 6m0-6a3 3 0 1 1 0 6m0 6v3m0-3a3 3 0 1 0 0-6m0 6a3 3 0 1 1 0-6M6 12H3m3 0a3 3 0 1 0 6 0m-6 0a3 3 0 1 1 6 0m12 0h-3m3 0a3 3 0 1 0-6 0m6 0a3 3 0 1 1-6 0"/>
                        </svg>
                        Ops
                    </a>
                </li>
                <li>
                    <a href="#users" data-section="users">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                        Users
                    </a>
                </li>
                <li>
                    <a href="#opportunities" data-section="opportunities">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        Opportunities
                    </a>
                </li>
                <li>
                    <a href="#subscriptions" data-section="subscriptions">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                        Subscriptions
                    </a>
                </li>
                <li>
                    <a href="#partners" data-section="partners">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Partners
                    </a>
                </li>
                <li>
                    <a href="#leads" data-section="leads">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Leads
                    </a>
                </li>
                <li>
                    <a href="#reports" data-section="reports">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Reports
                    </a>
                </li>
                <li>
                    <a href="#scraper" data-section="scraper">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
                        Scraper Data
                    </a>
                </li>
                <li>
                    <a href="#command-center" data-section="command-center">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                        </svg>
                        Command Center
                    </a>
                </li>
                <li>
                    <a href="#google-scraping" data-section="google-scraping">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        Google Scraping
                    </a>
                </li>
                <li>
                    <a href="#consultant-analytics" data-section="consultant-analytics">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                        </svg>
                        Consultant Studio
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <section id="section-dashboard">
                <div class="page-header">
                    <h1 class="spektral">Dashboard</h1>
                    <p>Platform overview and key metrics</p>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="stat-users">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Verified Users</div>
                        <div class="stat-value" id="stat-verified">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Opportunities</div>
                        <div class="stat-value" id="stat-opportunities">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Banned Users</div>
                        <div class="stat-value" id="stat-banned">--</div>
                    </div>
                </div>
            </section>

            <section id="section-tracking" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Tracking</h1>
                    <p>Product analytics (best-effort pageview capture + event debugging)</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Summary</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="tracking-days">
                                <option value="1">Last 1 day</option>
                                <option value="7" selected>Last 7 days</option>
                                <option value="30">Last 30 days</option>
                            </select>
                            <button class="btn-sm btn-primary" onclick="loadTracking()">Refresh</button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="stats-grid" style="margin-bottom: 0;">
                            <div class="stat-card">
                                <div class="stat-label">Total Events</div>
                                <div class="stat-value" id="tracking-total">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Page Views</div>
                                <div class="stat-value" id="tracking-pageviews">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Top Event</div>
                                <div class="stat-value" id="tracking-top-event">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Top Path</div>
                                <div class="stat-value" id="tracking-top-path">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Recent Events</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="tracking-event-filter">
                                <option value="">All events</option>
                                <option value="page_view">page_view</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>When</th>
                                <th>Name</th>
                                <th>Path</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody id="tracking-events-body">
                            <tr><td colspan="4" class="loading">Loading events...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-ops" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Ops</h1>
                    <p>Background jobs and audit logs</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Job Runs</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="jobruns-name" placeholder="job name (e.g. escrow_release)">
                            <select class="filter-select" id="jobruns-status">
                                <option value="">All statuses</option>
                                <option value="running">running</option>
                                <option value="succeeded">succeeded</option>
                                <option value="failed">failed</option>
                            </select>
                            <button class="btn-sm btn-primary" onclick="loadJobRuns()">Refresh</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>When</th>
                                <th>Job</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody id="jobruns-body">
                            <tr><td colspan="5" class="loading">Loading job runs...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Audit Logs</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="audit-action" placeholder="action (e.g. agreement.trigger_payout)">
                            <input type="text" class="search-input" id="audit-resource-type" placeholder="resource_type (e.g. agreement)">
                            <input type="text" class="search-input" id="audit-resource-id" placeholder="resource_id (e.g. 123)">
                            <button class="btn-sm btn-primary" onclick="loadAuditLogs()">Refresh</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>When</th>
                                <th>Actor</th>
                                <th>Action</th>
                                <th>Resource</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="audit-body">
                            <tr><td colspan="5" class="loading">Loading audit logs...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-users" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">User Management</h1>
                    <p>Manage platform users, roles, and permissions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Users</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="user-search" placeholder="Search users...">
                            <select class="filter-select" id="user-filter">
                                <option value="">All Users</option>
                                <option value="admin">Admins</option>
                                <option value="banned">Banned</option>
                                <option value="verified">Verified</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="5" class="loading">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-opportunities" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Opportunity Management</h1>
                    <p>Review and moderate user-submitted opportunities</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Opportunities</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="opp-search" placeholder="Search opportunities...">
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Status</th>
                                <th>Validations</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="opportunities-table-body">
                            <tr><td colspan="6" class="loading">Loading opportunities...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-subscriptions" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Subscription Management</h1>
                    <p>View and manage user subscriptions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Subscriptions</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="sub-tier-filter">
                                <option value="">All Tiers</option>
                                <option value="free">Free</option>
                                <option value="pro">Pro</option>
                                <option value="business">Business</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Tier</th>
                                <th>Status</th>
                                <th>Period End</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptions-table-body">
                            <tr><td colspan="5" class="loading">Loading subscriptions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-partners" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Partner Outreach</h1>
                    <p>Track integration/tool partners and outreach progress</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Partners</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="partner-search" placeholder="Search partners...">
                            <select class="filter-select" id="partner-status-filter">
                                <option value="">All statuses</option>
                                <option value="identified">Identified</option>
                                <option value="contacted">Contacted</option>
                                <option value="in_talks">In talks</option>
                                <option value="active">Active</option>
                                <option value="paused">Paused</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <button class="btn-sm btn-primary" onclick="showPartnerModal()">Add Partner</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Contact</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partners-table-body">
                            <tr><td colspan="6" class="loading">Loading partners...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-leads" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Lead Management</h1>
                    <p>Manage potential customers and lead nurturing campaigns</p>
                </div>

                <div class="stats-grid" id="leads-stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Leads</div>
                        <div class="stat-value" id="leads-total">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">New</div>
                        <div class="stat-value" id="leads-new">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Qualified</div>
                        <div class="stat-value" id="leads-qualified">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Conversion Rate</div>
                        <div class="stat-value" id="leads-conversion">--%</div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Leads Pipeline</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="lead-search" placeholder="Search leads...">
                            <select class="filter-select" id="lead-status-filter">
                                <option value="">All statuses</option>
                                <option value="new">New</option>
                                <option value="contacted">Contacted</option>
                                <option value="qualified">Qualified</option>
                                <option value="nurturing">Nurturing</option>
                                <option value="converted">Converted</option>
                                <option value="lost">Lost</option>
                            </select>
                            <button class="btn-sm btn-success" onclick="bulkNurtureLeads()">Send Nurture Emails</button>
                            <button class="btn-sm btn-primary" onclick="showLeadModal()">Add Lead</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Company</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Sequence</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body">
                            <tr><td colspan="8" class="loading">Loading leads...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-reports" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Content Reports</h1>
                    <p>Review reported content and take moderation actions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Pending Reports</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="report-status-filter">
                                <option value="pending">Pending</option>
                                <option value="reviewing">Reviewing</option>
                                <option value="resolved">Resolved</option>
                                <option value="dismissed">Dismissed</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Content</th>
                                <th>Reason</th>
                                <th>Reporter</th>
                                <th>Status</th>
                                <th>Reported</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body">
                            <tr><td colspan="6" class="loading">Loading reports...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-scraper" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Scraper Data Import</h1>
                    <p>Upload and analyze scraper data to discover business opportunities</p>
                </div>

                <!-- Webhook Calendar -->
                <div class="content-section" style="margin-bottom: 24px;">
                    <div class="section-header">
                        <h2>Data Import Calendar</h2>
                        <div class="section-actions">
                            <button class="btn-sm btn-primary" onclick="loadWebhookCalendar()">Refresh</button>
                        </div>
                    </div>
                    <div id="webhook-calendar-container">
                        <div style="padding: 40px; text-align: center; color: var(--stone-400);">Loading calendar...</div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Upload Scraper Data</h2>
                    </div>
                    <div style="padding: 20px; background: #1a1a2e; border-radius: 12px; margin-bottom: 20px;">
                        <p style="margin-bottom: 15px; color: #a0a0a0;">Upload a JSON file from Reddit scraper (e.g., Apify Reddit Scraper Pro)</p>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="scraper-file" accept=".json" style="color: #fff;">
                            <label style="display: flex; align-items: center; gap: 8px; color: #fff;">
                                <input type="checkbox" id="auto-import-checkbox">
                                Auto-import valid opportunities
                            </label>
                            <button class="btn btn-primary" onclick="analyzeScraperData()">Analyze Data</button>
                        </div>
                    </div>

                    <div id="scraper-stats" style="display: none; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">Analysis Results</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Posts</div>
                                <div class="stat-value" id="scraper-total">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Valid Opportunities</div>
                                <div class="stat-value" id="scraper-valid">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Imported</div>
                                <div class="stat-value" id="scraper-imported">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Skipped</div>
                                <div class="stat-value" id="scraper-skipped">--</div>
                            </div>
                        </div>
                    </div>

                    <div id="scraper-results" style="display: none;">
                        <h3 style="margin-bottom: 15px;">Discovered Opportunities</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Score</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Subreddit</th>
                                    <th>Upvotes</th>
                                </tr>
                            </thead>
                            <tbody id="scraper-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="section-command-center" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Command Center</h1>
                    <p>Centralized management for data sources, validation patterns, and pipeline monitoring</p>
                </div>

                <!-- Command Center Stats -->
                <div class="stats-grid" id="cc-stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Active Sources</div>
                        <div class="stat-value" id="cc-active-sources">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Scraped (24h)</div>
                        <div class="stat-value" id="cc-scraped-24h">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Opportunities (24h)</div>
                        <div class="stat-value" id="cc-opps-24h">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Processing</div>
                        <div class="stat-value" id="cc-pending">--</div>
                    </div>
                </div>

                <!-- Command Center Tabs -->
                <div class="content-section" style="margin-bottom: 24px;">
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--stone-200); padding-bottom: 12px;">
                        <button class="btn-sm btn-primary cc-tab-btn active" data-cc-tab="sources">Data Sources</button>
                        <button class="btn-sm cc-tab-btn" data-cc-tab="patterns">Validation Patterns</button>
                        <button class="btn-sm cc-tab-btn" data-cc-tab="jobs">Jobs & Queue</button>
                        <button class="btn-sm cc-tab-btn" data-cc-tab="pipeline">Pipeline Stats</button>
                        <button class="btn-sm cc-tab-btn" data-cc-tab="apify">Apify Scrapers</button>
                        <button class="btn-sm cc-tab-btn" data-cc-tab="serpapi">SerpAPI</button>
                    </div>

                    <!-- Sources Tab -->
                    <div id="cc-tab-sources" class="cc-tab-content">
                        <div class="section-header">
                            <h2>Data Sources</h2>
                            <div class="section-actions">
                                <button class="btn-sm btn-primary" onclick="seedDefaultSources()">Seed Defaults</button>
                                <button class="btn-sm" onclick="showAddSourceModal()">+ Add Source</button>
                                <button class="btn-sm" onclick="loadCommandCenterSources()">Refresh</button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Weight</th>
                                    <th>Total Scrapes</th>
                                    <th>Valid Opps</th>
                                    <th>Last Scraped</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cc-sources-table-body">
                                <tr><td colspan="8" class="loading">Loading sources...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Patterns Tab -->
                    <div id="cc-tab-patterns" class="cc-tab-content hidden">
                        <div class="section-header">
                            <h2>Validation Patterns</h2>
                            <div class="section-actions">
                                <select class="filter-select" id="cc-pattern-category-filter">
                                    <option value="">All Categories</option>
                                </select>
                                <button class="btn-sm" onclick="showAddPatternModal()">+ Add Pattern</button>
                                <button class="btn-sm" onclick="loadCommandCenterPatterns()">Refresh</button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pattern Name</th>
                                    <th>Category</th>
                                    <th>Confidence</th>
                                    <th>Validation Level</th>
                                    <th>Hits</th>
                                    <th>False Positives</th>
                                    <th>Last Match</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cc-patterns-table-body">
                                <tr><td colspan="9" class="loading">Loading patterns...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Jobs Tab -->
                    <div id="cc-tab-jobs" class="cc-tab-content hidden">
                        <div class="section-header">
                            <h2>Scrape Jobs</h2>
                            <div class="section-actions">
                                <select class="filter-select" id="cc-job-status-filter">
                                    <option value="">All Statuses</option>
                                    <option value="pending">Pending</option>
                                    <option value="running">Running</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                                <button class="btn-sm btn-primary" onclick="showCreateJobModal()">+ Create Job</button>
                                <button class="btn-sm" onclick="loadCommandCenterJobs()">Refresh</button>
                            </div>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Source</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Processed</th>
                                    <th>Accepted</th>
                                    <th>Rejected</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cc-jobs-table-body">
                                <tr><td colspan="9" class="loading">Loading jobs...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pipeline Stats Tab -->
                    <div id="cc-tab-pipeline" class="cc-tab-content hidden">
                        <div class="section-header">
                            <h2>Pipeline Statistics</h2>
                            <div class="section-actions">
                                <button class="btn-sm" onclick="loadCommandCenterPipeline()">Refresh</button>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px;">
                            <div style="background: var(--stone-50); border-radius: 12px; padding: 20px;">
                                <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700);">Source Performance</h3>
                                <div id="cc-source-performance">
                                    <div style="color: var(--stone-400);">Loading...</div>
                                </div>
                            </div>
                            <div style="background: var(--stone-50); border-radius: 12px; padding: 20px;">
                                <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700);">Category Breakdown</h3>
                                <div id="cc-category-breakdown">
                                    <div style="color: var(--stone-400);">Loading...</div>
                                </div>
                            </div>
                        </div>

                        <div style="margin-top: 24px; background: var(--stone-50); border-radius: 12px; padding: 20px;">
                            <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700);">Hourly Processing (Last 24h)</h3>
                            <div id="cc-hourly-stats" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <div style="color: var(--stone-400);">Loading...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Apify Scrapers Tab -->
                    <div id="cc-tab-apify" class="cc-tab-content hidden">
                        <div class="section-header">
                            <h2>Apify Scrapers</h2>
                            <div class="section-actions">
                                <button class="btn-sm" onclick="loadApifyActors()">Refresh Actors</button>
                                <button class="btn-sm" onclick="loadApifySchedules()">Refresh Schedules</button>
                                <button class="btn-sm" onclick="loadApifyRuns()">Refresh Runs</button>
                            </div>
                        </div>
                        
                        <div id="apify-status" style="margin-bottom: 20px; padding: 12px 16px; border-radius: 8px; background: var(--stone-100);">
                            <span style="color: var(--stone-500);">Checking Apify connection...</span>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <div style="background: var(--stone-50); border-radius: 12px; padding: 20px;">
                                <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700); display: flex; justify-content: space-between; align-items: center;">
                                    Actors
                                    <span id="apify-actors-count" style="font-size: 12px; color: var(--stone-400);"></span>
                                </h3>
                                <div id="apify-actors-list" style="max-height: 300px; overflow-y: auto;">
                                    <div style="color: var(--stone-400);">Loading actors...</div>
                                </div>
                            </div>
                            <div style="background: var(--stone-50); border-radius: 12px; padding: 20px;">
                                <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700); display: flex; justify-content: space-between; align-items: center;">
                                    Schedules
                                    <span id="apify-schedules-count" style="font-size: 12px; color: var(--stone-400);"></span>
                                </h3>
                                <div id="apify-schedules-list" style="max-height: 300px; overflow-y: auto;">
                                    <div style="color: var(--stone-400);">Loading schedules...</div>
                                </div>
                            </div>
                        </div>

                        <!-- Import Apify Run -->
                        <div style="background: #ecfdf5; border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                            <h3 style="margin-bottom: 12px; font-size: 16px; color: #065f46; font-weight: 600;">Import Apify Run Results</h3>
                            <p style="font-size: 13px; color: #374151; margin-bottom: 16px;">Import places and reviews from a completed Apify Google Maps run into OppGrid.</p>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div>
                                    <label style="font-size: 12px; color: #6b7280; display: block; margin-bottom: 4px;">Apify Run ID</label>
                                    <input type="text" id="apify-import-run-id" placeholder="e.g., rkLYPw2q2Sbt6S8wT" style="padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; box-sizing: border-box;">
                                </div>
                                <button onclick="importApifyRun()" style="background: #10b981; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">Import to OppGrid</button>
                            </div>
                            <div id="apify-import-status" style="margin-top: 12px; display: none;"></div>
                        </div>

                        <div style="background: var(--stone-50); border-radius: 12px; padding: 20px;">
                            <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700); display: flex; justify-content: space-between; align-items: center;">
                                Recent Runs
                                <span id="apify-runs-count" style="font-size: 12px; color: var(--stone-400);"></span>
                            </h3>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Actor</th>
                                        <th>Status</th>
                                        <th>Started</th>
                                        <th>Duration</th>
                                        <th>Items</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="apify-runs-table-body">
                                    <tr><td colspan="6" class="loading">Loading runs...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- SerpAPI Tab -->
                    <div id="cc-tab-serpapi" class="cc-tab-content hidden">
                        <div class="section-header">
                            <h2>SerpAPI - Google Search & Maps Reviews</h2>
                            <div class="section-actions">
                                <button class="btn-sm" onclick="loadSerpAPIStatus()">Refresh Status</button>
                            </div>
                        </div>
                        
                        <div id="serpapi-status" style="padding: 12px; border-radius: 8px; margin-bottom: 20px; background: var(--stone-100);">
                            Checking SerpAPI connection...
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <!-- Google Search -->
                            <div style="background: var(--stone-50); border-radius: 12px; padding: 20px;">
                                <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700);">Google Search</h3>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <input type="text" id="serpapi-search-query" placeholder="Search query..." style="padding: 10px; border: 1px solid var(--stone-300); border-radius: 8px;">
                                    <input type="text" id="serpapi-search-location" placeholder="Location (optional, e.g., Austin, TX)" style="padding: 10px; border: 1px solid var(--stone-300); border-radius: 8px;">
                                    <button class="btn-sm btn-primary" onclick="runSerpAPIGoogleSearch()">Search Google</button>
                                </div>
                            </div>

                            <!-- Google Maps Search -->
                            <div style="background: var(--stone-50); border-radius: 12px; padding: 20px;">
                                <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700);">Google Maps Search</h3>
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <input type="text" id="serpapi-maps-query" placeholder="Business type (e.g., coffee shops)" style="padding: 10px; border: 1px solid var(--stone-300); border-radius: 8px;">
                                    <input type="text" id="serpapi-maps-location" placeholder="Location (e.g., Austin, TX)" style="padding: 10px; border: 1px solid var(--stone-300); border-radius: 8px;">
                                    <button class="btn-sm btn-primary" onclick="runSerpAPIMapsSearch()">Search Maps</button>
                                </div>
                            </div>
                        </div>

                        <!-- Places with Reviews -->
                        <div style="background: var(--stone-50); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700);">Search Places & Get Reviews</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr auto auto auto; gap: 12px; align-items: end;">
                                <div>
                                    <label style="font-size: 12px; color: var(--stone-500);">Business Type</label>
                                    <input type="text" id="serpapi-places-query" placeholder="e.g., restaurants, dentists" style="padding: 10px; border: 1px solid var(--stone-300); border-radius: 8px; width: 100%;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--stone-500);">Location</label>
                                    <input type="text" id="serpapi-places-location" placeholder="e.g., Austin, TX" style="padding: 10px; border: 1px solid var(--stone-300); border-radius: 8px; width: 100%;">
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--stone-500);">Max Places</label>
                                    <select id="serpapi-places-max" style="padding: 10px; border: 1px solid var(--stone-300); border-radius: 8px;">
                                        <option value="3">3</option>
                                        <option value="5" selected>5</option>
                                        <option value="10">10</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: var(--stone-500);">Reviews/Place</label>
                                    <select id="serpapi-places-reviews" style="padding: 10px; border: 1px solid var(--stone-300); border-radius: 8px;">
                                        <option value="5">5</option>
                                        <option value="10" selected>10</option>
                                        <option value="20">20</option>
                                    </select>
                                </div>
                                <button class="btn-sm btn-primary" onclick="runSerpAPIPlacesWithReviews()">Search & Get Reviews</button>
                            </div>
                        </div>

                        <!-- Results Display -->
                        <div style="background: var(--stone-50); border-radius: 12px; padding: 20px;">
                            <h3 style="margin-bottom: 16px; font-size: 16px; color: var(--stone-700); display: flex; justify-content: space-between; align-items: center;">
                                Results
                                <span id="serpapi-results-count" style="font-size: 12px; color: var(--stone-400);"></span>
                            </h3>
                            <div id="serpapi-results" style="max-height: 500px; overflow-y: auto;">
                                <div style="color: var(--stone-400); text-align: center; padding: 40px;">Run a search to see results</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Scrapes -->
                <div class="content-section">
                    <div class="section-header">
                        <h2>Recent Scrapes</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="cc-scrape-source-filter">
                                <option value="">All Sources</option>
                                <option value="reddit">Reddit</option>
                                <option value="google_maps">Google Maps</option>
                                <option value="yelp">Yelp</option>
                                <option value="twitter">Twitter</option>
                                <option value="nextdoor">Nextdoor</option>
                            </select>
                            <select class="filter-select" id="cc-scrape-processed-filter">
                                <option value="">All</option>
                                <option value="true">Processed</option>
                                <option value="false">Pending</option>
                            </select>
                            <button class="btn-sm" onclick="loadCommandCenterScrapes()">Refresh</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>External ID</th>
                                <th>Source</th>
                                <th>Status</th>
                                <th>Received</th>
                                <th>Preview</th>
                            </tr>
                        </thead>
                        <tbody id="cc-scrapes-table-body">
                            <tr><td colspan="6" class="loading">Loading scrapes...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Google Scraping Section -->
            <section id="section-google-scraping" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Google Scraping Framework</h1>
                    <p>Location-based keyword scraping using SerpAPI</p>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid" id="gs-stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Locations</div>
                        <div class="stat-value" id="gs-stat-locations">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Keyword Groups</div>
                        <div class="stat-value" id="gs-stat-keywords">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Jobs</div>
                        <div class="stat-value" id="gs-stat-jobs">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Cached Businesses</div>
                        <div class="stat-value" id="gs-stat-businesses">--</div>
                    </div>
                </div>

                <!-- Dual Column Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                    <!-- Left Column: Locations -->
                    <div class="content-section">
                        <div class="section-header">
                            <h2>Locations</h2>
                            <div class="section-actions">
                                <input type="text" id="gs-location-search" placeholder="Search locations..." class="filter-input" style="width: 150px;">
                                <button class="btn-sm btn-success" onclick="seedLocations()">Seed All</button>
                                <button class="btn-sm" onclick="showAddLocationModal()">+ Add</button>
                            </div>
                        </div>
                        <div id="gs-locations-list" style="max-height: 400px; overflow-y: auto;">
                            <div class="loading">Loading locations...</div>
                        </div>
                    </div>

                    <!-- Right Column: Keywords -->
                    <div class="content-section">
                        <div class="section-header">
                            <h2>Keyword Groups</h2>
                            <div class="section-actions">
                                <input type="text" id="gs-keyword-search" placeholder="Search keywords..." class="filter-input" style="width: 150px;">
                                <button class="btn-sm" onclick="showAddKeywordGroupModal()">+ Add</button>
                            </div>
                        </div>
                        <div id="gs-keywords-list" style="max-height: 400px; overflow-y: auto;">
                            <div class="loading">Loading keyword groups...</div>
                        </div>
                    </div>
                </div>

                <!-- Job Configuration Panel -->
                <div class="content-section" style="margin-top: 24px;">
                    <div class="section-header">
                        <h2>Create Scraping Job</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 16px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 4px;">Location</label>
                            <select id="gs-job-location" class="filter-select" style="width: 100%;" onchange="onCityChange()">
                                <option value="">Select location...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 4px;">Zip Code Coverage</label>
                            <select id="gs-job-zip-mode" class="filter-select" style="width: 100%;" onchange="onZipModeChange()">
                                <option value="all_zips" selected>All Zip Codes</option>
                                <option value="city_only">City Only (no zips)</option>
                                <option value="specific_zips">Specific Zips...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 4px;">Keyword Group</label>
                            <select id="gs-job-keywords" class="filter-select" style="width: 100%;">
                                <option value="">Select keywords...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 4px;">Source Type</label>
                            <select id="gs-job-source" class="filter-select" style="width: 100%;">
                                <option value="google_maps_reviews">Google Maps Reviews</option>
                                <option value="google_search">Google Search</option>
                            </select>
                        </div>
                    </div>
                    <div id="gs-zip-selector" style="display: none; padding: 0 16px 16px;">
                        <label style="display: block; font-weight: 500; margin-bottom: 8px;">Select Zip Codes <span id="gs-zip-count" style="color: #888; font-weight: 400;">(0 available)</span></label>
                        <div id="gs-zip-list" style="display: flex; flex-wrap: wrap; gap: 8px; max-height: 120px; overflow-y: auto; background: #1a1a1a; padding: 12px; border-radius: 8px;">
                            <span style="color: #666;">Select a city first</span>
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 8px;">
                            <button class="btn-sm" onclick="selectAllZips()">Select All</button>
                            <button class="btn-sm" onclick="deselectAllZips()">Deselect All</button>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; padding: 0 16px 16px;">
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 4px;">Depth per Location</label>
                            <select id="gs-job-depth" class="filter-select" style="width: 100%;">
                                <option value="20">20 results</option>
                                <option value="50" selected>50 results</option>
                                <option value="100">100 results</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 500; margin-bottom: 4px;">Job Name</label>
                            <input type="text" id="gs-job-name" placeholder="e.g., 'Austin Parking Issues'" class="filter-input" style="width: 100%;">
                        </div>
                    </div>
                    <div style="padding: 0 16px 16px;">
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="font-size: 11px; color: #888; text-transform: uppercase;">Single Location</span>
                                <button class="btn-primary" onclick="createAndRunJob()">Run Selected</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="font-size: 11px; color: #888; text-transform: uppercase;">With Zip Codes</span>
                                <button class="btn-secondary" onclick="runWithZipCoverage()" style="background: #1a1a1a; border: 1px solid #333;">Run + Zips</button>
                            </div>
                            <div style="border-left: 1px solid #333; height: 40px; margin: 0 8px;"></div>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="font-size: 11px; color: #22c55e; text-transform: uppercase; font-weight: 600;">Batch Run</span>
                                <button class="btn-secondary" onclick="runAllCities()" style="background: #166534; border: 1px solid #22c55e; color: #fff;">Run All Cities</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="font-size: 11px; color: #3b82f6; text-transform: uppercase; font-weight: 600;">All Keywords</span>
                                <button class="btn-secondary" onclick="runAllKeywords()" style="background: #1e3a8a; border: 1px solid #3b82f6; color: #fff;">Run All Keywords</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                <span style="font-size: 11px; color: #dc2626; text-transform: uppercase; font-weight: 600;">Full Sweep</span>
                                <button class="btn-secondary" onclick="runFullSweep()" style="background: #7f1d1d; border: 1px solid #dc2626; color: #fff;">Run All Cities  All Keywords</button>
                            </div>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #666;">
                            Tip: "Full Sweep" runs ALL keyword groups across ALL cities - use with caution as this creates many jobs.
                        </div>
                    </div>
                    <div id="gs-batch-progress" style="display: none; padding: 0 16px 16px;">
                        <div style="background: #1a1a1a; border-radius: 8px; padding: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span id="gs-batch-status">Processing...</span>
                                <span id="gs-batch-count">0/0</span>
                            </div>
                            <div style="background: #333; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div id="gs-batch-bar" style="background: #22c55e; height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <div id="gs-batch-log" style="margin-top: 12px; max-height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; color: #888;"></div>
                        </div>
                    </div>
                </div>

                <!-- Jobs History -->
                <div class="content-section" style="margin-top: 24px;">
                    <div class="section-header">
                        <h2>Recent Jobs</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="gs-job-status-filter">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="running">Running</option>
                                <option value="completed">Completed</option>
                                <option value="failed">Failed</option>
                            </select>
                            <button class="btn-sm" onclick="loadGoogleScrapingJobs()">Refresh</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Location</th>
                                <th>Keywords</th>
                                <th>Status</th>
                                <th>Results</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="gs-jobs-table-body">
                            <tr><td colspan="8" class="loading">Loading jobs...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Results Panel -->
                <div class="content-section" style="margin-top: 24px; display: none;" id="gs-results-panel">
                    <div class="section-header">
                        <h2>Job Results</h2>
                        <div class="section-actions">
                            <button class="btn-sm" onclick="closeResultsPanel()">Close</button>
                            <button class="btn-sm" onclick="exportJobResults()">Export CSV</button>
                        </div>
                    </div>
                    <div id="gs-results-content" style="max-height: 500px; overflow-y: auto; padding: 16px;">
                    </div>
                </div>
            </section>

            <!-- Consultant Studio Analytics Section -->
            <section id="section-consultant-analytics" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Consultant Studio Analytics</h1>
                    <p>User activity insights, trend analysis, and lead identification</p>
                </div>

                <div class="stats-grid" id="consultant-stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Activities</div>
                        <div class="stat-value" id="cs-stat-activities">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unique Users</div>
                        <div class="stat-value" id="cs-stat-users">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ideas Validated</div>
                        <div class="stat-value" id="cs-stat-ideas">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Locations Searched</div>
                        <div class="stat-value" id="cs-stat-locations">--</div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Activity Breakdown</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="cs-days-filter">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 90 days</option>
                            </select>
                            <button class="btn-sm btn-primary" onclick="loadConsultantAnalytics()">Refresh</button>
                        </div>
                    </div>
                    <div id="cs-path-breakdown" style="padding: 20px;">
                        <div class="loading">Loading activity breakdown...</div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                    <div class="content-section">
                        <div class="section-header">
                            <h2>Top Ideas Validated</h2>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Idea</th>
                                        <th>Result</th>
                                        <th>Count</th>
                                    </tr>
                                </thead>
                                <tbody id="cs-top-ideas-body">
                                    <tr><td colspan="3" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="content-section">
                        <div class="section-header">
                            <h2>Top Locations Searched</h2>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>City</th>
                                        <th>Business Type</th>
                                        <th>Count</th>
                                    </tr>
                                </thead>
                                <tbody id="cs-top-locations-body">
                                    <tr><td colspan="3" class="loading">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="content-section" style="margin-top: 24px;">
                    <div class="section-header">
                        <h2>Potential Leads</h2>
                        <p style="color: var(--stone-500); font-size: 13px;">Users with 2+ activities - high engagement signals</p>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Activities</th>
                                <th>Paths Used</th>
                                <th>Last Activity</th>
                            </tr>
                        </thead>
                        <tbody id="cs-leads-body">
                            <tr><td colspan="5" class="loading">Loading potential leads...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="content-section" style="margin-top: 24px;">
                    <div class="section-header">
                        <h2>Recent Activities</h2>
                    </div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Path</th>
                                    <th>Result</th>
                                    <th>Processing Time</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody id="cs-activities-body">
                                <tr><td colspan="5" class="loading">Loading activities...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        const API_BASE_URL = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : '/api/v1';
        let currentUser = null;

        async function init() {
            if (!OppGridAuth.requireAuth({ redirect: 'admin.html' })) return;
            const token = OppGridAuth.getAccessToken();

            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Not authenticated');

                currentUser = await response.json();

                if (!currentUser.is_admin) {
                    showToast('Access denied: Admin privileges required', 'error');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }

                document.getElementById('admin-name').textContent = currentUser.name;

                setupNavigation();
                loadDashboard();
            } catch (error) {
                console.error('Auth error:', error);
                OppGridAuth.redirectToSignin({ redirect: 'admin.html' });
            }
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    document.querySelectorAll('[id^="section-"]').forEach(s => s.classList.add('hidden'));
                    document.getElementById(`section-${section}`).classList.remove('hidden');
                    
                    loadSection(section);
                });
            });

            document.getElementById('user-search').addEventListener('input', debounce(() => loadUsers(), 300));
            document.getElementById('user-filter').addEventListener('change', () => loadUsers());
            document.getElementById('opp-search').addEventListener('input', debounce(() => loadOpportunities(), 300));
            document.getElementById('sub-tier-filter').addEventListener('change', () => loadSubscriptions());
            document.getElementById('report-status-filter').addEventListener('change', () => loadReports());
            document.getElementById('partner-search')?.addEventListener('input', debounce(() => loadPartners(), 300));
            document.getElementById('partner-status-filter')?.addEventListener('change', () => loadPartners());
            document.getElementById('tracking-event-filter')?.addEventListener('change', () => loadTrackingEvents());
            document.getElementById('tracking-days')?.addEventListener('change', () => loadTracking());

            document.getElementById('jobruns-name')?.addEventListener('input', debounce(() => loadJobRuns(), 300));
            document.getElementById('jobruns-status')?.addEventListener('change', () => loadJobRuns());
            document.getElementById('audit-action')?.addEventListener('input', debounce(() => loadAuditLogs(), 300));
            document.getElementById('audit-resource-type')?.addEventListener('input', debounce(() => loadAuditLogs(), 300));
            document.getElementById('audit-resource-id')?.addEventListener('input', debounce(() => loadAuditLogs(), 300));
        }

        function loadSection(section) {
            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'tracking': loadTracking(); break;
                case 'ops': loadOps(); break;
                case 'users': loadUsers(); break;
                case 'opportunities': loadOpportunities(); break;
                case 'subscriptions': loadSubscriptions(); break;
                case 'partners': loadPartners(); break;
                case 'leads': loadLeads(); loadLeadStats(); break;
                case 'reports': loadReports(); break;
                case 'scraper': loadWebhookCalendar(); break;
                case 'command-center': loadCommandCenter(); break;
                case 'google-scraping': loadGoogleScraping(); break;
                case 'consultant-analytics': loadConsultantAnalytics(); break;
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetchWithAuth('/api/v1/admin/stats');
                const stats = await response.json();

                document.getElementById('stat-users').textContent = stats.total_users;
                document.getElementById('stat-verified').textContent = stats.verified_users;
                document.getElementById('stat-opportunities').textContent = stats.total_opportunities;
                document.getElementById('stat-banned').textContent = stats.banned_users;
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function loadTracking() {
            await Promise.all([loadTrackingSummary(), loadTrackingEvents()]);
        }

        async function loadOps() {
            await Promise.all([loadJobRuns(), loadAuditLogs()]);
        }

        function _formatDurationMs(start, end) {
            if (!start || !end) return '';
            const ms = new Date(end).getTime() - new Date(start).getTime();
            if (!Number.isFinite(ms) || ms < 0) return '';
            if (ms < 1000) return `${ms}ms`;
            const s = Math.round(ms / 1000);
            if (s < 60) return `${s}s`;
            const m = Math.floor(s / 60);
            const r = s % 60;
            return `${m}m ${r}s`;
        }

        async function loadJobRuns() {
            const tbody = document.getElementById('jobruns-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading job runs...</td></tr>';

            try {
                let url = '/api/v1/admin/job-runs?limit=50';
                const jobName = document.getElementById('jobruns-name')?.value?.trim();
                const statusFilter = document.getElementById('jobruns-status')?.value;
                if (jobName) url += `&job_name=${encodeURIComponent(jobName)}`;
                if (statusFilter) url += `&status_filter=${encodeURIComponent(statusFilter)}`;

                const response = await fetchWithAuth(url);
                const data = await response.json();
                const items = data.items || [];

                tbody.innerHTML = '';
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">No job runs yet.</td></tr>';
                    return;
                }

                items.forEach(r => {
                    const status = (r.status || 'unknown').toLowerCase();
                    const badgeClass = ['running', 'succeeded', 'failed'].includes(status) ? status : 'pending';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDateTime(r.started_at)}</td>
                        <td><code>${escapeHtml(r.job_name || '')}</code></td>
                        <td><span class="badge badge-${escapeHtml(badgeClass)}">${escapeHtml(status)}</span></td>
                        <td>${escapeHtml(_formatDurationMs(r.started_at, r.finished_at))}</td>
                        <td style="max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(r.error || '')}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Failed to load job runs.</td></tr>';
            }
        }

        async function loadAuditLogs() {
            const tbody = document.getElementById('audit-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading audit logs...</td></tr>';

            try {
                let url = '/api/v1/admin/audit-logs?limit=50';
                const action = document.getElementById('audit-action')?.value?.trim();
                const rt = document.getElementById('audit-resource-type')?.value?.trim();
                const rid = document.getElementById('audit-resource-id')?.value?.trim();
                if (action) url += `&action=${encodeURIComponent(action)}`;
                if (rt) url += `&resource_type=${encodeURIComponent(rt)}`;
                if (rid) url += `&resource_id=${encodeURIComponent(rid)}`;

                const response = await fetchWithAuth(url);
                const data = await response.json();
                const items = data.items || [];

                tbody.innerHTML = '';
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">No audit logs yet.</td></tr>';
                    return;
                }

                items.forEach(a => {
                    const actor = a.actor_user_id ? `#${a.actor_user_id} (${a.actor_type || 'user'})` : (a.actor_type || 'system');
                    const resource = a.resource_type ? `${a.resource_type}${a.resource_id ? `#${a.resource_id}` : ''}` : '';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDateTime(a.created_at)}</td>
                        <td>${escapeHtml(actor)}</td>
                        <td><code>${escapeHtml(a.action || '')}</code></td>
                        <td>${escapeHtml(resource)}</td>
                        <td>${escapeHtml(a.ip_address || '')}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Failed to load audit logs.</td></tr>';
            }
        }

        async function loadTrackingSummary() {
            try {
                const days = document.getElementById('tracking-days')?.value || '7';
                const response = await fetchWithAuth(`/api/v1/admin/tracking/summary?days=${encodeURIComponent(days)}`);
                const data = await response.json();

                document.getElementById('tracking-total').textContent = data.total_events ?? '--';
                document.getElementById('tracking-pageviews').textContent = data.page_views ?? '--';
                document.getElementById('tracking-top-event').textContent = (data.top_events && data.top_events[0]) ? data.top_events[0].name : '--';
                document.getElementById('tracking-top-path').textContent = (data.top_paths && data.top_paths[0]) ? data.top_paths[0].path : '--';
            } catch (e) {
                console.error('Failed to load tracking summary', e);
            }
        }

        async function loadTrackingEvents() {
            const tbody = document.getElementById('tracking-events-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="4" class="loading">Loading events...</td></tr>';

            try {
                const name = document.getElementById('tracking-event-filter')?.value || '';
                const url = name
                    ? `/api/v1/admin/tracking/events?limit=50&name=${encodeURIComponent(name)}`
                    : '/api/v1/admin/tracking/events?limit=50';
                const response = await fetchWithAuth(url);
                const data = await response.json();
                const items = data.items || [];

                tbody.innerHTML = '';
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">No events yet.</td></tr>';
                    return;
                }
                items.forEach(ev => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(ev.created_at)}</td>
                        <td><code>${escapeHtml(ev.name || '')}</code></td>
                        <td>${escapeHtml(ev.path || '')}</td>
                        <td>${ev.user_id ? `#${ev.user_id}` : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">Failed to load events.</td></tr>';
            }
        }

        async function loadUsers() {
            const search = document.getElementById('user-search').value;
            const filter = document.getElementById('user-filter').value;
            const tbody = document.getElementById('users-table-body');
            
            try {
                let url = '/api/v1/admin/users?limit=50';
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (filter === 'admin') url += '&is_admin=true';
                if (filter === 'banned') url += '&is_banned=true';
                if (filter === 'verified') url += '&is_verified=true';

                const response = await fetchWithAuth(url);
                const users = await response.json();

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
                                <div class="user-info">
                                    <span class="user-name">${escapeHtml(user.name)}</span>
                                    <span class="user-email">${escapeHtml(user.email)}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${user.is_verified ? '<span class="badge badge-verified">Verified</span>' : ''}
                            ${user.is_banned ? '<span class="badge badge-banned">Banned</span>' : ''}
                        </td>
                        <td>
                            ${user.is_admin ? '<span class="badge badge-admin">Admin</span>' : '<span class="badge badge-free">User</span>'}
                        </td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                ${!user.is_admin ? `
                                    <button class="btn-sm btn-primary" onclick="promoteUser(${user.id})">Make Admin</button>
                                ` : user.id !== currentUser.id ? `
                                    <button class="btn-sm btn-secondary" onclick="demoteUser(${user.id})">Remove Admin</button>
                                ` : ''}
                                ${!user.is_banned && user.id !== currentUser.id ? `
                                    <button class="btn-sm btn-danger" onclick="showBanModal(${user.id}, '${escapeHtml(user.name)}')">Ban</button>
                                ` : user.is_banned ? `
                                    <button class="btn-sm btn-success" onclick="unbanUser(${user.id})">Unban</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load users:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load users</td></tr>';
            }
        }

        async function loadOpportunities() {
            const search = document.getElementById('opp-search').value;
            const tbody = document.getElementById('opportunities-table-body');
            
            try {
                let url = '/api/v1/admin/opportunities?limit=50';
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await fetchWithAuth(url);
                const opportunities = await response.json();

                if (opportunities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No opportunities found</td></tr>';
                    return;
                }

                tbody.innerHTML = opportunities.map(opp => `
                    <tr>
                        <td>
                            <a href="opportunity.html?id=${opp.id}" style="color: var(--violet-600); text-decoration: none;">
                                ${escapeHtml(opp.title.substring(0, 50))}${opp.title.length > 50 ? '...' : ''}
                            </a>
                        </td>
                        <td>${escapeHtml(opp.author_name)}</td>
                        <td><span class="badge badge-${opp.status === 'published' ? 'active' : 'pending'}">${opp.status}</span></td>
                        <td>${opp.validation_count}</td>
                        <td>${formatDate(opp.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-sm btn-danger" onclick="deleteOpportunity(${opp.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load opportunities:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Failed to load opportunities</td></tr>';
            }
        }

        async function loadSubscriptions() {
            const tierFilter = document.getElementById('sub-tier-filter').value;
            const tbody = document.getElementById('subscriptions-table-body');
            
            try {
                let url = '/api/v1/admin/subscriptions?limit=50';
                if (tierFilter) url += `&tier_filter=${tierFilter}`;

                const response = await fetchWithAuth(url);
                const subscriptions = await response.json();

                if (subscriptions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No subscriptions found</td></tr>';
                    return;
                }

                tbody.innerHTML = subscriptions.map(sub => `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${sub.user_name.charAt(0).toUpperCase()}</div>
                                <div class="user-info">
                                    <span class="user-name">${escapeHtml(sub.user_name)}</span>
                                    <span class="user-email">${escapeHtml(sub.user_email)}</span>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge badge-${sub.tier}">${sub.tier.toUpperCase()}</span></td>
                        <td><span class="badge badge-${sub.status}">${sub.status}</span></td>
                        <td>${sub.current_period_end ? formatDate(sub.current_period_end) : 'N/A'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-sm btn-secondary" onclick="showTierModal(${sub.id}, ${sub.user_id}, '${sub.tier}')">Change Tier</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load subscriptions:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load subscriptions</td></tr>';
            }
        }

        async function loadReports() {
            const status = document.getElementById('report-status-filter').value;
            const tbody = document.getElementById('reports-table-body');
            
            try {
                const response = await fetchWithAuth(`/api/v1/moderation/reports?status_filter=${status}&limit=50`);
                const reports = await response.json();

                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No reports found</td></tr>';
                    return;
                }

                tbody.innerHTML = reports.map(report => `
                    <tr>
                        <td>${report.content_type} #${report.content_id}</td>
                        <td>${report.reason}</td>
                        <td>User #${report.reporter_id}</td>
                        <td><span class="badge badge-${report.status}">${report.status}</span></td>
                        <td>${formatDate(report.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                ${report.status === 'pending' || report.status === 'reviewing' ? `
                                    <button class="btn-sm btn-primary" onclick="resolveReport(${report.id})">Resolve</button>
                                    <button class="btn-sm btn-secondary" onclick="dismissReport(${report.id})">Dismiss</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load reports:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Failed to load reports</td></tr>';
            }
        }

        async function promoteUser(userId) {
            if (!confirm('Are you sure you want to make this user an admin?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/promote`, { method: 'POST' });
                showToast('User promoted to admin', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to promote user', 'error');
            }
        }

        async function demoteUser(userId) {
            if (!confirm('Are you sure you want to remove admin privileges?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/demote`, { method: 'POST' });
                showToast('Admin privileges removed', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to demote user', 'error');
            }
        }

        function showBanModal(userId, userName) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Ban User: ${escapeHtml(userName)}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="ban-reason">Reason for ban</label>
                            <textarea id="ban-reason" rows="3" placeholder="Enter the reason for banning this user..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-danger" onclick="banUser(${userId})">Ban User</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        async function banUser(userId) {
            const reason = document.getElementById('ban-reason').value;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/ban`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ban_reason: reason })
                });
                closeModal();
                showToast('User banned successfully', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to ban user', 'error');
            }
        }

        async function unbanUser(userId) {
            if (!confirm('Are you sure you want to unban this user?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/unban`, { method: 'POST' });
                showToast('User unbanned successfully', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to unban user', 'error');
            }
        }

        async function deleteOpportunity(id) {
            if (!confirm('Are you sure you want to delete this opportunity? This cannot be undone.')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/opportunities/${id}`, { method: 'DELETE' });
                showToast('Opportunity deleted', 'success');
                loadOpportunities();
            } catch (error) {
                showToast('Failed to delete opportunity', 'error');
            }
        }

        function showTierModal(subscriptionId, userId, currentTier) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Change Subscription Tier</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-tier">New Tier</label>
                            <select id="new-tier">
                                <option value="free" ${currentTier === 'free' ? 'selected' : ''}>Free</option>
                                <option value="pro" ${currentTier === 'pro' ? 'selected' : ''}>Pro</option>
                                <option value="business" ${currentTier === 'business' ? 'selected' : ''}>Business</option>
                                <option value="enterprise" ${currentTier === 'enterprise' ? 'selected' : ''}>Enterprise</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-primary" onclick="updateTier(${subscriptionId}, ${userId})">Update Tier</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        async function updateTier(subscriptionId, userId) {
            const newTier = document.getElementById('new-tier').value;
            
            try {
                if (subscriptionId) {
                    await fetchWithAuth(`/api/v1/admin/subscriptions/${subscriptionId}/tier?tier=${newTier}`, { method: 'PATCH' });
                } else {
                    await fetchWithAuth(`/api/v1/admin/users/${userId}/grant-subscription?tier=${newTier}`, { method: 'POST' });
                }
                closeModal();
                showToast('Subscription updated', 'success');
                loadSubscriptions();
            } catch (error) {
                showToast('Failed to update subscription', 'error');
            }
        }

        async function loadPartners() {
            const tbody = document.getElementById('partners-table-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading partners...</td></tr>';

            try {
                window._partnersById = window._partnersById || {};
                let url = '/api/v1/admin/partners?limit=50';
                const search = document.getElementById('partner-search')?.value?.trim();
                const statusFilter = document.getElementById('partner-status-filter')?.value;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (statusFilter) url += `&status_filter=${encodeURIComponent(statusFilter)}`;

                const response = await fetchWithAuth(url);
                const partners = await response.json();
                tbody.innerHTML = '';
                window._partnersById = {};
                (partners || []).forEach(p => { if (p && p.id != null) window._partnersById[p.id] = p; });

                if (!partners || partners.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">No partners yet.</td></tr>';
                    return;
                }

                partners.forEach(p => {
                    const contact = [p.contact_name, p.contact_email].filter(Boolean).join('  ') || '';
                    const website = p.website_url ? `<a href="${escapeHtml(p.website_url)}" target="_blank" rel="noopener noreferrer" style="color:#2563eb;text-decoration:none;">Website</a>` : '';
                    const nameCell = `${escapeHtml(p.name)} ${website ? `<div style="font-size:12px;color:#78716c;margin-top:4px;">${website}</div>` : ''}`;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${nameCell}</td>
                        <td>${escapeHtml(p.category || '')}</td>
                        <td><span class="badge badge-${escapeHtml(p.status || 'identified')}">${escapeHtml(p.status || 'identified')}</span></td>
                        <td>${escapeHtml(contact)}</td>
                        <td>${formatDate(p.created_at)}</td>
                        <td>
                            <button class="btn-sm btn-secondary" onclick="showPartnerEditModal(${p.id})">Edit</button>
                            <button class="btn-sm btn-danger" onclick="deletePartner(${p.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Failed to load partners.</td></tr>';
            }
        }

        function showPartnerEditModal(id) {
            const p = (window._partnersById || {})[id];
            if (!p) {
                showToast('Partner not found in list. Refreshing...', 'error');
                loadPartners();
                return;
            }
            showPartnerModal(
                p.id,
                p.name || '',
                p.category || '',
                p.website_url || '',
                p.contact_name || '',
                p.contact_email || '',
                p.status || 'identified',
                p.notes || ''
            );
        }

        function showPartnerModal(id = null, name = '', category = '', website_url = '', contact_name = '', contact_email = '', status = 'identified', notes = '') {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${id ? 'Edit Partner' : 'Add Partner'}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="partner-name">Name</label>
                            <input id="partner-name" value="${escapeAttr(name)}" />
                        </div>
                        <div class="form-group">
                            <label for="partner-category">Category</label>
                            <input id="partner-category" value="${escapeAttr(category)}" placeholder="e.g. payments, analytics, CRM" />
                        </div>
                        <div class="form-group">
                            <label for="partner-website">Website URL</label>
                            <input id="partner-website" value="${escapeAttr(website_url)}" placeholder="https://..." />
                        </div>
                        <div class="form-group">
                            <label for="partner-contact-name">Contact name</label>
                            <input id="partner-contact-name" value="${escapeAttr(contact_name)}" />
                        </div>
                        <div class="form-group">
                            <label for="partner-contact-email">Contact email</label>
                            <input id="partner-contact-email" value="${escapeAttr(contact_email)}" />
                        </div>
                        <div class="form-group">
                            <label for="partner-status">Status</label>
                            <select id="partner-status">
                                <option value="identified" ${status === 'identified' ? 'selected' : ''}>Identified</option>
                                <option value="contacted" ${status === 'contacted' ? 'selected' : ''}>Contacted</option>
                                <option value="in_talks" ${status === 'in_talks' ? 'selected' : ''}>In talks</option>
                                <option value="active" ${status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="paused" ${status === 'paused' ? 'selected' : ''}>Paused</option>
                                <option value="rejected" ${status === 'rejected' ? 'selected' : ''}>Rejected</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="partner-notes">Notes</label>
                            <textarea id="partner-notes" rows="4" placeholder="Outreach notes, dates, next step...">${escapeHtml(notes)}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-primary" onclick="savePartner(${id || 'null'})">${id ? 'Save changes' : 'Add partner'}</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        async function savePartner(id) {
            const payload = {
                name: document.getElementById('partner-name').value.trim(),
                category: document.getElementById('partner-category').value.trim() || null,
                website_url: document.getElementById('partner-website').value.trim() || null,
                contact_name: document.getElementById('partner-contact-name').value.trim() || null,
                contact_email: document.getElementById('partner-contact-email').value.trim() || null,
                status: document.getElementById('partner-status').value,
                notes: document.getElementById('partner-notes').value.trim() || null,
            };

            if (!payload.name) {
                showToast('Partner name is required', 'error');
                return;
            }

            try {
                if (id) {
                    await fetchWithAuth(`/api/v1/admin/partners/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showToast('Partner updated', 'success');
                } else {
                    await fetchWithAuth('/api/v1/admin/partners', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showToast('Partner added', 'success');
                }
                closeModal();
                loadPartners();
            } catch (error) {
                showToast('Failed to save partner', 'error');
            }
        }

        async function deletePartner(id) {
            if (!confirm('Delete this partner entry?')) return;
            try {
                await fetchWithAuth(`/api/v1/admin/partners/${id}`, { method: 'DELETE' });
                showToast('Partner deleted', 'success');
                loadPartners();
            } catch (error) {
                showToast('Failed to delete partner', 'error');
            }
        }

        async function loadLeadStats() {
            try {
                const response = await fetchWithAuth('/api/v1/admin/leads/stats');
                const stats = await response.json();
                document.getElementById('leads-total').textContent = stats.total;
                document.getElementById('leads-new').textContent = stats.new;
                document.getElementById('leads-qualified').textContent = stats.qualified;
                document.getElementById('leads-conversion').textContent = stats.conversion_rate + '%';
            } catch (error) {
                console.error('Failed to load lead stats:', error);
            }
        }

        async function loadLeads() {
            const search = document.getElementById('lead-search').value;
            const statusFilter = document.getElementById('lead-status-filter').value;
            const tbody = document.getElementById('leads-table-body');
            
            try {
                let url = '/api/v1/admin/leads/?limit=50';
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (statusFilter) url += `&status_filter=${statusFilter}`;

                const response = await fetchWithAuth(url);
                const data = await response.json();
                const leads = data.items || [];

                if (leads.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No leads found</td></tr>';
                    return;
                }

                tbody.innerHTML = leads.map(lead => `
                    <tr>
                        <td>${escapeHtml(lead.email)}</td>
                        <td>${escapeHtml(lead.name || '-')}</td>
                        <td>${escapeHtml(lead.company || '-')}</td>
                        <td><span class="badge badge-${lead.status}">${lead.status}</span></td>
                        <td>${lead.source}</td>
                        <td>Step ${lead.email_sequence_step}/3</td>
                        <td>${formatDate(lead.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-sm btn-secondary" onclick="showLeadModal(${lead.id})">Edit</button>
                                <button class="btn-sm btn-primary" onclick="sendNurtureEmail(${lead.id})" ${lead.email_sequence_step >= 3 || !lead.email_opt_in ? 'disabled' : ''}>Nurture</button>
                                <button class="btn-sm btn-danger" onclick="deleteLead(${lead.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load leads:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Failed to load leads</td></tr>';
            }
        }

        function showLeadModal(id = null, data = null) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            
            const email = data?.email || '';
            const name = data?.name || '';
            const company = data?.company || '';
            const phone = data?.phone || '';
            const source = data?.source || 'organic';
            const status = data?.status || 'new';
            const interest = data?.interest_category || '';
            const notes = data?.notes || '';
            const emailOptIn = data?.email_opt_in !== false;

            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${id ? 'Edit Lead' : 'Add Lead'}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="lead-email">Email *</label>
                            <input id="lead-email" value="${escapeAttr(email)}" type="email" required />
                        </div>
                        <div class="form-group">
                            <label for="lead-name">Name</label>
                            <input id="lead-name" value="${escapeAttr(name)}" />
                        </div>
                        <div class="form-group">
                            <label for="lead-company">Company</label>
                            <input id="lead-company" value="${escapeAttr(company)}" />
                        </div>
                        <div class="form-group">
                            <label for="lead-phone">Phone</label>
                            <input id="lead-phone" value="${escapeAttr(phone)}" />
                        </div>
                        <div class="form-group">
                            <label for="lead-source">Source</label>
                            <select id="lead-source">
                                <option value="organic" ${source === 'organic' ? 'selected' : ''}>Organic</option>
                                <option value="referral" ${source === 'referral' ? 'selected' : ''}>Referral</option>
                                <option value="paid_ads" ${source === 'paid_ads' ? 'selected' : ''}>Paid Ads</option>
                                <option value="social" ${source === 'social' ? 'selected' : ''}>Social</option>
                                <option value="partner" ${source === 'partner' ? 'selected' : ''}>Partner</option>
                                <option value="direct" ${source === 'direct' ? 'selected' : ''}>Direct</option>
                                <option value="other" ${source === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        ${id ? `
                        <div class="form-group">
                            <label for="lead-status">Status</label>
                            <select id="lead-status">
                                <option value="new" ${status === 'new' ? 'selected' : ''}>New</option>
                                <option value="contacted" ${status === 'contacted' ? 'selected' : ''}>Contacted</option>
                                <option value="qualified" ${status === 'qualified' ? 'selected' : ''}>Qualified</option>
                                <option value="nurturing" ${status === 'nurturing' ? 'selected' : ''}>Nurturing</option>
                                <option value="converted" ${status === 'converted' ? 'selected' : ''}>Converted</option>
                                <option value="lost" ${status === 'lost' ? 'selected' : ''}>Lost</option>
                            </select>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label for="lead-interest">Interest Category</label>
                            <input id="lead-interest" value="${escapeAttr(interest)}" placeholder="e.g., SaaS, FinTech, HealthTech" />
                        </div>
                        <div class="form-group">
                            <label for="lead-notes">Notes</label>
                            <textarea id="lead-notes" rows="3" placeholder="Additional notes...">${escapeHtml(notes)}</textarea>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="lead-email-opt-in" ${emailOptIn ? 'checked' : ''} />
                            <label for="lead-email-opt-in" style="margin: 0;">Email opt-in (receives nurture emails)</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-primary" onclick="saveLead(${id || 'null'})">${id ? 'Save changes' : 'Add lead'}</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);

            if (id && !data) {
                fetchWithAuth(`/api/v1/admin/leads/${id}`).then(r => r.json()).then(leadData => {
                    document.getElementById('lead-email').value = leadData.email || '';
                    document.getElementById('lead-name').value = leadData.name || '';
                    document.getElementById('lead-company').value = leadData.company || '';
                    document.getElementById('lead-phone').value = leadData.phone || '';
                    document.getElementById('lead-source').value = leadData.source || 'organic';
                    document.getElementById('lead-status').value = leadData.status || 'new';
                    document.getElementById('lead-interest').value = leadData.interest_category || '';
                    document.getElementById('lead-notes').value = leadData.notes || '';
                    document.getElementById('lead-email-opt-in').checked = leadData.email_opt_in !== false;
                });
            }
        }

        async function saveLead(id) {
            const payload = {
                email: document.getElementById('lead-email').value.trim(),
                name: document.getElementById('lead-name').value.trim() || null,
                company: document.getElementById('lead-company').value.trim() || null,
                phone: document.getElementById('lead-phone').value.trim() || null,
                source: document.getElementById('lead-source').value,
                interest_category: document.getElementById('lead-interest').value.trim() || null,
                notes: document.getElementById('lead-notes').value.trim() || null,
                email_opt_in: document.getElementById('lead-email-opt-in').checked,
            };

            if (id) {
                payload.status = document.getElementById('lead-status').value;
            }

            if (!payload.email) {
                showToast('Email is required', 'error');
                return;
            }

            try {
                if (id) {
                    await fetchWithAuth(`/api/v1/admin/leads/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showToast('Lead updated', 'success');
                } else {
                    await fetchWithAuth('/api/v1/admin/leads/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showToast('Lead added', 'success');
                }
                closeModal();
                loadLeads();
                loadLeadStats();
            } catch (error) {
                showToast('Failed to save lead', 'error');
            }
        }

        async function deleteLead(id) {
            if (!confirm('Delete this lead?')) return;
            try {
                await fetchWithAuth(`/api/v1/admin/leads/${id}`, { method: 'DELETE' });
                showToast('Lead deleted', 'success');
                loadLeads();
                loadLeadStats();
            } catch (error) {
                showToast('Failed to delete lead', 'error');
            }
        }

        async function sendNurtureEmail(id) {
            try {
                const response = await fetchWithAuth(`/api/v1/admin/leads/${id}/send-nurture-email`, { method: 'POST' });
                const result = await response.json();
                showToast(result.message || 'Nurture email sent', 'success');
                loadLeads();
            } catch (error) {
                showToast('Failed to send nurture email', 'error');
            }
        }

        async function bulkNurtureLeads() {
            if (!confirm('Send nurture emails to all eligible leads (status=nurturing, opted in, not at step 3)?')) return;
            try {
                const response = await fetchWithAuth('/api/v1/admin/leads/bulk-nurture', { method: 'POST' });
                const result = await response.json();
                showToast(`${result.sent_count} nurture emails sent`, 'success');
                loadLeads();
                loadLeadStats();
            } catch (error) {
                showToast('Failed to send bulk nurture emails', 'error');
            }
        }

        async function resolveReport(reportId) {
            try {
                await fetchWithAuth(`/api/v1/moderation/reports/${reportId}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action_taken: 'Content reviewed and action taken', moderator_notes: '' })
                });
                showToast('Report resolved', 'success');
                loadReports();
            } catch (error) {
                showToast('Failed to resolve report', 'error');
            }
        }

        async function dismissReport(reportId) {
            try {
                await fetchWithAuth(`/api/v1/moderation/reports/${reportId}/dismiss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ moderator_notes: 'Report dismissed' })
                });
                showToast('Report dismissed', 'success');
                loadReports();
            } catch (error) {
                showToast('Failed to dismiss report', 'error');
            }
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        async function fetchWithAuth(url, options = {}, throwOnError = true) {
            const token = OppGridAuth.getAccessToken();
            const response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok && throwOnError) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            return response;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttr(text) {
            return escapeHtml(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }


        const SOURCE_COLORS = {
            twitter: { bg: 'rgba(59, 130, 246, 0.2)', border: '#3b82f6', text: '#60a5fa' },
            reddit: { bg: 'rgba(249, 115, 22, 0.2)', border: '#f97316', text: '#fb923c' },
            google_maps: { bg: 'rgba(34, 197, 94, 0.2)', border: '#22c55e', text: '#4ade80' },
            yelp: { bg: 'rgba(239, 68, 68, 0.2)', border: '#ef4444', text: '#f87171' },
            craigslist: { bg: 'rgba(168, 85, 247, 0.2)', border: '#a855f7', text: '#c084fc' },
            custom: { bg: 'rgba(156, 163, 175, 0.2)', border: '#9ca3af', text: '#d1d5db' },
            nextdoor: { bg: 'rgba(16, 185, 129, 0.2)', border: '#10b981', text: '#34d399' },
            linkedin: { bg: 'rgba(59, 130, 246, 0.2)', border: '#0077b5', text: '#0ea5e9' },
            angel_list: { bg: 'rgba(0, 0, 0, 0.2)', border: '#333', text: '#a1a1aa' },
            crunchbase: { bg: 'rgba(39, 95, 255, 0.2)', border: '#275fff', text: '#60a5fa' },
            facebook: { bg: 'rgba(24, 119, 242, 0.2)', border: '#1877f2', text: '#3b82f6' },
            instagram: { bg: 'rgba(225, 48, 108, 0.2)', border: '#e1306c', text: '#f472b6' },
            youtube: { bg: 'rgba(255, 0, 0, 0.2)', border: '#ff0000', text: '#f87171' },
            tiktok: { bg: 'rgba(0, 0, 0, 0.2)', border: '#000', text: '#a1a1aa' },
            glassdoor: { bg: 'rgba(12, 170, 65, 0.2)', border: '#0caa41', text: '#4ade80' },
            indeed: { bg: 'rgba(0, 63, 153, 0.2)', border: '#003f99', text: '#60a5fa' },
            apify: { bg: 'rgba(0, 148, 133, 0.2)', border: '#009485', text: '#2dd4bf' },
        };

        function getSourceColor(source) {
            return SOURCE_COLORS[source] || SOURCE_COLORS.custom;
        }

        async function loadWebhookCalendar() {
            const container = document.getElementById('webhook-calendar-container');
            
            try {
                const response = await fetch('/api/v1/webhooks/calendar?days=30');
                if (!response.ok) throw new Error('Failed to fetch calendar data');
                const data = await response.json();
                
                const days = [];
                const today = new Date();
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    days.push({
                        date: dateStr,
                        dayOfWeek: date.getDay(),
                        dayOfMonth: date.getDate(),
                        month: date.toLocaleDateString('en-US', { month: 'short' }),
                        isToday: i === 0,
                    });
                }

                let sourceBadgesHtml = data.sources.map(source => {
                    const colors = getSourceColor(source);
                    const count = data.source_totals[source] || 0;
                    return `<div style="padding: 6px 12px; border-radius: 20px; background: ${colors.bg}; border: 1px solid ${colors.border}; color: ${colors.text}; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                        <span style="text-transform: capitalize;">${source.replace('_', ' ')}</span>
                        <span style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 11px;">${count.toLocaleString()}</span>
                    </div>`;
                }).join('');

                let calendarHtml = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #fff; margin: 0;">Last 30 Days</h3>
                            <p style="color: var(--stone-400); font-size: 13px; margin-top: 4px;">Data imports by source</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 28px; font-weight: 700; color: #fff;">${data.total_items.toLocaleString()}</div>
                            <div style="font-size: 12px; color: var(--stone-400);">Total Items</div>
                        </div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">${sourceBadgesHtml}</div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div style="text-align: center; font-size: 11px; color: var(--stone-500); padding: 4px;">${d}</div>`).join('')}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                `;

                if (days[0].dayOfWeek > 0) {
                    for (let i = 0; i < days[0].dayOfWeek; i++) {
                        calendarHtml += `<div style="height: 80px;"></div>`;
                    }
                }

                days.forEach(day => {
                    const dayData = data.calendar[day.date] || {};
                    const hasData = Object.keys(dayData).length > 0;
                    const totalCount = Object.values(dayData).reduce((sum, count) => sum + count, 0);
                    
                    let barsHtml = Object.entries(dayData).slice(0, 4).map(([source, count]) => {
                        const colors = getSourceColor(source);
                        return `<div style="width: 100%; height: 4px; border-radius: 2px; background: ${colors.bg}; border: 1px solid ${colors.border};" title="${source}: ${count}"></div>`;
                    }).join('');

                    calendarHtml += `
                        <div style="height: 80px; padding: 6px; border-radius: 8px; border: 1px solid ${day.isToday ? '#3b82f6' : 'var(--stone-700)'}; background: ${hasData ? 'rgba(255,255,255,0.03)' : 'transparent'}; ${day.isToday ? 'background: rgba(59,130,246,0.1);' : ''} cursor: pointer;" onclick="showDayDetails('${day.date}', ${JSON.stringify(dayData).replace(/"/g, '&quot;')})">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <span style="font-size: 11px; font-weight: 500; color: ${day.isToday ? '#60a5fa' : 'var(--stone-400)'};">
                                    ${day.dayOfMonth === 1 ? day.month + ' ' + day.dayOfMonth : day.dayOfMonth}
                                </span>
                                ${totalCount > 0 ? `<span style="font-size: 11px; font-weight: 700; color: #fff; background: var(--stone-700); padding: 2px 6px; border-radius: 4px;">${totalCount}</span>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 2px; margin-top: 6px;">${barsHtml}</div>
                        </div>
                    `;
                });

                calendarHtml += '</div><div id="day-details-container"></div>';
                container.innerHTML = calendarHtml;
                
            } catch (error) {
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: #ef4444;">Error: ${error.message}</div>`;
            }
        }

        function showDayDetails(dateStr, dayData) {
            const container = document.getElementById('day-details-container');
            if (!dayData || Object.keys(dayData).length === 0) {
                container.innerHTML = '';
                return;
            }

            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            let cardsHtml = Object.entries(dayData).map(([source, count]) => {
                const colors = getSourceColor(source);
                return `<div style="padding: 16px; border-radius: 8px; background: ${colors.bg}; border: 1px solid ${colors.border};">
                    <p style="font-size: 13px; text-transform: capitalize; color: ${colors.text}; margin: 0;">${source.replace('_', ' ')}</p>
                    <p style="font-size: 28px; font-weight: 700; color: #fff; margin: 8px 0 4px;">${count.toLocaleString()}</p>
                    <p style="font-size: 11px; color: var(--stone-400); margin: 0;">items imported</p>
                </div>`;
            }).join('');

            container.innerHTML = `
                <div style="margin-top: 16px; padding: 16px; background: var(--stone-800); border-radius: 8px; border: 1px solid var(--stone-700);">
                    <h3 style="color: #fff; margin: 0 0 12px;">${formattedDate}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">${cardsHtml}</div>
                </div>
            `;
        }

        async function analyzeScraperData() {
            const fileInput = document.getElementById('scraper-file');
            const autoImport = document.getElementById('auto-import-checkbox').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showToast('Please select a JSON file', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showToast('Analyzing scraper data...', 'info');
                
                const url = `/api/v1/scraper/analyze?auto_import=${autoImport}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Analysis failed');
                }
                
                const result = await response.json();
                
                document.getElementById('scraper-stats').style.display = 'block';
                document.getElementById('scraper-total').textContent = result.total_posts;
                document.getElementById('scraper-valid').textContent = result.valid_opportunities;
                document.getElementById('scraper-imported').textContent = result.imported;
                document.getElementById('scraper-skipped').textContent = result.skipped;
                
                if (result.opportunities && result.opportunities.length > 0) {
                    document.getElementById('scraper-results').style.display = 'block';
                    const tbody = document.getElementById('scraper-table-body');
                    tbody.innerHTML = result.opportunities.map(opp => `
                        <tr>
                            <td><span class="badge ${opp.confidence_score >= 0.9 ? 'badge-pro' : opp.confidence_score >= 0.8 ? 'badge-plus' : 'badge-free'}">${opp.confidence_score.toFixed(2)}</span></td>
                            <td>${escapeHtml(opp.title.substring(0, 80))}${opp.title.length > 80 ? '...' : ''}</td>
                            <td>${escapeHtml(opp.category)}</td>
                            <td>r/${escapeHtml(opp.subreddit || 'unknown')}</td>
                            <td>${opp.upvotes}</td>
                        </tr>
                    `).join('');
                }
                
                if (autoImport && result.imported > 0) {
                    showToast(`Imported ${result.imported} opportunities!`, 'success');
                } else {
                    showToast(`Found ${result.valid_opportunities} valid opportunities`, 'success');
                }
                
            } catch (error) {
                console.error('Scraper analysis error:', error);
                showToast(error.message || 'Failed to analyze data', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('token');
            window.location.href = 'signin.html';
        }

        // ===== COMMAND CENTER FUNCTIONS =====
        
        function setupCommandCenterTabs() {
            const tabBtns = document.querySelectorAll('.cc-tab-btn');
            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    tabBtns.forEach(b => b.classList.remove('active', 'btn-primary'));
                    btn.classList.add('active', 'btn-primary');
                    
                    document.querySelectorAll('.cc-tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(`cc-tab-${btn.dataset.ccTab}`).classList.remove('hidden');
                    
                    // Load data for the selected tab
                    const tab = btn.dataset.ccTab;
                    switch(tab) {
                        case 'sources': loadCommandCenterSources(); break;
                        case 'patterns': loadCommandCenterPatterns(); break;
                        case 'jobs': loadCommandCenterJobs(); break;
                        case 'pipeline': 
                            loadCommandCenterPipeline(); 
                            loadCommandCenterScrapes();
                            break;
                        case 'apify':
                            loadApifyStatus();
                            loadApifyActors();
                            loadApifySchedules();
                            loadApifyRuns();
                            break;
                        case 'serpapi':
                            loadSerpAPIStatus();
                            break;
                    }
                });
            });
        }

        async function loadCommandCenter() {
            setupCommandCenterTabs();
            setupCommandCenterFilters();
            await loadCommandCenterDashboard();
            await loadCommandCenterSources();
            await loadCommandCenterScrapes();
        }
        
        function setupCommandCenterFilters() {
            document.getElementById('cc-pattern-category-filter')?.addEventListener('change', () => loadCommandCenterPatterns());
            document.getElementById('cc-job-status-filter')?.addEventListener('change', () => loadCommandCenterJobs());
            document.getElementById('cc-scrape-source-filter')?.addEventListener('change', () => loadCommandCenterScrapes());
            document.getElementById('cc-scrape-processed-filter')?.addEventListener('change', () => loadCommandCenterScrapes());
        }

        async function loadCommandCenterDashboard() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/dashboard`);
                if (!response.ok) throw new Error('Failed to load dashboard');
                const data = await response.json();
                
                document.getElementById('cc-active-sources').textContent = data.sources?.active || 0;
                document.getElementById('cc-scraped-24h').textContent = data.scraping?.last_24h || 0;
                document.getElementById('cc-opps-24h').textContent = data.opportunities?.last_24h || 0;
                document.getElementById('cc-pending').textContent = data.scraping?.pending || 0;
            } catch (error) {
                console.error('Error loading CC dashboard:', error);
            }
        }

        async function loadCommandCenterSources() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/sources`);
                if (!response.ok) throw new Error('Failed to load sources');
                const data = await response.json();
                
                const tbody = document.getElementById('cc-sources-table-body');
                if (!data.sources || data.sources.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--stone-400);">No data sources configured. Click "Seed Defaults" to add default sources.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.sources.map(source => `
                    <tr>
                        <td><strong>${source.name}</strong></td>
                        <td><span class="badge">${source.source_type}</span></td>
                        <td>${getStatusBadge(source.status, source.is_active)}</td>
                        <td>${source.base_weight}</td>
                        <td>${source.total_scrapes || 0}</td>
                        <td>${source.valid_opportunities || 0}</td>
                        <td>${source.last_scraped_at ? formatDate(source.last_scraped_at) : 'Never'}</td>
                        <td>
                            <button class="btn-sm" onclick="toggleSource(${source.id})">${source.is_active ? 'Disable' : 'Enable'}</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading sources:', error);
                document.getElementById('cc-sources-table-body').innerHTML = '<tr><td colspan="8" class="error">Error loading sources</td></tr>';
            }
        }

        async function loadCommandCenterPatterns() {
            try {
                const category = document.getElementById('cc-pattern-category-filter').value;
                const url = category 
                    ? `${API_BASE_URL}/command-center/patterns?category=${category}`
                    : `${API_BASE_URL}/command-center/patterns`;
                    
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error('Failed to load patterns');
                const data = await response.json();
                
                // Populate category filter
                const filter = document.getElementById('cc-pattern-category-filter');
                if (data.categories && filter.options.length <= 1) {
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat;
                        filter.appendChild(option);
                    });
                }
                
                const tbody = document.getElementById('cc-patterns-table-body');
                if (!data.patterns || data.patterns.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--stone-400);">No patterns defined. Click "+ Add Pattern" to create one.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.patterns.map(p => `
                    <tr>
                        <td><strong>${p.name}</strong></td>
                        <td><span class="badge">${p.category}</span></td>
                        <td>${(p.confidence * 100).toFixed(0)}%</td>
                        <td>${getValidationLevelBadge(p.validation_level)}</td>
                        <td>${p.hit_count || 0}</td>
                        <td>${p.false_positive_count || 0}</td>
                        <td>${p.last_matched_at ? formatDate(p.last_matched_at) : 'Never'}</td>
                        <td>${p.is_active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-muted">Inactive</span>'}</td>
                        <td>
                            <button class="btn-sm" onclick="editPattern(${p.id})">Edit</button>
                            <button class="btn-sm btn-danger" onclick="deletePattern(${p.id})">Delete</button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading patterns:', error);
                document.getElementById('cc-patterns-table-body').innerHTML = '<tr><td colspan="9" class="error">Error loading patterns</td></tr>';
            }
        }

        async function loadCommandCenterJobs() {
            try {
                const status = document.getElementById('cc-job-status-filter').value;
                const url = status 
                    ? `${API_BASE_URL}/command-center/jobs?status=${status}`
                    : `${API_BASE_URL}/command-center/jobs`;
                    
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error('Failed to load jobs');
                const data = await response.json();
                
                const tbody = document.getElementById('cc-jobs-table-body');
                if (!data.jobs || data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--stone-400);">No jobs found.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.jobs.map(job => `
                    <tr>
                        <td>${job.id}</td>
                        <td>${job.source_name}</td>
                        <td><span class="badge">${job.job_type}</span></td>
                        <td>${getJobStatusBadge(job.status)}</td>
                        <td>${job.items_processed || 0}</td>
                        <td>${job.items_accepted || 0}</td>
                        <td>${job.items_rejected || 0}</td>
                        <td>${job.created_at ? formatDate(job.created_at) : '-'}</td>
                        <td>
                            ${job.status === 'failed' ? `<button class="btn-sm" onclick="retryJob(${job.id})">Retry</button>` : ''}
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading jobs:', error);
                document.getElementById('cc-jobs-table-body').innerHTML = '<tr><td colspan="9" class="error">Error loading jobs</td></tr>';
            }
        }

        async function loadCommandCenterPipeline() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/pipeline-stats`);
                if (!response.ok) throw new Error('Failed to load pipeline stats');
                const data = await response.json();
                
                // Source performance
                const sourcePerf = document.getElementById('cc-source-performance');
                if (data.source_performance && data.source_performance.length > 0) {
                    sourcePerf.innerHTML = data.source_performance.map(sp => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--stone-200);">
                            <span style="font-weight: 500;">${sp.source_type}</span>
                            <span>
                                <span style="color: var(--stone-500);">${sp.total} total</span> | 
                                <span style="color: var(--green-600);">${sp.success_rate}% success</span>
                            </span>
                        </div>
                    `).join('');
                } else {
                    sourcePerf.innerHTML = '<div style="color: var(--stone-400);">No source data available</div>';
                }
                
                // Category breakdown
                const catBreak = document.getElementById('cc-category-breakdown');
                if (data.category_breakdown && data.category_breakdown.length > 0) {
                    catBreak.innerHTML = data.category_breakdown.map(cat => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--stone-200);">
                            <span>${cat.category || 'Uncategorized'}</span>
                            <span style="font-weight: 600;">${cat.count}</span>
                        </div>
                    `).join('');
                } else {
                    catBreak.innerHTML = '<div style="color: var(--stone-400);">No category data available</div>';
                }
                
                // Hourly stats
                const hourlyStats = document.getElementById('cc-hourly-stats');
                if (data.hourly_stats && data.hourly_stats.length > 0) {
                    hourlyStats.innerHTML = data.hourly_stats.slice(-12).map(h => `
                        <div style="background: var(--white); border: 1px solid var(--stone-200); border-radius: 8px; padding: 12px; min-width: 100px; text-align: center;">
                            <div style="font-size: 11px; color: var(--stone-400); margin-bottom: 4px;">${h.hour.split(' ')[1] || h.hour}</div>
                            <div style="font-size: 16px; font-weight: 600;">${h.received}</div>
                            <div style="font-size: 11px; color: var(--green-600);">${h.opportunities} opps</div>
                        </div>
                    `).join('');
                } else {
                    hourlyStats.innerHTML = '<div style="color: var(--stone-400);">No hourly data available</div>';
                }
            } catch (error) {
                console.error('Error loading pipeline stats:', error);
            }
        }

        async function loadCommandCenterScrapes() {
            try {
                const sourceType = document.getElementById('cc-scrape-source-filter').value;
                const processed = document.getElementById('cc-scrape-processed-filter').value;
                
                let url = `${API_BASE_URL}/command-center/scrapes?limit=50`;
                if (sourceType) url += `&source_type=${sourceType}`;
                if (processed) url += `&processed=${processed}`;
                
                const response = await fetchWithAuth(url);
                if (!response.ok) throw new Error('Failed to load scrapes');
                const data = await response.json();
                
                const tbody = document.getElementById('cc-scrapes-table-body');
                if (!data.scrapes || data.scrapes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--stone-400);">No scrapes found.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.scrapes.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td><code style="font-size: 11px;">${s.external_id || '-'}</code></td>
                        <td><span class="badge">${s.source_type}</span></td>
                        <td>${s.processed ? '<span class="badge badge-success">Processed</span>' : '<span class="badge badge-warning">Pending</span>'}</td>
                        <td>${s.received_at ? formatDate(s.received_at) : '-'}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 11px; color: var(--stone-500);">${s.raw_data_preview || '-'}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading scrapes:', error);
                document.getElementById('cc-scrapes-table-body').innerHTML = '<tr><td colspan="6" class="error">Error loading scrapes</td></tr>';
            }
        }

        async function seedDefaultSources() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/seed-default-sources`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error('Failed to seed sources');
                const data = await response.json();
                showToast(data.message, 'success');
                await loadCommandCenterSources();
            } catch (error) {
                console.error('Error seeding sources:', error);
                showToast('Failed to seed default sources', 'error');
            }
        }

        async function toggleSource(sourceId) {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/sources/${sourceId}/toggle`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error('Failed to toggle source');
                await loadCommandCenterSources();
                showToast('Source updated', 'success');
            } catch (error) {
                console.error('Error toggling source:', error);
                showToast('Failed to update source', 'error');
            }
        }

        async function retryJob(jobId) {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/jobs/${jobId}/retry`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error('Failed to retry job');
                await loadCommandCenterJobs();
                showToast('Job queued for retry', 'success');
            } catch (error) {
                console.error('Error retrying job:', error);
                showToast('Failed to retry job', 'error');
            }
        }

        async function deletePattern(patternId) {
            if (!confirm('Are you sure you want to delete this pattern?')) return;
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/patterns/${patternId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete pattern');
                await loadCommandCenterPatterns();
                showToast('Pattern deleted', 'success');
            } catch (error) {
                console.error('Error deleting pattern:', error);
                showToast('Failed to delete pattern', 'error');
            }
        }

        function getStatusBadge(status, isActive) {
            if (!isActive) return '<span class="badge badge-muted">Disabled</span>';
            switch (status) {
                case 'active': return '<span class="badge badge-success">Active</span>';
                case 'paused': return '<span class="badge badge-warning">Paused</span>';
                case 'error': return '<span class="badge badge-danger">Error</span>';
                default: return '<span class="badge">' + status + '</span>';
            }
        }

        function getValidationLevelBadge(level) {
            switch (level) {
                case 'goldmine': return '<span class="badge" style="background: #fef3c7; color: #92400e;">Goldmine</span>';
                case 'validated': return '<span class="badge badge-success">Validated</span>';
                case 'weak_signal': return '<span class="badge badge-warning">Weak Signal</span>';
                default: return '<span class="badge">' + level + '</span>';
            }
        }

        function getJobStatusBadge(status) {
            switch (status) {
                case 'completed': return '<span class="badge badge-success">Completed</span>';
                case 'running': return '<span class="badge" style="background: #dbeafe; color: #1e40af;">Running</span>';
                case 'pending': return '<span class="badge badge-warning">Pending</span>';
                case 'failed': return '<span class="badge badge-danger">Failed</span>';
                default: return '<span class="badge">' + status + '</span>';
            }
        }

        function showAddSourceModal() {
            showToast('Add Source modal - coming soon', 'info');
        }

        function showAddPatternModal() {
            showToast('Add Pattern modal - coming soon', 'info');
        }

        function showCreateJobModal() {
            showToast('Create Job modal - coming soon', 'info');
        }

        function editPattern(patternId) {
            showToast('Edit Pattern modal - coming soon', 'info');
        }

        // ===== APIFY FUNCTIONS =====

        async function loadApifyStatus() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/status`);
                const data = await response.json();
                const statusEl = document.getElementById('apify-status');
                
                if (data.configured) {
                    statusEl.innerHTML = '<span style="color: var(--green-600);"> Apify connected</span>';
                    statusEl.style.background = 'var(--green-50)';
                } else {
                    statusEl.innerHTML = '<span style="color: var(--red-600);"> Apify not configured - Add APIFY_API_TOKEN to secrets</span>';
                    statusEl.style.background = 'var(--red-50)';
                }
            } catch (error) {
                console.error('Error checking Apify status:', error);
                document.getElementById('apify-status').innerHTML = '<span style="color: var(--red-600);">Error checking Apify connection</span>';
            }
        }

        async function loadApifyActors() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/actors`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to load actors');
                }
                const data = await response.json();
                
                document.getElementById('apify-actors-count').textContent = `${data.count} actors`;
                
                const listEl = document.getElementById('apify-actors-list');
                if (!data.actors || data.actors.length === 0) {
                    listEl.innerHTML = '<div style="color: var(--stone-400);">No actors found</div>';
                    return;
                }
                
                listEl.innerHTML = data.actors.map(actor => `
                    <div style="padding: 10px; border-bottom: 1px solid var(--stone-200); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${actor.name || actor.id}</strong>
                            <div style="font-size: 12px; color: var(--stone-500);">${actor.username || ''}/${actor.name || ''}</div>
                        </div>
                        <button class="btn-sm btn-primary" onclick="runApifyActor('${actor.id}')">Run</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading Apify actors:', error);
                document.getElementById('apify-actors-list').innerHTML = `<div style="color: var(--red-500);">${error.message}</div>`;
            }
        }

        async function loadApifySchedules() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/schedules`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to load schedules');
                }
                const data = await response.json();
                
                document.getElementById('apify-schedules-count').textContent = `${data.count} schedules`;
                
                const listEl = document.getElementById('apify-schedules-list');
                if (!data.schedules || data.schedules.length === 0) {
                    listEl.innerHTML = '<div style="color: var(--stone-400);">No schedules configured</div>';
                    return;
                }
                
                listEl.innerHTML = data.schedules.map(schedule => `
                    <div style="padding: 10px; border-bottom: 1px solid var(--stone-200);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>${schedule.name}</strong>
                            ${schedule.isEnabled ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-muted">Disabled</span>'}
                        </div>
                        <div style="font-size: 12px; color: var(--stone-500); margin-top: 4px;">
                            <code>${schedule.cronExpression}</code>  ${schedule.timezone || 'UTC'}
                        </div>
                        <div style="margin-top: 8px; display: flex; gap: 4px;">
                            <button class="btn-sm" onclick="toggleApifySchedule('${schedule.id}', ${!schedule.isEnabled})">${schedule.isEnabled ? 'Disable' : 'Enable'}</button>
                            <button class="btn-sm btn-danger" onclick="deleteApifySchedule('${schedule.id}')">Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading Apify schedules:', error);
                document.getElementById('apify-schedules-list').innerHTML = `<div style="color: var(--red-500);">${error.message}</div>`;
            }
        }

        async function loadApifyRuns() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/runs?limit=20`);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to load runs');
                }
                const data = await response.json();
                
                document.getElementById('apify-runs-count').textContent = `${data.count} runs`;
                
                const tbody = document.getElementById('apify-runs-table-body');
                if (!data.runs || data.runs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--stone-400);">No runs found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.runs.map(run => {
                    const duration = run.finishedAt && run.startedAt 
                        ? Math.round((new Date(run.finishedAt) - new Date(run.startedAt)) / 1000) + 's'
                        : (run.startedAt ? 'Running...' : '-');
                    
                    return `
                        <tr>
                            <td>${run.actId || run.actorId || 'Unknown'}</td>
                            <td>${getApifyRunStatusBadge(run.status)}</td>
                            <td>${run.startedAt ? formatDate(run.startedAt) : '-'}</td>
                            <td>${duration}</td>
                            <td>${run.stats?.requestsFinished || run.stats?.itemCount || '-'}</td>
                            <td>
                                ${run.status === 'RUNNING' ? `<button class="btn-sm btn-danger" onclick="abortApifyRun('${run.id}')">Abort</button>` : ''}
                                ${run.defaultDatasetId ? `<button class="btn-sm" onclick="viewApifyDataset('${run.id}')">View Data</button>` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading Apify runs:', error);
                document.getElementById('apify-runs-table-body').innerHTML = `<tr><td colspan="6" class="error">${error.message}</td></tr>`;
            }
        }

        function getApifyRunStatusBadge(status) {
            switch (status) {
                case 'SUCCEEDED': return '<span class="badge badge-success">Succeeded</span>';
                case 'RUNNING': return '<span class="badge" style="background: #dbeafe; color: #1e40af;">Running</span>';
                case 'READY': return '<span class="badge badge-warning">Ready</span>';
                case 'FAILED': return '<span class="badge badge-danger">Failed</span>';
                case 'ABORTED': return '<span class="badge badge-muted">Aborted</span>';
                case 'TIMED-OUT': return '<span class="badge badge-danger">Timed Out</span>';
                default: return `<span class="badge">${status}</span>`;
            }
        }

        async function runApifyActor(actorId) {
            if (!confirm('Start this actor now?')) return;
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/actors/${actorId}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to start actor');
                }
                showToast('Actor started successfully', 'success');
                loadApifyRuns();
            } catch (error) {
                console.error('Error running actor:', error);
                showToast(error.message || 'Failed to start actor', 'error');
            }
        }

        async function abortApifyRun(runId) {
            if (!confirm('Abort this run?')) return;
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/runs/${runId}/abort`, {
                    method: 'POST'
                });
                if (!response.ok) throw new Error('Failed to abort run');
                showToast('Run aborted', 'success');
                loadApifyRuns();
            } catch (error) {
                console.error('Error aborting run:', error);
                showToast('Failed to abort run', 'error');
            }
        }

        async function importApifyRun() {
            const runId = document.getElementById('apify-import-run-id').value.trim();
            if (!runId) {
                showToast('Please enter a Run ID', 'error');
                return;
            }
            
            const statusEl = document.getElementById('apify-import-status');
            statusEl.style.display = 'block';
            statusEl.innerHTML = '<span style="color: var(--amber-600);">Importing... This may take a minute for large datasets.</span>';
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/runs/${runId}/import`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Import failed');
                }
                
                if (result.status === 'imported') {
                    statusEl.innerHTML = `
                        <div style="color: var(--emerald-600); font-weight: 500;">
                            Import successful!
                        </div>
                        <div style="color: var(--stone-600); font-size: 13px; margin-top: 8px;">
                            <strong>${result.places_imported}</strong> businesses and 
                            <strong>${result.reviews_imported}</strong> reviews imported to OppGrid.
                        </div>
                    `;
                    showToast(`Imported ${result.places_imported} places and ${result.reviews_imported} reviews`, 'success');
                    document.getElementById('apify-import-run-id').value = '';
                } else {
                    statusEl.innerHTML = `<span style="color: var(--amber-600);">Run status: ${result.status}. ${result.message || 'Cannot import yet.'}</span>`;
                }
            } catch (error) {
                console.error('Import error:', error);
                statusEl.innerHTML = `<span style="color: var(--red-600);">Error: ${error.message}</span>`;
                showToast('Import failed: ' + error.message, 'error');
            }
        }

        async function toggleApifySchedule(scheduleId, enable) {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/schedules/${scheduleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_enabled: enable })
                });
                if (!response.ok) throw new Error('Failed to update schedule');
                showToast('Schedule updated', 'success');
                loadApifySchedules();
            } catch (error) {
                console.error('Error updating schedule:', error);
                showToast('Failed to update schedule', 'error');
            }
        }

        async function deleteApifySchedule(scheduleId) {
            if (!confirm('Delete this schedule?')) return;
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/schedules/${scheduleId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) throw new Error('Failed to delete schedule');
                showToast('Schedule deleted', 'success');
                loadApifySchedules();
            } catch (error) {
                console.error('Error deleting schedule:', error);
                showToast('Failed to delete schedule', 'error');
            }
        }

        async function viewApifyDataset(runId) {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/apify/runs/${runId}/dataset?limit=50`);
                if (!response.ok) throw new Error('Failed to load dataset');
                const data = await response.json();
                
                const modal = document.createElement('div');
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
                modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
                
                modal.innerHTML = `
                    <div style="background: white; padding: 24px; border-radius: 12px; max-width: 80vw; max-height: 80vh; overflow: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3>Dataset Items (${data.count})</h3>
                            <button onclick="this.closest('.modal-overlay')?.remove(); document.querySelector('[style*=\\'position: fixed\\']')?.remove();" style="background: none; border: none; font-size: 24px; cursor: pointer;">&times;</button>
                        </div>
                        <pre style="background: var(--stone-100); padding: 16px; border-radius: 8px; max-height: 60vh; overflow: auto; font-size: 12px;">${JSON.stringify(data.items, null, 2)}</pre>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading dataset:', error);
                showToast('Failed to load dataset', 'error');
            }
        }

        // ===== END APIFY FUNCTIONS =====

        // ===== SERPAPI FUNCTIONS =====

        async function loadSerpAPIStatus() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/serpapi/status`);
                const data = await response.json();
                const statusEl = document.getElementById('serpapi-status');
                
                if (data.configured && !data.error) {
                    statusEl.innerHTML = `
                        <span style="color: var(--green-600);"> SerpAPI connected</span>
                        <span style="margin-left: 20px; color: var(--stone-600);">
                            Plan: <strong>${data.plan || 'N/A'}</strong> | 
                            Used: <strong>${data.this_month_usage || 0}</strong>/${data.searches_per_month || 0} | 
                            Remaining: <strong>${data.remaining || 0}</strong>
                        </span>
                    `;
                    statusEl.style.background = 'var(--green-50)';
                } else if (data.configured) {
                    statusEl.innerHTML = `<span style="color: var(--yellow-600);"> SerpAPI configured but ${data.error || 'unable to fetch account info'}</span>`;
                    statusEl.style.background = 'var(--yellow-50)';
                } else {
                    statusEl.innerHTML = '<span style="color: var(--red-600);"> SerpAPI not configured - Add SERPAPI_KEY to secrets</span>';
                    statusEl.style.background = 'var(--red-50)';
                }
            } catch (error) {
                console.error('Error checking SerpAPI status:', error);
                document.getElementById('serpapi-status').innerHTML = '<span style="color: var(--red-600);">Error checking SerpAPI connection</span>';
            }
        }

        async function runSerpAPIGoogleSearch() {
            const query = document.getElementById('serpapi-search-query').value.trim();
            const location = document.getElementById('serpapi-search-location').value.trim();
            
            if (!query) {
                showToast('Please enter a search query', 'error');
                return;
            }
            
            document.getElementById('serpapi-results').innerHTML = '<div style="text-align: center; padding: 40px;">Searching...</div>';
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/serpapi/google-search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, location: location || null })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Search failed');
                }
                
                const data = await response.json();
                displaySerpAPISearchResults(data);
            } catch (error) {
                console.error('SerpAPI search error:', error);
                document.getElementById('serpapi-results').innerHTML = `<div style="color: var(--red-500); padding: 20px;">${error.message}</div>`;
                showToast(error.message || 'Search failed', 'error');
            }
        }

        async function runSerpAPIMapsSearch() {
            const query = document.getElementById('serpapi-maps-query').value.trim();
            const location = document.getElementById('serpapi-maps-location').value.trim();
            
            if (!query) {
                showToast('Please enter a search query', 'error');
                return;
            }
            
            document.getElementById('serpapi-results').innerHTML = '<div style="text-align: center; padding: 40px;">Searching Google Maps...</div>';
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/serpapi/google-maps`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, location: location || null })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Search failed');
                }
                
                const data = await response.json();
                displaySerpAPIMapsResults(data);
            } catch (error) {
                console.error('SerpAPI Maps search error:', error);
                document.getElementById('serpapi-results').innerHTML = `<div style="color: var(--red-500); padding: 20px;">${error.message}</div>`;
                showToast(error.message || 'Search failed', 'error');
            }
        }

        async function runSerpAPIPlacesWithReviews() {
            const query = document.getElementById('serpapi-places-query').value.trim();
            const location = document.getElementById('serpapi-places-location').value.trim();
            const maxPlaces = parseInt(document.getElementById('serpapi-places-max').value);
            const reviewsPerPlace = parseInt(document.getElementById('serpapi-places-reviews').value);
            
            if (!query) {
                showToast('Please enter a business type', 'error');
                return;
            }
            
            document.getElementById('serpapi-results').innerHTML = '<div style="text-align: center; padding: 40px;">Searching places and fetching reviews... This may take a moment.</div>';
            
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/command-center/serpapi/places-with-reviews`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        query, 
                        location: location || null,
                        max_places: maxPlaces,
                        reviews_per_place: reviewsPerPlace
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Search failed');
                }
                
                const data = await response.json();
                displaySerpAPIPlacesWithReviews(data);
            } catch (error) {
                console.error('SerpAPI places search error:', error);
                document.getElementById('serpapi-results').innerHTML = `<div style="color: var(--red-500); padding: 20px;">${error.message}</div>`;
                showToast(error.message || 'Search failed', 'error');
            }
        }

        function displaySerpAPISearchResults(data) {
            const resultsEl = document.getElementById('serpapi-results');
            const countEl = document.getElementById('serpapi-results-count');
            
            const organicResults = data.organic_results || [];
            countEl.textContent = `${organicResults.length} results`;
            
            if (organicResults.length === 0) {
                resultsEl.innerHTML = '<div style="color: var(--stone-400); text-align: center; padding: 40px;">No results found</div>';
                return;
            }
            
            resultsEl.innerHTML = organicResults.map((result, i) => `
                <div style="padding: 16px; border-bottom: 1px solid var(--stone-200);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div>
                            <a href="${result.link}" target="_blank" style="font-weight: 600; color: var(--primary); text-decoration: none;">
                                ${i + 1}. ${result.title}
                            </a>
                            <div style="font-size: 12px; color: var(--green-600); margin-top: 4px;">${result.displayed_link || result.link}</div>
                            <div style="font-size: 14px; color: var(--stone-600); margin-top: 8px;">${result.snippet || ''}</div>
                        </div>
                        ${result.position ? `<span class="badge">#${result.position}</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function displaySerpAPIMapsResults(data) {
            const resultsEl = document.getElementById('serpapi-results');
            const countEl = document.getElementById('serpapi-results-count');
            
            const localResults = data.local_results || [];
            countEl.textContent = `${localResults.length} places`;
            
            if (localResults.length === 0) {
                resultsEl.innerHTML = '<div style="color: var(--stone-400); text-align: center; padding: 40px;">No places found</div>';
                return;
            }
            
            resultsEl.innerHTML = localResults.map(place => `
                <div style="padding: 16px; border-bottom: 1px solid var(--stone-200);">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--stone-800);">${place.title}</div>
                            <div style="font-size: 12px; color: var(--stone-500); margin-top: 4px;">${place.address || ''}</div>
                            <div style="font-size: 14px; margin-top: 8px; display: flex; gap: 12px; flex-wrap: wrap;">
                                ${place.rating ? `<span> ${place.rating} (${place.reviews || 0} reviews)</span>` : ''}
                                ${place.type ? `<span class="badge">${place.type}</span>` : ''}
                                ${place.phone ? `<span> ${place.phone}</span>` : ''}
                            </div>
                            ${place.data_id ? `<div style="font-size: 11px; color: var(--stone-400); margin-top: 8px;">Data ID: ${place.data_id}</div>` : ''}
                        </div>
                        ${place.thumbnail ? `<img src="${place.thumbnail}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; margin-left: 16px;">` : ''}
                    </div>
                </div>
            `).join('');
        }

        function displaySerpAPIPlacesWithReviews(data) {
            const resultsEl = document.getElementById('serpapi-results');
            const countEl = document.getElementById('serpapi-results-count');
            
            const places = data.places || [];
            const totalReviews = places.reduce((acc, p) => acc + (p.reviews?.length || 0), 0);
            countEl.textContent = `${places.length} places, ${totalReviews} reviews`;
            
            if (places.length === 0) {
                resultsEl.innerHTML = '<div style="color: var(--stone-400); text-align: center; padding: 40px;">No places found</div>';
                return;
            }
            
            resultsEl.innerHTML = places.map(place => `
                <div style="padding: 20px; border-bottom: 2px solid var(--stone-300); margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                        <div>
                            <div style="font-weight: 700; font-size: 18px; color: var(--stone-800);">${place.title}</div>
                            <div style="font-size: 13px; color: var(--stone-500); margin-top: 4px;">${place.address || ''}</div>
                            <div style="margin-top: 8px; display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                                ${place.rating ? `<span style="font-weight: 600;"> ${place.rating}</span>` : ''}
                                ${place.reviews_count ? `<span>(${place.reviews_count} total reviews)</span>` : ''}
                                ${place.type ? `<span class="badge">${place.type}</span>` : ''}
                                ${place.phone ? `<span> ${place.phone}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    
                    ${place.reviews && place.reviews.length > 0 ? `
                        <div style="background: white; border-radius: 8px; padding: 12px;">
                            <div style="font-weight: 600; margin-bottom: 12px; color: var(--stone-700);">Recent Reviews (${place.reviews.length})</div>
                            ${place.reviews.map(review => `
                                <div style="padding: 12px; border-bottom: 1px solid var(--stone-100); font-size: 14px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <span style="font-weight: 500;">${review.user?.name || 'Anonymous'}</span>
                                        <span style="display: flex; gap: 8px; align-items: center;">
                                            <span style="color: var(--yellow-600);">${''.repeat(review.rating || 0)}${''.repeat(5 - (review.rating || 0))}</span>
                                            <span style="color: var(--stone-400); font-size: 12px;">${review.date || review.iso_date || ''}</span>
                                        </span>
                                    </div>
                                    <div style="color: var(--stone-600);">${review.snippet || review.text || 'No text'}</div>
                                    ${review.response ? `
                                        <div style="margin-top: 8px; padding: 8px; background: var(--stone-50); border-radius: 4px; font-size: 13px;">
                                            <strong>Owner Response:</strong> ${review.response.snippet || ''}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : '<div style="color: var(--stone-400); font-size: 14px;">No reviews fetched</div>'}
                </div>
            `).join('');
        }

        // ===== END SERPAPI FUNCTIONS =====

        // ===== END COMMAND CENTER FUNCTIONS =====

        // ===== GOOGLE SCRAPING FUNCTIONS =====
        let gsLocations = [];
        let gsKeywordGroups = [];
        let gsSelectedJobId = null;

        async function loadGoogleScraping() {
            await Promise.all([
                loadGoogleScrapingStats(),
                loadGoogleScrapingLocations(),
                loadGoogleScrapingKeywords(),
                loadGoogleScrapingJobs()
            ]);
            populateJobDropdowns();
        }

        async function loadGoogleScrapingStats() {
            try {
                const response = await fetchWithAuth('/api/v1/google-scraping/stats');
                const stats = await response.json();
                document.getElementById('gs-stat-locations').textContent = stats.total_locations || 0;
                document.getElementById('gs-stat-keywords').textContent = stats.total_keyword_groups || 0;
                document.getElementById('gs-stat-jobs').textContent = stats.total_jobs || 0;
                document.getElementById('gs-stat-businesses').textContent = stats.cached_businesses || 0;
            } catch (error) {
                console.error('Failed to load Google Scraping stats:', error);
            }
        }

        async function loadGoogleScrapingLocations() {
            const search = document.getElementById('gs-location-search')?.value || '';
            try {
                const response = await fetchWithAuth(`/api/v1/google-scraping/locations?search=${encodeURIComponent(search)}`, {}, false);
                if (!response.ok) {
                    console.error('Failed to load locations:', response.status);
                    return; // Keep existing data on error
                }
                const data = await response.json();
                if (Array.isArray(data)) {
                    gsLocations = data;
                    renderLocationsList(gsLocations);
                }
            } catch (error) {
                console.error('Failed to load locations:', error);
                // Don't clear existing data on error
            }
        }

        function renderLocationsList(locations) {
            const container = document.getElementById('gs-locations-list');
            // Filter out zip codes - they are children of cities, not main locations
            const mainLocations = locations.filter(loc => {
                const type = (loc.location_type || '').toLowerCase();
                return type === 'city' || type === 'metro' || type === 'neighborhood';
            });
            if (!mainLocations.length) {
                container.innerHTML = '<div style="padding: 16px; color: var(--stone-500);">No locations found. Click + Add to create one.</div>';
                return;
            }
            container.innerHTML = mainLocations.map(loc => `
                <div class="list-item" style="padding: 12px; border-bottom: 1px solid var(--stone-100); display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <div style="font-weight: 500;">${loc.name}</div>
                        <div style="font-size: 12px; color: var(--stone-500);">
                            ${loc.location_type} | ${loc.scraped_count || 0} scrapes
                            ${loc.last_scraped_at ? ` | Last: ${new Date(loc.last_scraped_at).toLocaleDateString()}` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-sm" onclick="deleteLocation(${loc.id})" title="Delete"></button>
                    </div>
                </div>
            `).join('');
        }

        async function loadGoogleScrapingKeywords() {
            const search = document.getElementById('gs-keyword-search')?.value || '';
            try {
                const response = await fetchWithAuth(`/api/v1/google-scraping/keyword-groups?search=${encodeURIComponent(search)}`);
                gsKeywordGroups = await response.json();
                renderKeywordsList(gsKeywordGroups);
            } catch (error) {
                console.error('Failed to load keyword groups:', error);
                document.getElementById('gs-keywords-list').innerHTML = '<div class="error">Failed to load keyword groups</div>';
            }
        }

        function renderKeywordsList(groups) {
            const container = document.getElementById('gs-keywords-list');
            if (!groups.length) {
                container.innerHTML = '<div style="padding: 16px; color: var(--stone-500);">No keyword groups found. Click + Add to create one.</div>';
                return;
            }
            container.innerHTML = groups.map(g => `
                <div class="list-item" style="padding: 12px; border-bottom: 1px solid var(--stone-100);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 500;">${g.name}</div>
                            <div style="font-size: 12px; color: var(--stone-500);">
                                ${g.category || 'Uncategorized'} | ${g.keywords?.length || 0} keywords | ${g.total_searches || 0} searches
                            </div>
                        </div>
                        <button class="btn-sm" onclick="deleteKeywordGroup(${g.id})" title="Delete"></button>
                    </div>
                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                        ${(g.keywords || []).slice(0, 5).map(k => `<span class="badge" style="font-size: 11px;">${k}</span>`).join('')}
                        ${g.keywords?.length > 5 ? `<span style="font-size: 11px; color: var(--stone-400);">+${g.keywords.length - 5} more</span>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function populateJobDropdowns() {
            const locationSelect = document.getElementById('gs-job-location');
            const keywordsSelect = document.getElementById('gs-job-keywords');
            
            // Show city, metro, neighborhood - but NOT zip codes (those are children of cities)
            const mainLocations = gsLocations.filter(l => {
                const type = (l.location_type || '').toLowerCase();
                return type === 'city' || type === 'metro' || type === 'neighborhood';
            });
            locationSelect.innerHTML = '<option value="">Select location...</option>' + 
                mainLocations.map(l => {
                    const typeLabel = l.location_type ? ` (${l.location_type})` : '';
                    return `<option value="${l.id}" data-type="${l.location_type || ''}">${l.name}${typeLabel}</option>`;
                }).join('');
            
            keywordsSelect.innerHTML = '<option value="">Select keywords...</option>' + 
                gsKeywordGroups.map(g => `<option value="${g.id}">${g.name} (${g.keywords?.length || 0})</option>`).join('');
        }

        let gsCurrentCityZips = [];
        let gsSelectedZips = new Set();

        async function onCityChange() {
            const locationSelect = document.getElementById('gs-job-location');
            const locationId = locationSelect.value;
            const selectedOption = locationSelect.options[locationSelect.selectedIndex];
            const locationType = selectedOption?.dataset?.type || '';
            
            gsCurrentCityZips = [];
            gsSelectedZips.clear();
            
            // Only show zip options for cities
            const zipModeSelect = document.getElementById('gs-job-zip-mode');
            const zipCoverageBtn = document.querySelector('[onclick="runWithZipCoverage()"]');
            
            if (locationType === 'city' && locationId) {
                zipModeSelect.disabled = false;
                zipCoverageBtn.disabled = false;
                zipCoverageBtn.style.opacity = '1';
                
                try {
                    const response = await fetchWithAuth(`/api/v1/google-scraping/locations/${locationId}/children`);
                    gsCurrentCityZips = await response.json();
                    document.getElementById('gs-zip-count').textContent = `(${gsCurrentCityZips.length} available)`;
                    
                    gsCurrentCityZips.forEach(z => gsSelectedZips.add(z.id));
                    renderZipList();
                } catch (error) {
                    console.error('Failed to load zip codes:', error);
                    document.getElementById('gs-zip-list').innerHTML = '<span style="color: #ef4444;">Failed to load zip codes</span>';
                }
            } else {
                // Non-city location - disable zip options
                zipModeSelect.disabled = true;
                zipModeSelect.value = 'city_only';
                zipCoverageBtn.disabled = true;
                zipCoverageBtn.style.opacity = '0.5';
                document.getElementById('gs-zip-selector').style.display = 'none';
                document.getElementById('gs-zip-count').textContent = '(cities only)';
                document.getElementById('gs-zip-list').innerHTML = '<span style="color: #666;">Zip coverage only available for city locations</span>';
            }
        }

        function onZipModeChange() {
            const mode = document.getElementById('gs-job-zip-mode').value;
            document.getElementById('gs-zip-selector').style.display = mode === 'specific_zips' ? 'block' : 'none';
        }

        function renderZipList() {
            const container = document.getElementById('gs-zip-list');
            if (!gsCurrentCityZips.length) {
                container.innerHTML = '<span style="color: #666;">No zip codes for this city</span>';
                return;
            }
            container.innerHTML = gsCurrentCityZips.map(z => {
                const isSelected = gsSelectedZips.has(z.id);
                const zipCode = z.extra_data?.zip || z.name.split(' - ')[0];
                return `<label style="display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: ${isSelected ? '#22c55e22' : '#222'}; border: 1px solid ${isSelected ? '#22c55e' : '#333'}; border-radius: 6px; cursor: pointer;">
                    <input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleZip(${z.id})" style="margin: 0;">
                    <span style="font-size: 13px;">${zipCode}</span>
                </label>`;
            }).join('');
        }

        function toggleZip(zipId) {
            if (gsSelectedZips.has(zipId)) {
                gsSelectedZips.delete(zipId);
            } else {
                gsSelectedZips.add(zipId);
            }
            renderZipList();
        }

        function selectAllZips() {
            gsCurrentCityZips.forEach(z => gsSelectedZips.add(z.id));
            renderZipList();
        }

        function deselectAllZips() {
            gsSelectedZips.clear();
            renderZipList();
        }

        async function runWithZipCoverage() {
            const cityId = document.getElementById('gs-job-location').value;
            const keywordGroupId = document.getElementById('gs-job-keywords').value;
            const sourceType = document.getElementById('gs-job-source').value;
            const depth = parseInt(document.getElementById('gs-job-depth').value);
            const zipMode = document.getElementById('gs-job-zip-mode').value;
            const baseName = document.getElementById('gs-job-name').value.trim();

            if (!keywordGroupId) {
                showToast('Please select a keyword group', 'error');
                return;
            }
            if (!cityId) {
                showToast('Please select a city', 'error');
                return;
            }

            const keywordGroup = gsKeywordGroups.find(kg => kg.id == keywordGroupId);
            const keywordName = keywordGroup?.name || 'Keywords';
            const city = gsLocations.find(l => l.id == cityId);
            const cityName = city?.name || 'City';

            let locationsToScrape = [];

            if (zipMode === 'city_only') {
                locationsToScrape = [{ id: parseInt(cityId), name: cityName }];
            } else if (zipMode === 'all_zips') {
                if (gsCurrentCityZips.length === 0) {
                    await onCityChange();
                }
                if (gsCurrentCityZips.length === 0) {
                    locationsToScrape = [{ id: parseInt(cityId), name: cityName }];
                } else {
                    locationsToScrape = gsCurrentCityZips.map(z => ({ id: z.id, name: z.name }));
                }
            } else {
                locationsToScrape = gsCurrentCityZips.filter(z => gsSelectedZips.has(z.id)).map(z => ({ id: z.id, name: z.name }));
                if (locationsToScrape.length === 0) {
                    showToast('Please select at least one zip code', 'error');
                    return;
                }
            }

            if (!confirm(`This will create and run ${locationsToScrape.length} job(s) for "${keywordName}". Continue?`)) {
                return;
            }

            const progressDiv = document.getElementById('gs-batch-progress');
            const statusEl = document.getElementById('gs-batch-status');
            const countEl = document.getElementById('gs-batch-count');
            const barEl = document.getElementById('gs-batch-bar');
            const logEl = document.getElementById('gs-batch-log');

            progressDiv.style.display = 'block';
            logEl.innerHTML = '';
            barEl.style.background = '#22c55e';
            let completed = 0;
            let failed = 0;
            let totalFound = 0;

            const addLog = (msg, type = 'info') => {
                const color = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#888';
                logEl.innerHTML += `<div style="color: ${color};">${new Date().toLocaleTimeString()}: ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            };

            for (let i = 0; i < locationsToScrape.length; i++) {
                const location = locationsToScrape[i];
                const jobName = baseName || `${location.name} - ${keywordName}`;

                statusEl.textContent = `Processing: ${location.name}`;
                countEl.textContent = `${i + 1}/${locationsToScrape.length}`;
                barEl.style.width = `${((i) / locationsToScrape.length) * 100}%`;

                addLog(`Creating job: ${location.name}`);

                try {
                    const createResponse = await fetchWithAuth('/api/v1/google-scraping/jobs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: locationsToScrape.length > 1 ? `${location.name} - ${keywordName}` : jobName,
                            location_id: location.id,
                            keyword_group_id: parseInt(keywordGroupId),
                            source_type: sourceType,
                            depth
                        })
                    });

                    if (!createResponse.ok) throw new Error('Failed to create job');
                    const { job_id } = await createResponse.json();

                    addLog(`Running job for ${location.name}...`);

                    const runResponse = await fetchWithAuth(`/api/v1/google-scraping/jobs/${job_id}/run`, {
                        method: 'POST'
                    });

                    if (!runResponse.ok) {
                        const error = await runResponse.json();
                        throw new Error(error.detail || 'Job execution failed');
                    }

                    const result = await runResponse.json();
                    totalFound += result.total_found || 0;
                    completed++;
                    addLog(`Completed ${location.name}: ${result.total_found || 0} results`, 'success');
                } catch (error) {
                    failed++;
                    addLog(`Failed ${location.name}: ${error.message}`, 'error');
                }

                barEl.style.width = `${((i + 1) / locationsToScrape.length) * 100}%`;
            }

            statusEl.textContent = `Done! ${completed} completed, ${failed} failed`;
            countEl.textContent = `Total results: ${totalFound}`;
            barEl.style.width = '100%';
            barEl.style.background = failed > 0 ? '#f59e0b' : '#22c55e';

            showToast(`Batch complete: ${completed} jobs, ${totalFound} total results`, 'success');
            loadGoogleScrapingStats();
            loadGoogleScrapingJobs();
        }

        async function loadGoogleScrapingJobs() {
            const status = document.getElementById('gs-job-status-filter')?.value || '';
            try {
                const response = await fetchWithAuth(`/api/v1/google-scraping/jobs?status=${encodeURIComponent(status)}`);
                const jobs = await response.json();
                renderJobsTable(jobs);
            } catch (error) {
                console.error('Failed to load jobs:', error);
                document.getElementById('gs-jobs-table-body').innerHTML = '<tr><td colspan="8" class="error">Failed to load jobs</td></tr>';
            }
        }

        let gsAutoRefreshInterval = null;

        function renderJobsTable(jobs) {
            const tbody = document.getElementById('gs-jobs-table-body');
            if (!jobs.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--stone-500);">No jobs found</td></tr>';
                return;
            }

            const hasRunningJobs = jobs.some(j => j.status === 'running');
            if (hasRunningJobs && !gsAutoRefreshInterval) {
                gsAutoRefreshInterval = setInterval(() => {
                    loadGoogleScrapingJobs();
                    loadGoogleScrapingStats();
                }, 3000);
            } else if (!hasRunningJobs && gsAutoRefreshInterval) {
                clearInterval(gsAutoRefreshInterval);
                gsAutoRefreshInterval = null;
            }

            tbody.innerHTML = jobs.map(j => `
                <tr>
                    <td>${j.name}</td>
                    <td><span class="badge">${j.source_type === 'google_maps_reviews' ? 'Maps Reviews' : 'Google Search'}</span></td>
                    <td>${j.location_name || '-'}</td>
                    <td>${j.keyword_group_name || '-'}</td>
                    <td><span class="badge ${j.status === 'completed' ? 'badge-success' : j.status === 'failed' ? 'badge-error' : j.status === 'running' ? 'badge-warning' : ''}">${j.status}${j.status === 'running' ? ' ' : ''}</span></td>
                    <td>${j.total_found || 0}</td>
                    <td>${j.created_at ? new Date(j.created_at).toLocaleString() : '-'}</td>
                    <td>
                        ${j.status === 'completed' || j.status === 'failed' ? `<button class="btn-sm" onclick="viewJobResults(${j.id})">View</button>` : ''}
                        ${j.status === 'running' ? `<span style="color: var(--amber-500); font-size: 12px;">Running...</span>` : ''}
                        ${j.status === 'pending' ? `<button class="btn-sm" onclick="runJob(${j.id})">Run</button>` : ''}
                    </td>
                </tr>
            `).join('');
        }

        async function createAndRunJob() {
            const locationId = document.getElementById('gs-job-location').value;
            const keywordGroupId = document.getElementById('gs-job-keywords').value;
            const sourceType = document.getElementById('gs-job-source').value;
            const depth = parseInt(document.getElementById('gs-job-depth').value);
            const name = document.getElementById('gs-job-name').value.trim();

            if (!name) {
                showToast('Please enter a job name', 'error');
                return;
            }
            if (!locationId && !keywordGroupId) {
                showToast('Please select at least a location or keyword group', 'error');
                return;
            }

            try {
                const createResponse = await fetchWithAuth('/api/v1/google-scraping/jobs', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        location_id: locationId ? parseInt(locationId) : null,
                        keyword_group_id: keywordGroupId ? parseInt(keywordGroupId) : null,
                        source_type: sourceType,
                        depth
                    })
                });

                if (!createResponse.ok) throw new Error('Failed to create job');
                const { job_id } = await createResponse.json();

                showToast('Job created, running...', 'success');
                document.getElementById('gs-job-name').value = '';

                const runResponse = await fetchWithAuth(`/api/v1/google-scraping/jobs/${job_id}/run`, {
                    method: 'POST'
                });

                if (!runResponse.ok) {
                    const error = await runResponse.json();
                    throw new Error(error.detail || 'Job execution failed');
                }

                const result = await runResponse.json();
                showToast(`Job completed! Found ${result.total_found || 0} results`, 'success');
                loadGoogleScrapingStats();
                loadGoogleScrapingJobs();
            } catch (error) {
                showToast('Job error: ' + error.message, 'error');
                loadGoogleScrapingJobs();
            }
        }

        async function runJob(jobId) {
            try {
                showToast('Running job...', 'success');
                const response = await fetchWithAuth(`/api/v1/google-scraping/jobs/${jobId}/run`, {
                    method: 'POST'
                });
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to run job');
                }
                const result = await response.json();
                showToast(`Job completed! Found ${result.total_found || 0} results`, 'success');
                loadGoogleScrapingJobs();
            } catch (error) {
                showToast('Run error: ' + error.message, 'error');
                loadGoogleScrapingJobs();
            }
        }

        async function runAllCities() {
            const keywordGroupId = document.getElementById('gs-job-keywords').value;
            const sourceType = document.getElementById('gs-job-source').value;
            const depth = parseInt(document.getElementById('gs-job-depth').value);

            if (!keywordGroupId) {
                showToast('Please select a keyword group first', 'error');
                return;
            }

            const cityLocations = gsLocations.filter(loc => loc.location_type === 'city');
            if (cityLocations.length === 0) {
                showToast('No city locations found', 'error');
                return;
            }

            const keywordGroup = gsKeywordGroups.find(kg => kg.id == keywordGroupId);
            const keywordName = keywordGroup?.name || 'Keywords';

            if (!confirm(`This will create and run ${cityLocations.length} jobs for all cities with "${keywordName}". Continue?`)) {
                return;
            }

            const progressDiv = document.getElementById('gs-batch-progress');
            const statusEl = document.getElementById('gs-batch-status');
            const countEl = document.getElementById('gs-batch-count');
            const barEl = document.getElementById('gs-batch-bar');
            const logEl = document.getElementById('gs-batch-log');

            progressDiv.style.display = 'block';
            logEl.innerHTML = '';
            let completed = 0;
            let failed = 0;
            let totalFound = 0;

            const addLog = (msg, type = 'info') => {
                const color = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#888';
                logEl.innerHTML += `<div style="color: ${color};">${new Date().toLocaleTimeString()}: ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            };

            for (let i = 0; i < cityLocations.length; i++) {
                const location = cityLocations[i];
                const jobName = `${location.name} - ${keywordName}`;

                statusEl.textContent = `Processing: ${location.name}`;
                countEl.textContent = `${i + 1}/${cityLocations.length}`;
                barEl.style.width = `${((i) / cityLocations.length) * 100}%`;

                addLog(`Creating job: ${jobName}`);

                try {
                    const createResponse = await fetchWithAuth('/api/v1/google-scraping/jobs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: jobName,
                            location_id: location.id,
                            keyword_group_id: parseInt(keywordGroupId),
                            source_type: sourceType,
                            depth
                        })
                    });

                    if (!createResponse.ok) throw new Error('Failed to create job');
                    const { job_id } = await createResponse.json();

                    addLog(`Running job for ${location.name}...`);

                    const runResponse = await fetchWithAuth(`/api/v1/google-scraping/jobs/${job_id}/run`, {
                        method: 'POST'
                    });

                    if (!runResponse.ok) {
                        const error = await runResponse.json();
                        throw new Error(error.detail || 'Job execution failed');
                    }

                    const result = await runResponse.json();
                    totalFound += result.total_found || 0;
                    completed++;
                    addLog(`Completed ${location.name}: ${result.total_found || 0} results`, 'success');
                } catch (error) {
                    failed++;
                    addLog(`Failed ${location.name}: ${error.message}`, 'error');
                }

                barEl.style.width = `${((i + 1) / cityLocations.length) * 100}%`;
            }

            statusEl.textContent = `Done! ${completed} completed, ${failed} failed`;
            countEl.textContent = `Total results: ${totalFound}`;
            barEl.style.width = '100%';
            barEl.style.background = failed > 0 ? '#f59e0b' : '#22c55e';

            showToast(`Batch complete: ${completed} jobs, ${totalFound} total results`, 'success');
            loadGoogleScrapingStats();
            loadGoogleScrapingJobs();
        }

        async function runAllKeywords() {
            const locationId = document.getElementById('gs-job-location').value;
            const sourceType = document.getElementById('gs-job-source').value;
            const depth = parseInt(document.getElementById('gs-job-depth').value);

            if (!locationId) {
                showToast('Please select a location first', 'error');
                return;
            }

            if (gsKeywordGroups.length === 0) {
                showToast('No keyword groups found', 'error');
                return;
            }

            const location = gsLocations.find(loc => loc.id == locationId);
            const locationName = location?.name || 'Selected Location';

            if (!confirm(`This will create and run ${gsKeywordGroups.length} jobs for "${locationName}" with ALL keyword groups. Continue?`)) {
                return;
            }

            const progressDiv = document.getElementById('gs-batch-progress');
            const statusEl = document.getElementById('gs-batch-status');
            const countEl = document.getElementById('gs-batch-count');
            const barEl = document.getElementById('gs-batch-bar');
            const logEl = document.getElementById('gs-batch-log');

            progressDiv.style.display = 'block';
            logEl.innerHTML = '';
            barEl.style.background = '#3b82f6';
            let completed = 0;
            let failed = 0;
            let totalFound = 0;

            const addLog = (msg, type = 'info') => {
                const color = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#888';
                logEl.innerHTML += `<div style="color: ${color};">${new Date().toLocaleTimeString()}: ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            };

            for (let i = 0; i < gsKeywordGroups.length; i++) {
                const keywordGroup = gsKeywordGroups[i];
                const jobName = `${locationName} - ${keywordGroup.name}`;

                statusEl.textContent = `Processing: ${keywordGroup.name}`;
                countEl.textContent = `${i + 1}/${gsKeywordGroups.length}`;
                barEl.style.width = `${((i) / gsKeywordGroups.length) * 100}%`;

                addLog(`Creating job: ${jobName}`);

                try {
                    const createResponse = await fetchWithAuth('/api/v1/google-scraping/jobs', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: jobName,
                            location_id: parseInt(locationId),
                            keyword_group_id: keywordGroup.id,
                            source_type: sourceType,
                            depth
                        })
                    });

                    if (!createResponse.ok) throw new Error('Failed to create job');
                    const { job_id } = await createResponse.json();

                    addLog(`Running job for ${keywordGroup.name}...`);

                    const runResponse = await fetchWithAuth(`/api/v1/google-scraping/jobs/${job_id}/run`, {
                        method: 'POST'
                    });

                    if (!runResponse.ok) {
                        const error = await runResponse.json();
                        throw new Error(error.detail || 'Job execution failed');
                    }

                    const result = await runResponse.json();
                    totalFound += result.total_found || 0;
                    completed++;
                    addLog(`Completed ${keywordGroup.name}: ${result.total_found || 0} results`, 'success');
                } catch (error) {
                    failed++;
                    addLog(`Failed ${keywordGroup.name}: ${error.message}`, 'error');
                }

                barEl.style.width = `${((i + 1) / gsKeywordGroups.length) * 100}%`;
            }

            statusEl.textContent = `Done! ${completed} completed, ${failed} failed`;
            countEl.textContent = `Total results: ${totalFound}`;
            barEl.style.width = '100%';
            barEl.style.background = failed > 0 ? '#f59e0b' : '#22c55e';

            showToast(`Batch complete: ${completed} jobs, ${totalFound} total results`, 'success');
            loadGoogleScrapingStats();
            loadGoogleScrapingJobs();
        }

        async function runFullSweep() {
            const sourceType = document.getElementById('gs-job-source').value;
            const depth = parseInt(document.getElementById('gs-job-depth').value);

            const cityLocations = gsLocations.filter(loc => loc.location_type === 'city');
            if (cityLocations.length === 0) {
                showToast('No city locations found', 'error');
                return;
            }

            if (gsKeywordGroups.length === 0) {
                showToast('No keyword groups found', 'error');
                return;
            }

            const totalJobs = cityLocations.length * gsKeywordGroups.length;
            if (!confirm(`This will create and run ${totalJobs} jobs (${cityLocations.length} cities  ${gsKeywordGroups.length} keyword groups) with depth ${depth}.\n\nThis may take a while and use API credits. Continue?`)) {
                return;
            }

            const progressDiv = document.getElementById('gs-batch-progress');
            const statusEl = document.getElementById('gs-batch-status');
            const countEl = document.getElementById('gs-batch-count');
            const barEl = document.getElementById('gs-batch-bar');
            const logEl = document.getElementById('gs-batch-log');

            progressDiv.style.display = 'block';
            logEl.innerHTML = '';
            barEl.style.background = '#dc2626';
            let completed = 0;
            let failed = 0;
            let totalFound = 0;
            let current = 0;

            const addLog = (msg, type = 'info') => {
                const color = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#888';
                logEl.innerHTML += `<div style="color: ${color};">${new Date().toLocaleTimeString()}: ${msg}</div>`;
                logEl.scrollTop = logEl.scrollHeight;
            };

            addLog(`Starting full sweep: ${cityLocations.length} cities  ${gsKeywordGroups.length} keywords = ${totalJobs} jobs`);

            for (let c = 0; c < cityLocations.length; c++) {
                const location = cityLocations[c];
                addLog(`--- City ${c + 1}/${cityLocations.length}: ${location.name} ---`);

                for (let k = 0; k < gsKeywordGroups.length; k++) {
                    const keywordGroup = gsKeywordGroups[k];
                    const jobName = `${location.name} - ${keywordGroup.name}`;
                    current++;

                    statusEl.textContent = `${location.name} - ${keywordGroup.name}`;
                    countEl.textContent = `${current}/${totalJobs}`;
                    barEl.style.width = `${((current - 1) / totalJobs) * 100}%`;

                    try {
                        const createResponse = await fetchWithAuth('/api/v1/google-scraping/jobs', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: jobName,
                                location_id: location.id,
                                keyword_group_id: keywordGroup.id,
                                source_type: sourceType,
                                depth
                            })
                        });

                        if (!createResponse.ok) throw new Error('Failed to create job');
                        const { job_id } = await createResponse.json();

                        const runResponse = await fetchWithAuth(`/api/v1/google-scraping/jobs/${job_id}/run`, {
                            method: 'POST'
                        });

                        if (!runResponse.ok) {
                            const error = await runResponse.json();
                            throw new Error(error.detail || 'Job execution failed');
                        }

                        const result = await runResponse.json();
                        totalFound += result.total_found || 0;
                        completed++;
                        addLog(`${keywordGroup.name}: ${result.total_found || 0} results`, 'success');
                    } catch (error) {
                        failed++;
                        addLog(`${keywordGroup.name}: ${error.message}`, 'error');
                    }

                    barEl.style.width = `${(current / totalJobs) * 100}%`;
                }
            }

            statusEl.textContent = `Done! ${completed} completed, ${failed} failed`;
            countEl.textContent = `Total results: ${totalFound}`;
            barEl.style.width = '100%';
            barEl.style.background = failed > 0 ? '#f59e0b' : '#22c55e';

            showToast(`Full sweep complete: ${completed}/${totalJobs} jobs, ${totalFound} total results`, 'success');
            loadGoogleScrapingStats();
            loadGoogleScrapingJobs();
        }

        async function viewJobResults(jobId) {
            console.log('viewJobResults called with jobId:', jobId);
            try {
                const response = await fetchWithAuth(`/api/v1/google-scraping/jobs/${jobId}`);
                console.log('Response status:', response.status);
                const job = await response.json();
                console.log('Job data:', job);
                gsSelectedJobId = jobId;
                
                const panel = document.getElementById('gs-results-panel');
                const content = document.getElementById('gs-results-content');
                
                if (!panel) {
                    console.error('gs-results-panel not found!');
                    showToast('Results panel not found', 'error');
                    return;
                }
                
                panel.style.display = 'block';
                panel.scrollIntoView({ behavior: 'smooth' });
                
                if (!job.results || job.results.length === 0) {
                    content.innerHTML = '<div style="color: var(--stone-500);">No results found for this job.</div>';
                    return;
                }

                if (job.source_type === 'google_maps_reviews') {
                    content.innerHTML = job.results.map(r => `
                        <div style="background: var(--stone-50); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 8px;">
                                ${r.place?.title || r.place?.name || 'Unknown Place'}
                            </div>
                            <div style="font-size: 13px; color: var(--stone-500); margin-bottom: 12px;">
                                ${r.place?.address || ''} | Keyword: "${r.keyword}"
                            </div>
                            ${r.reviews && r.reviews.length > 0 ? `
                                <div style="font-size: 12px; font-weight: 500; margin-bottom: 8px;">Reviews (${r.reviews.length}):</div>
                                ${r.reviews.slice(0, 3).map(rev => `
                                    <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px; font-size: 13px;">
                                        <div style="color: var(--amber-500);">${''.repeat(rev.rating || 0)}</div>
                                        <div style="color: var(--stone-600);">${rev.snippet || rev.text || 'No text'}</div>
                                    </div>
                                `).join('')}
                                ${r.reviews.length > 3 ? `<div style="color: var(--stone-400); font-size: 12px;">+${r.reviews.length - 3} more reviews</div>` : ''}
                            ` : '<div style="color: var(--stone-400); font-size: 13px;">No reviews</div>'}
                        </div>
                    `).join('');
                } else {
                    content.innerHTML = job.results.map(r => `
                        <div style="background: var(--stone-50); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">Keyword: "${r.keyword}"</div>
                            ${r.results?.slice(0, 5).map(res => `
                                <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                                    <a href="${res.link}" target="_blank" style="font-weight: 500; color: var(--blue-600);">${res.title}</a>
                                    <div style="font-size: 13px; color: var(--stone-600);">${res.snippet || ''}</div>
                                </div>
                            `).join('') || '<div style="color: var(--stone-400);">No results</div>'}
                        </div>
                    `).join('');
                }
            } catch (error) {
                showToast('Failed to load results: ' + error.message, 'error');
            }
        }

        function closeResultsPanel() {
            document.getElementById('gs-results-panel').style.display = 'none';
            gsSelectedJobId = null;
        }

        function exportJobResults() {
            showToast('Export feature coming soon', 'info');
        }

        function showAddLocationModal() {
            const modal = document.getElementById('modal-container');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>Add Location</h3>
                            <button class="modal-close" onclick="closeModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Location Name *</label>
                                <input type="text" id="new-loc-name" placeholder="e.g., Austin, TX" class="form-input">
                            </div>
                            <div class="form-group">
                                <label>Type</label>
                                <select id="new-loc-type" class="form-select">
                                    <option value="city">City</option>
                                    <option value="neighborhood">Neighborhood</option>
                                    <option value="zip_code">ZIP Code</option>
                                    <option value="business_district">Business District</option>
                                </select>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                <div class="form-group">
                                    <label>Latitude</label>
                                    <input type="number" step="any" id="new-loc-lat" placeholder="30.2672" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label>Longitude</label>
                                    <input type="number" step="any" id="new-loc-lng" placeholder="-97.7431" class="form-input">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Search Radius (km)</label>
                                <input type="number" id="new-loc-radius" value="5" class="form-input">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveNewLocation()">Add Location</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveNewLocation() {
            const name = document.getElementById('new-loc-name').value.trim();
            const locationType = document.getElementById('new-loc-type').value;
            const lat = document.getElementById('new-loc-lat').value;
            const lng = document.getElementById('new-loc-lng').value;
            const radius = document.getElementById('new-loc-radius').value;

            if (!name) {
                showToast('Location name is required', 'error');
                return;
            }

            try {
                const response = await fetchWithAuth('/api/v1/google-scraping/locations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        location_type: locationType,
                        latitude: lat ? parseFloat(lat) : null,
                        longitude: lng ? parseFloat(lng) : null,
                        radius_km: radius ? parseFloat(radius) : 5
                    })
                });

                if (!response.ok) throw new Error('Failed to create location');
                showToast('Location added successfully', 'success');
                closeModal();
                loadGoogleScrapingLocations();
                populateJobDropdowns();
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function deleteLocation(id) {
            if (!confirm('Delete this location?')) return;
            try {
                const response = await fetchWithAuth(`/api/v1/google-scraping/locations/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete');
                showToast('Location deleted', 'success');
                loadGoogleScrapingLocations();
                populateJobDropdowns();
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function seedLocations() {
            if (!confirm('This will add all major US cities and neighborhoods from the keyword matrix. Continue?')) return;
            try {
                const response = await fetchWithAuth('/api/v1/google-scraping/locations/seed', { method: 'POST' });
                if (!response.ok) throw new Error('Failed to seed locations');
                const result = await response.json();
                showToast(`Added ${result.added} locations (${result.skipped} already existed)`, 'success');
                loadGoogleScrapingLocations();
                populateJobDropdowns();
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        function showAddKeywordGroupModal() {
            const modal = document.getElementById('modal-container');
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeModal()">
                    <div class="modal" onclick="event.stopPropagation()">
                        <div class="modal-header">
                            <h3>Add Keyword Group</h3>
                            <button class="modal-close" onclick="closeModal()"></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label>Group Name *</label>
                                <input type="text" id="new-kw-name" placeholder="e.g., Parking Pain Points" class="form-input">
                            </div>
                            <div class="form-group">
                                <label>Category</label>
                                <input type="text" id="new-kw-category" placeholder="e.g., Transportation" class="form-input">
                            </div>
                            <div class="form-group">
                                <label>Keywords * (one per line)</label>
                                <textarea id="new-kw-keywords" rows="6" placeholder="parking is terrible&#10;can't find parking&#10;parking too expensive" class="form-textarea" style="width: 100%;"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Match Type</label>
                                <select id="new-kw-match" class="form-select">
                                    <option value="phrase">Phrase Match</option>
                                    <option value="exact">Exact Match</option>
                                    <option value="broad">Broad Match</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                            <button class="btn-primary" onclick="saveNewKeywordGroup()">Add Group</button>
                        </div>
                    </div>
                </div>
            `;
        }

        async function saveNewKeywordGroup() {
            const name = document.getElementById('new-kw-name').value.trim();
            const category = document.getElementById('new-kw-category').value.trim();
            const keywordsText = document.getElementById('new-kw-keywords').value;
            const matchType = document.getElementById('new-kw-match').value;

            const keywords = keywordsText.split('\n').map(k => k.trim()).filter(k => k);

            if (!name) {
                showToast('Group name is required', 'error');
                return;
            }
            if (keywords.length === 0) {
                showToast('At least one keyword is required', 'error');
                return;
            }

            try {
                const response = await fetchWithAuth('/api/v1/google-scraping/keyword-groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name,
                        category: category || null,
                        keywords,
                        match_type: matchType
                    })
                });

                if (!response.ok) throw new Error('Failed to create keyword group');
                showToast('Keyword group added successfully', 'success');
                closeModal();
                loadGoogleScrapingKeywords();
                populateJobDropdowns();
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function deleteKeywordGroup(id) {
            if (!confirm('Delete this keyword group?')) return;
            try {
                const response = await fetchWithAuth(`/api/v1/google-scraping/keyword-groups/${id}`, { method: 'DELETE' });
                if (!response.ok) throw new Error('Failed to delete');
                showToast('Keyword group deleted', 'success');
                loadGoogleScrapingKeywords();
                populateJobDropdowns();
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Event listeners for Google Scraping
        document.getElementById('gs-location-search')?.addEventListener('input', debounce(() => loadGoogleScrapingLocations(), 300));
        document.getElementById('gs-keyword-search')?.addEventListener('input', debounce(() => loadGoogleScrapingKeywords(), 300));
        document.getElementById('gs-job-status-filter')?.addEventListener('change', () => loadGoogleScrapingJobs());

        // ===== END GOOGLE SCRAPING FUNCTIONS =====

        // ===== CONSULTANT STUDIO ANALYTICS =====
        async function loadConsultantAnalytics() {
            const days = document.getElementById('cs-days-filter')?.value || 30;
            
            try {
                const response = await fetchWithAuth(`/api/v1/consultant/admin/analytics?days=${days}`);
                if (!response.ok) throw new Error('Failed to load analytics');
                const data = await response.json();
                
                document.getElementById('cs-stat-activities').textContent = data.summary?.total_activities || 0;
                document.getElementById('cs-stat-users').textContent = data.summary?.unique_users || 0;
                document.getElementById('cs-stat-ideas').textContent = data.top_ideas_validated?.length || 0;
                document.getElementById('cs-stat-locations').textContent = data.top_locations_searched?.length || 0;
                
                const pathBreakdown = document.getElementById('cs-path-breakdown');
                if (data.path_breakdown && data.path_breakdown.length > 0) {
                    const total = data.path_breakdown.reduce((sum, item) => sum + item.count, 0);
                    const pathMap = {
                        'validate_idea': 'Validate Idea',
                        'search_ideas': 'Search Ideas',
                        'identify_location': 'Identify Location'
                    };
                    pathBreakdown.innerHTML = `
                        <div class="stats-grid" style="margin-bottom: 0;">
                            ${data.path_breakdown.map(item => `
                                <div class="stat-card" style="text-align: center;">
                                    <div class="stat-label">${pathMap[item.path] || item.path}</div>
                                    <div class="stat-value">${item.count}</div>
                                    <div style="color: var(--stone-500); font-size: 12px;">${((item.count/total)*100).toFixed(1)}%</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    pathBreakdown.innerHTML = '<div class="loading">No activity data yet</div>';
                }
                
                const ideasBody = document.getElementById('cs-top-ideas-body');
                if (data.top_ideas_validated && data.top_ideas_validated.length > 0) {
                    ideasBody.innerHTML = data.top_ideas_validated.map(idea => `
                        <tr>
                            <td style="max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${escapeHtml(idea.idea || '')}">${escapeHtml(idea.idea || 'N/A')}</td>
                            <td><span class="status-badge ${idea.result === 'success' ? 'active' : 'inactive'}">${idea.result || '-'}</span></td>
                            <td>${idea.count}</td>
                        </tr>
                    `).join('');
                } else {
                    ideasBody.innerHTML = '<tr><td colspan="3" class="loading">No ideas validated yet</td></tr>';
                }
                
                const locationsBody = document.getElementById('cs-top-locations-body');
                if (data.top_locations_searched && data.top_locations_searched.length > 0) {
                    locationsBody.innerHTML = data.top_locations_searched.map(loc => `
                        <tr>
                            <td>${escapeHtml(loc.city || 'Unknown')}</td>
                            <td>${escapeHtml(loc.business_type || 'Any')}</td>
                            <td>${loc.count}</td>
                        </tr>
                    `).join('');
                } else {
                    locationsBody.innerHTML = '<tr><td colspan="3" class="loading">No location searches yet</td></tr>';
                }
                
                const leadsBody = document.getElementById('cs-leads-body');
                if (data.potential_leads && data.potential_leads.length > 0) {
                    leadsBody.innerHTML = data.potential_leads.map(lead => {
                        const pathsArray = lead.paths_used ? lead.paths_used.split(', ') : [];
                        return `
                            <tr>
                                <td>${escapeHtml(lead.name || 'Anonymous')}</td>
                                <td>${escapeHtml(lead.email || 'N/A')}</td>
                                <td><strong>${lead.activity_count}</strong></td>
                                <td>${pathsArray.map(p => `<span class="status-badge">${p.trim()}</span>`).join(' ')}</td>
                                <td>${formatDate(lead.last_activity)}</td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    leadsBody.innerHTML = '<tr><td colspan="5" class="loading">No high-engagement users yet</td></tr>';
                }
                
                const activitiesBody = document.getElementById('cs-activities-body');
                if (data.recent_activities && data.recent_activities.length > 0) {
                    activitiesBody.innerHTML = data.recent_activities.map(act => `
                        <tr>
                            <td>User #${act.user_id}</td>
                            <td><span class="status-badge">${act.path || '-'}</span></td>
                            <td><span class="status-badge ${act.result_summary === 'success' ? 'active' : act.result_summary === 'error' ? 'banned' : 'inactive'}">${act.result_summary || '-'}</span></td>
                            <td>${act.processing_time_ms ? (act.processing_time_ms / 1000).toFixed(1) + 's' : '-'}</td>
                            <td>${formatDate(act.created_at)}</td>
                        </tr>
                    `).join('');
                } else {
                    activitiesBody.innerHTML = '<tr><td colspan="5" class="loading">No activities yet</td></tr>';
                }
                
            } catch (error) {
                console.error('Failed to load consultant analytics:', error);
                showToast('Failed to load Consultant Studio analytics', 'error');
            }
        }

        document.getElementById('cs-days-filter')?.addEventListener('change', () => loadConsultantAnalytics());
        // ===== END CONSULTANT STUDIO ANALYTICS =====

        init();
    </script>
</body>
</html>
