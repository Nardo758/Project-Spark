<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>On-Demand Home Maintenance · OppGrid</title>
    <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap&family=Roboto+Mono:wght@700" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --stone-50: #fafaf9;
            --stone-100: #f5f5f4;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-400: #a8a29e;
            --stone-500: #78716c;
            --stone-600: #57534e;
            --stone-700: #44403c;
            --stone-800: #292524;
            --stone-900: #1c1917;
            --emerald-100: #d1fae5;
            --emerald-600: #475569;
            --emerald-700: #047857;
            --amber-50: #fffbeb;
            --amber-100: #fef3c7;
            --amber-200: #fde68a;
            --amber-700: #b45309;
            --white: #ffffff;
            --violet-500: #44403c;
            --violet-600: #1c1917;
            --violet-100: #f3e8ff;
        }

        [data-theme="dark"] {
            --stone-50: #1c1917;
            --stone-100: #292524;
            --stone-200: #44403c;
            --stone-300: #57534e;
            --stone-400: #78716c;
            --stone-500: #a8a29e;
            --stone-600: #d6d3d1;
            --stone-700: #e7e5e4;
            --stone-800: #f5f5f4;
            --stone-900: #fafaf9;
            --white: #1c1917;
            --emerald-100: #064e3b;
            --violet-100: #2e1065;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--stone-50);
            color: var(--stone-900);
            min-height: 100vh;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .spektral {
            font-family: 'Spectral', serif;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }

        .slide-in {
            animation: slideIn 0.4s ease-out forwards;
        }

        .stagger-1 { animation-delay: 0.1s; opacity: 0; }
        .stagger-2 { animation-delay: 0.2s; opacity: 0; }
        .stagger-3 { animation-delay: 0.3s; opacity: 0; }
        .stagger-4 { animation-delay: 0.4s; opacity: 0; }

        /* Header */
        .header {
            border-bottom: 1px solid var(--stone-200);
            background: var(--white);
        }

        .header-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .logo {
            font-family: 'Spectral', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--stone-900);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            color: #d97757;
        }

        .logo-text-group {
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .logo-text {
            font-family: 'Spectral', serif;
            font-size: 24px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .logo-tagline {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            font-weight: 500;
            color: var(--stone-500);
            letter-spacing: 0.02em;
        }

        .header-nav {
            display: flex;
            gap: 8px;
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 8px;
            color: var(--stone-500);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-link:hover {
            background: var(--stone-100);
            color: var(--stone-900);
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--stone-200);
            background: var(--white);
            color: var(--stone-700);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--stone-100);
        }

        .btn-primary {
            background: var(--violet-600);
            color: var(--white);
            border-color: var(--stone-900);
        }

        .btn-primary:hover {
            background: var(--stone-800);
        }

        /* Page Header */
        .page-header {
            border-bottom: 1px solid var(--stone-200);
            background: var(--white);
            padding: 24px 0;
        }

        .page-header-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .page-header-left {
            flex: 1;
        }

        .page-header-meta {
            font-size: 12px;
            font-weight: 500;
            color: var(--stone-500);
            margin-bottom: 4px;
        }

        .page-header h1 {
            font-family: 'Spectral', serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .validation-score {
            text-align: right;
        }

        .validation-score-label {
            font-size: 11px;
            color: var(--stone-500);
            margin-bottom: 2px;
        }

        .validation-score-value {
            font-family: 'Spectral', serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--emerald-600);
        }

        /* Tier Navigation */
        .tier-nav {
            border-bottom: 1px solid var(--stone-200);
            background: var(--white);
            position: relative;
        }

        .tier-nav::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--stone-900), var(--stone-500));
            transition: width 0.3s ease;
        }

        .tier-nav.tier-detail::after { width: 33.33%; }
        .tier-nav.tier-research::after { width: 66.66%; }
        .tier-nav.tier-deep::after { width: 100%; }

        .tier-nav-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 32px;
            display: flex;
            gap: 32px;
        }

        .tier-tab {
            padding: 16px 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--stone-500);
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tier-tab:hover {
            color: var(--stone-700);
        }

        .tier-tab.active {
            color: var(--stone-900);
            border-bottom-color: var(--stone-900);
        }

        .tier-tab .lock-icon {
            width: 12px;
            height: 12px;
            color: var(--stone-400);
        }

        .tier-tab.locked {
            color: var(--stone-400);
            cursor: not-allowed;
        }

        .tier-tab.locked:hover {
            color: var(--stone-400);
        }

        /* Main Content */
        .main-content {
            max-width: 1280px;
            margin: 0 auto;
            padding: 48px 32px;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            margin-bottom: 32px;
        }

        .metric-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--stone-200);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .metric-icon {
            width: 20px;
            height: 20px;
            color: var(--stone-600);
        }

        .metric-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--stone-500);
        }

        .metric-value {
            font-family: 'Spectral', serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .metric-change {
            font-size: 14px;
            color: var(--emerald-600);
            margin-top: 4px;
        }

        .metric-change.neutral {
            color: var(--stone-600);
        }

        /* Content Card */
        .content-card {
            background: var(--white);
            border-radius: 12px;
            padding: 32px;
            border: 1px solid var(--stone-200);
            margin-bottom: 24px;
        }

        .content-card h2 {
            font-family: 'Spectral', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--stone-900);
            margin-bottom: 16px;
        }

        .content-card p {
            color: var(--stone-700);
            font-size: 16px;
            line-height: 1.7;
        }

        /* Pain Points */
        .pain-point {
            border-left: 4px solid var(--stone-900);
            padding-left: 16px;
            padding-top: 8px;
            padding-bottom: 8px;
            margin-bottom: 16px;
        }

        .pain-point:last-child {
            margin-bottom: 0;
        }

        .pain-point-quote {
            color: var(--stone-700);
            font-style: italic;
            margin-bottom: 4px;
        }

        .pain-point-severity {
            font-size: 12px;
            font-weight: 500;
            color: var(--stone-500);
        }

        /* Related Opportunities */
        .related-list {
            list-style: none;
        }

        .related-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--stone-100);
            cursor: pointer;
            transition: all 0.2s;
        }

        .related-item:last-child {
            border-bottom: none;
        }

        .related-item:hover {
            background: var(--stone-50);
            margin-left: -16px;
            margin-right: -16px;
            padding-left: 16px;
            padding-right: 16px;
        }

        .related-item span {
            color: var(--stone-700);
        }

        .related-item svg {
            width: 16px;
            height: 16px;
            color: var(--stone-400);
        }

        /* CTA Banner */
        .cta-banner {
            background: linear-gradient(135deg, var(--stone-900) 0%, var(--stone-700) 100%);
            border-radius: 12px;
            padding: 32px;
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 32px;
        }

        .cta-banner h3 {
            font-family: 'Spectral', serif;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .cta-banner p {
            font-size: 14px;
            opacity: 0.8;
        }

        .btn-white {
            background: var(--white);
            color: var(--stone-900);
            border: none;
            padding: 12px 24px;
            font-size: 15px;
        }

        .btn-white:hover {
            background: var(--stone-100);
        }

        /* Locked Content */
        .locked-overlay {
            position: relative;
            background: var(--white);
            border-radius: 12px;
            padding: 32px;
            border: 1px solid var(--stone-200);
            margin-bottom: 24px;
            overflow: hidden;
        }

        .locked-overlay::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, transparent 0%, var(--white) 60%);
            z-index: 1;
        }

        .locked-content {
            filter: blur(4px);
            opacity: 0.5;
        }

        .locked-message {
            position: absolute;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 2;
            text-align: center;
        }

        .locked-message svg {
            width: 32px;
            height: 32px;
            color: var(--stone-400);
            margin-bottom: 8px;
        }

        .locked-message p {
            color: var(--stone-600);
            margin-bottom: 16px;
        }

        /* Geographic Selector */
        .geo-section {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--stone-200);
            margin-bottom: 24px;
        }

        .geo-section h2 {
            font-family: 'Spectral', serif;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .geo-section h2 svg {
            width: 20px;
            height: 20px;
            color: var(--stone-500);
        }

        .geo-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .geo-tab {
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid var(--stone-200);
            background: var(--white);
            color: var(--stone-600);
        }

        .geo-tab:hover {
            background: var(--stone-100);
        }

        .geo-tab.active {
            background: var(--violet-600);
            color: var(--white);
            border-color: var(--stone-900);
        }

        .geo-tab.recommended {
            border-color: var(--emerald-600);
            position: relative;
        }

        .geo-tab.recommended::after {
            content: '★';
            margin-left: 4px;
            color: var(--emerald-600);
        }

        .geo-tab.recommended.active::after {
            color: var(--emerald-100);
        }

        .geo-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .geo-metric {
            text-align: center;
            padding: 12px;
            background: var(--stone-50);
            border-radius: 8px;
        }

        .geo-metric-label {
            font-size: 11px;
            color: var(--stone-500);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .geo-metric-value {
            font-size: 18px;
            font-weight: 600;
            color: var(--stone-900);
        }

        .geo-metric-value.growth {
            color: var(--emerald-600);
        }

        .geo-assessment {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--stone-50);
            border-radius: 8px;
            border-left: 4px solid var(--stone-900);
        }

        .geo-assessment.very-high {
            border-left-color: var(--emerald-600);
            background: var(--emerald-100);
        }

        .geo-assessment.high {
            border-left-color: #64748B;
            background: #eff6ff;
        }

        .geo-assessment.medium {
            border-left-color: var(--amber-700);
            background: var(--amber-50);
        }

        .applicability-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .applicability-badge.very-high {
            background: var(--emerald-600);
            color: var(--white);
        }

        .applicability-badge.high {
            background: #64748B;
            color: var(--white);
        }

        .applicability-badge.medium {
            background: var(--amber-700);
            color: var(--white);
        }

        .geo-recommendation {
            flex: 1;
            font-size: 14px;
            color: var(--stone-700);
        }

        /* Tier 2 Geographic Distribution */
        .geo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .geo-card {
            background: var(--stone-50);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--stone-200);
        }

        .geo-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .geo-card-title {
            font-weight: 600;
            font-size: 14px;
        }

        .geo-card-stats {
            display: grid;
            gap: 8px;
        }

        .geo-card-stat {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .geo-card-stat-label {
            color: var(--stone-500);
        }

        .geo-card-stat-value {
            font-weight: 500;
            color: var(--stone-900);
        }

        /* Launch Strategy */
        .launch-phases {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .launch-phase {
            display: flex;
            gap: 16px;
            padding: 20px;
            background: var(--white);
            border-radius: 8px;
            border: 1px solid var(--stone-200);
        }

        .phase-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--violet-600);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .phase-content {
            flex: 1;
        }

        .phase-title {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .phase-description {
            font-size: 13px;
            color: var(--stone-600);
            margin-bottom: 8px;
        }

        .phase-cities {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .phase-city {
            padding: 3px 8px;
            background: var(--stone-100);
            border-radius: 4px;
            font-size: 11px;
            color: var(--stone-600);
        }

        /* Research Dashboard Tabs */
        .research-tabs-container {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--stone-200);
            overflow: hidden;
        }

        .research-tabs-nav {
            display: flex;
            border-bottom: 1px solid var(--stone-200);
        }

        .research-tab {
            flex: 1;
            padding: 16px 12px;
            font-size: 13px;
            font-weight: 500;
            color: var(--stone-500);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .research-tab:hover {
            color: var(--stone-700);
            background: var(--stone-50);
        }

        .research-tab.active {
            color: var(--stone-900);
            border-bottom-color: var(--stone-900);
        }

        .research-tab svg {
            width: 16px;
            height: 16px;
        }

        .research-tab-content {
            padding: 32px;
        }

        .research-panel {
            display: none;
        }

        .research-panel.active {
            display: block;
        }

        /* Research Dashboard Content Styles */
        .research-section-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--stone-500);
            margin-bottom: 16px;
        }

        .research-grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 24px;
        }

        .research-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .research-stat-label {
            color: var(--stone-700);
            font-size: 14px;
        }

        .research-stat-value {
            font-family: 'Spectral', serif;
            font-weight: 700;
            color: var(--stone-900);
        }

        .research-stat-value.growth {
            color: var(--emerald-600);
        }

        .competitor-card {
            padding: 16px;
            background: var(--stone-50);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .competitor-card:last-child {
            margin-bottom: 0;
        }

        .competitor-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .competitor-name {
            font-weight: 500;
            color: var(--stone-900);
        }

        .competitor-share {
            font-size: 12px;
            font-weight: 500;
            color: var(--stone-500);
        }

        .competitor-weakness {
            font-size: 14px;
            color: var(--stone-600);
        }

        /* Geographic Region Card */
        .region-card {
            padding: 20px;
            border-radius: 8px;
            border: 2px solid var(--stone-200);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .region-card:hover {
            border-color: var(--stone-300);
        }

        .region-card.selected {
            border-color: var(--stone-900);
            background: var(--stone-50);
        }

        .region-card:last-child {
            margin-bottom: 0;
        }

        .region-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .region-title {
            font-weight: 600;
            color: var(--stone-900);
            margin-bottom: 4px;
        }

        .region-market-size {
            text-align: right;
        }

        .region-market-label {
            font-size: 11px;
            color: var(--stone-500);
        }

        .region-market-value {
            font-family: 'Spectral', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .region-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 12px;
        }

        .region-stat-label {
            font-size: 11px;
            color: var(--stone-500);
        }

        .region-stat-value {
            font-family: 'Spectral', serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .region-cities {
            padding-top: 12px;
            border-top: 1px solid var(--stone-200);
        }

        .region-cities-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--stone-500);
            margin-bottom: 8px;
        }

        .region-cities-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .region-city-tag {
            padding: 4px 8px;
            background: var(--stone-100);
            border-radius: 4px;
            font-size: 12px;
            color: var(--stone-700);
        }

        /* Launch Strategy Box */
        .launch-strategy-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }

        .launch-strategy-title {
            font-size: 14px;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .launch-phase-card {
            background: var(--white);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .launch-phase-card:last-child {
            margin-bottom: 0;
        }

        .launch-phase-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .launch-phase-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            color: var(--white);
        }

        .launch-phase-number.phase-1 { background: #475569; }
        .launch-phase-number.phase-2 { background: #64748B; }
        .launch-phase-number.phase-3 { background: #1c1917; }

        .launch-phase-name {
            font-weight: 600;
            color: var(--stone-900);
        }

        .launch-phase-desc {
            font-size: 14px;
            color: var(--stone-700);
            padding-left: 32px;
        }

        /* Pain Point Card */
        .pain-card {
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .pain-card:last-child {
            margin-bottom: 0;
        }

        .pain-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .pain-category {
            font-weight: 500;
            color: var(--stone-900);
        }

        .pain-severity {
            text-align: right;
        }

        .pain-severity-label {
            font-size: 11px;
            color: var(--stone-500);
        }

        .pain-severity-value {
            font-family: 'Spectral', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .pain-quote {
            font-size: 14px;
            color: var(--stone-600);
            margin-bottom: 4px;
        }

        .pain-mentions {
            font-size: 12px;
            color: var(--stone-500);
        }

        /* Opportunity Sizing */
        .tam-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .tam-card {
            background: var(--stone-50);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .tam-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--stone-500);
            margin-bottom: 8px;
        }

        .tam-value {
            font-family: 'Spectral', serif;
            font-size: 32px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .tam-desc {
            font-size: 13px;
            color: var(--stone-600);
            margin-top: 4px;
        }

        /* Pricing Tier */
        .pricing-tier {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .pricing-tier:last-child {
            margin-bottom: 0;
        }

        .pricing-tier-name {
            font-weight: 500;
            color: var(--stone-900);
        }

        .pricing-tier-adoption {
            font-size: 14px;
            color: var(--stone-600);
        }

        .pricing-tier-price {
            font-family: 'Spectral', serif;
            font-size: 20px;
            font-weight: 700;
            color: var(--stone-900);
        }

        /* Feature Priority */
        .feature-priority {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--stone-50);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .feature-priority:last-child {
            margin-bottom: 0;
        }

        .feature-priority-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--violet-600);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Spectral', serif;
            font-weight: 700;
            flex-shrink: 0;
        }

        .feature-priority-content {
            flex: 1;
        }

        .feature-priority-name {
            font-weight: 500;
            color: var(--stone-900);
        }

        .feature-priority-mentions {
            font-size: 14px;
            color: var(--stone-600);
        }

        /* AI Chat */
        .ai-chat-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--violet-600);
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: transform 0.2s;
        }

        .ai-chat-toggle:hover {
            transform: scale(1.05);
        }

        .ai-chat-toggle svg {
            width: 24px;
            height: 24px;
        }

        .ai-chat-panel {
            position: fixed;
            bottom: 96px;
            right: 24px;
            width: 380px;
            max-height: 500px;
            background: var(--white);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .ai-chat-panel.open {
            display: flex;
        }

        .ai-chat-header {
            padding: 24px;
            background: linear-gradient(135deg, #1c1917, #292524);
            color: white;
            border-radius: 16px 16px 0 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ai-chat-header-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
        }

        .ai-chat-header-title {
            font-family: 'Spectral', serif;
            font-weight: 700;
            font-size: 18px;
            color: white;
        }

        .ai-chat-header-subtitle {
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        .ai-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 350px;
        }

        .ai-message {
            padding: 12px;
            border-radius: 12px;
            font-size: 13px;
            line-height: 1.5;
        }

        .ai-message.ai {
            background: var(--stone-100);
            align-self: flex-start;
            max-width: 90%;
        }

        .ai-message.user {
            background: var(--violet-600);
            color: var(--white);
            align-self: flex-end;
            max-width: 80%;
        }

        .ai-suggestions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
        }

        .ai-suggestion {
            padding: 8px 12px;
            background: var(--white);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .ai-suggestion:hover {
            background: var(--stone-50);
            border-color: var(--stone-300);
        }

        .ai-chat-input {
            padding: 12px;
            border-top: 1px solid var(--stone-200);
            display: flex;
            gap: 8px;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            font-size: 13px;
            outline: none;
        }

        .ai-chat-input input:focus {
            border-color: var(--stone-400);
        }

        .ai-chat-input button {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: var(--violet-600);
            color: var(--white);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .geo-metrics {
                grid-template-columns: repeat(2, 1fr);
            }

            .geo-grid {
                grid-template-columns: 1fr;
            }

            .cta-banner {
                flex-direction: column;
                gap: 24px;
                text-align: center;
            }

            .page-header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .validation-score {
                text-align: left;
            }

            .ai-chat-panel {
                width: calc(100% - 48px);
                right: 24px;
                left: 24px;
            }
        }

        /* Deep Dive Hybrid Console Styles */
        .deep-dive-console {
            display: flex;
            height: calc(100vh - 200px);
            min-height: 600px;
            background: var(--stone-50);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--stone-200);
        }

        .deep-dive-sidebar {
            width: 320px;
            background: var(--white);
            border-right: 1px solid var(--stone-200);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .deep-dive-sidebar.collapsed {
            display: none;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--stone-200);
        }

        .sidebar-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .sidebar-title {
            font-family: 'Spectral', serif;
            font-size: 14px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .sidebar-toggle {
            padding: 4px;
            background: none;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            color: var(--stone-600);
        }

        .sidebar-toggle:hover {
            background: var(--stone-100);
        }

        .progress-section {
            margin-bottom: 12px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .progress-label {
            font-size: 12px;
            color: var(--stone-600);
        }

        .progress-percent {
            font-size: 12px;
            font-weight: 600;
            color: #1c1917;
        }

        .progress-bar {
            height: 8px;
            background: var(--stone-100);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1c1917, #44403c);
            transition: width 0.5s ease;
        }

        .progress-count {
            font-size: 11px;
            color: var(--stone-500);
            margin-top: 4px;
        }

        .autosave-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--emerald-100);
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            font-size: 11px;
            color: var(--emerald-700);
        }

        .autosave-dot {
            width: 6px;
            height: 6px;
            background: var(--emerald-600);
            border-radius: 50%;
        }

        .categories-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .categories-list::-webkit-scrollbar {
            width: 6px;
        }

        .categories-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .categories-list::-webkit-scrollbar-thumb {
            background: var(--violet-600);
            border-radius: 3px;
        }

        .category-card {
            position: relative;
            padding: 12px;
            background: var(--white);
            border: 2px solid var(--stone-200);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-card:hover {
            border-color: var(--stone-300);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .category-card.active {
            border-color: #c4b5fd;
            background: #f5f3ff;
        }

        .category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .category-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .category-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: var(--stone-100);
            color: var(--stone-600);
        }

        .category-card.active .category-icon {
            background: #1c1917;
            color: white;
        }

        .category-info {
            flex: 1;
            min-width: 0;
        }

        .category-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--stone-900);
            margin-bottom: 2px;
        }

        .category-meta {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .category-badge {
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .category-badge.research {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .category-badge.deep-dive {
            background: #ede9fe;
            color: #292524;
        }

        .category-interactions {
            font-size: 9px;
            color: var(--stone-500);
        }

        .category-right {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .category-check {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid var(--stone-300);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .category-check.completed {
            background: var(--emerald-600);
            border-color: var(--emerald-600);
            color: white;
        }

        .category-preview {
            font-size: 10px;
            color: var(--stone-600);
            line-height: 1.4;
        }

        .category-preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .preview-stat {
            background: var(--stone-50);
            padding: 6px 8px;
            border-radius: 6px;
        }

        .preview-stat-label {
            font-size: 9px;
            color: var(--stone-500);
        }

        .preview-stat-value {
            font-size: 12px;
            font-weight: 700;
            font-family: 'Spectral', serif;
            color: var(--stone-900);
        }

        .preview-stat-value.success {
            color: var(--emerald-600);
        }

        .sidebar-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--stone-200);
            background: var(--stone-50);
        }

        .sidebar-footer-text {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: var(--stone-600);
        }

        .sidebar-footer-dot {
            width: 6px;
            height: 6px;
            background: var(--emerald-500);
            border-radius: 50%;
        }

        .sidebar-expand-btn {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: var(--white);
            border: 1px solid var(--stone-200);
            border-left: none;
            border-radius: 0 8px 8px 0;
            padding: 12px 8px;
            cursor: pointer;
            z-index: 100;
            display: none;
        }

        .deep-dive-sidebar.collapsed + .deep-dive-main .sidebar-expand-btn {
            display: block;
        }

        .deep-dive-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--white);
            min-width: 0;
        }

        .console-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .console-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .console-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1c1917, #292524);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .console-title {
            font-family: 'Spectral', serif;
            font-size: 18px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .console-subtitle {
            font-size: 13px;
            color: var(--stone-500);
        }

        .console-new-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--stone-100);
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            color: var(--stone-700);
            cursor: pointer;
            margin-left: 16px;
        }

        .console-new-btn:hover {
            background: var(--stone-200);
        }

        .console-header-right {
            display: flex;
            gap: 8px;
        }

        .save-export-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: #1c1917;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: white;
            cursor: pointer;
        }

        .save-export-btn:hover {
            background: #292524;
        }

        .save-export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .save-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            width: 320px;
            background: var(--white);
            border: 2px solid var(--stone-200);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
        }

        .save-menu.open {
            display: block;
        }

        .save-menu-section {
            padding: 16px;
            border-bottom: 1px solid var(--stone-200);
        }

        .save-menu-section:last-child {
            border-bottom: none;
        }

        .save-menu-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--stone-900);
            margin-bottom: 12px;
        }

        .save-name-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--stone-200);
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .save-name-input:focus {
            outline: none;
            border-color: #1c1917;
        }

        .save-confirm-btn {
            width: 100%;
            padding: 10px;
            background: #1c1917;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            color: white;
            cursor: pointer;
        }

        .save-confirm-btn:hover {
            background: #292524;
        }

        .export-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
        }

        .export-option:hover {
            background: var(--stone-50);
        }

        .export-option-icon {
            width: 32px;
            height: 32px;
            background: var(--stone-100);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--stone-600);
        }

        .export-option-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--stone-900);
        }

        .export-option-desc {
            font-size: 11px;
            color: var(--stone-500);
        }

        .console-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .console-messages::-webkit-scrollbar {
            width: 6px;
        }

        .console-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .console-messages::-webkit-scrollbar-thumb {
            background: var(--violet-600);
            border-radius: 3px;
        }

        .console-message {
            margin-bottom: 16px;
            max-width: 85%;
        }

        .console-message.user {
            margin-left: auto;
            text-align: right;
        }

        .console-message-content {
            display: inline-block;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.6;
            text-align: left;
        }

        .console-message.user .console-message-content {
            background: var(--violet-600);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .console-message.ai .console-message-content {
            background: var(--stone-100);
            color: var(--stone-900);
            border-bottom-left-radius: 4px;
        }

        .console-thinking {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            background: var(--stone-100);
            border-radius: 12px;
            font-size: 13px;
            color: var(--stone-600);
            max-width: 200px;
        }

        .console-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .console-suggestion {
            padding: 8px 14px;
            background: var(--white);
            border: 1px solid var(--stone-200);
            border-radius: 20px;
            font-size: 12px;
            color: var(--stone-700);
            cursor: pointer;
            transition: all 0.2s;
        }

        .console-suggestion:hover {
            background: var(--stone-50);
            border-color: var(--stone-300);
        }

        .console-input-area {
            padding: 16px 24px;
            border-top: 1px solid var(--stone-200);
            display: flex;
            gap: 12px;
        }

        .console-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid var(--stone-200);
            border-radius: 10px;
            font-size: 14px;
            outline: none;
        }

        .console-input:focus {
            border-color: #1c1917;
        }

        .console-send-btn {
            width: 44px;
            height: 44px;
            background: var(--violet-600);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .console-send-btn:hover {
            background: var(--stone-800);
        }

        @media (max-width: 1024px) {
            .deep-dive-sidebar {
                width: 280px;
            }
        }

        @media (max-width: 768px) {
            .deep-dive-console {
                flex-direction: column;
                height: auto;
            }

            .deep-dive-sidebar {
                width: 100%;
                max-height: 300px;
            }

            .deep-dive-main {
                min-height: 500px;
            }
        }

        /* Dark Mode Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            color: var(--stone-700);
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--stone-200);
        }

        .theme-toggle svg {
            width: 14px;
            height: 14px;
        }

        /* Keyboard Shortcut Hints */
        .shortcut-hint {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--stone-400);
            margin-left: 8px;
        }

        .shortcut-key {
            padding: 2px 6px;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
        }

        /* Message Actions */
        .message-actions {
            display: none;
            gap: 4px;
            margin-top: 8px;
        }

        .console-message:hover .message-actions {
            display: flex;
        }

        .message-action-btn {
            padding: 4px 8px;
            background: var(--white);
            border: 1px solid var(--stone-200);
            border-radius: 4px;
            font-size: 10px;
            color: var(--stone-600);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.15s;
        }

        .message-action-btn:hover {
            background: var(--stone-100);
            color: var(--stone-900);
        }

        .message-action-btn.bookmarked {
            background: var(--amber-100);
            border-color: var(--amber-200);
            color: var(--amber-700);
        }

        .message-action-btn svg {
            width: 12px;
            height: 12px;
        }

        /* Collapsible Messages */
        .console-message-content.collapsed {
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .console-message-content.collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, var(--stone-100));
        }

        .expand-message-btn {
            display: block;
            width: 100%;
            padding: 6px;
            background: var(--stone-50);
            border: 1px solid var(--stone-200);
            border-radius: 6px;
            font-size: 11px;
            color: var(--stone-600);
            cursor: pointer;
            margin-top: 4px;
        }

        .expand-message-btn:hover {
            background: var(--stone-100);
        }

        /* Saved Threads Panel */
        .saved-threads-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--white);
            border-left: 1px solid var(--stone-200);
            box-shadow: -10px 0 40px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .saved-threads-panel.open {
            right: 0;
        }

        .saved-threads-header {
            padding: 20px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .saved-threads-title {
            font-family: 'Spectral', serif;
            font-size: 18px;
            font-weight: 700;
        }

        .close-panel-btn {
            padding: 8px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--stone-500);
            border-radius: 6px;
        }

        .close-panel-btn:hover {
            background: var(--stone-100);
        }

        .saved-threads-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .saved-thread-item {
            padding: 16px;
            background: var(--stone-50);
            border: 1px solid var(--stone-200);
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .saved-thread-item:hover {
            border-color: var(--violet-500);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.1);
        }

        .saved-thread-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .saved-thread-meta {
            font-size: 12px;
            color: var(--stone-500);
            display: flex;
            gap: 12px;
        }

        .saved-thread-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Category Quick Actions */
        .category-quick-actions {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .quick-action-btn {
            flex: 1;
            padding: 6px 8px;
            background: var(--stone-50);
            border: 1px solid var(--stone-200);
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            color: var(--stone-700);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            transition: all 0.15s;
        }

        .quick-action-btn:hover {
            background: var(--violet-100);
            border-color: var(--violet-500);
            color: var(--violet-600);
        }

        .quick-action-btn svg {
            width: 10px;
            height: 10px;
        }

        /* Celebration Animation */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(360deg); opacity: 0; }
        }

        @keyframes celebrate-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .celebration-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .celebration-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .celebration-card {
            background: var(--white);
            padding: 48px;
            border-radius: 20px;
            text-align: center;
            animation: celebrate-pulse 0.5s ease;
        }

        .celebration-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .celebration-title {
            font-family: 'Spectral', serif;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--violet-500), var(--emerald-600));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .celebration-subtitle {
            color: var(--stone-600);
            margin-bottom: 24px;
        }

        /* Export Templates */
        .export-templates-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .export-template-card {
            padding: 16px;
            background: var(--stone-50);
            border: 1px solid var(--stone-200);
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .export-template-card:hover {
            border-color: var(--violet-500);
            background: var(--violet-100);
        }

        .export-template-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .export-template-name {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .export-template-desc {
            font-size: 10px;
            color: var(--stone-500);
        }

        /* Share Analysis Modal */
        .share-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .share-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .share-modal-content {
            background: var(--white);
            padding: 32px;
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
        }

        .share-modal-title {
            font-family: 'Spectral', serif;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .share-link-input {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .share-link-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            font-size: 13px;
        }

        .share-options {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .share-option-btn {
            padding: 12px 24px;
            background: var(--stone-100);
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .share-option-btn:hover {
            background: var(--stone-200);
        }

        /* Save to Project Feature */
        .project-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: var(--white);
            border-left: 1px solid var(--stone-200);
            box-shadow: -10px 0 40px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .project-panel.open {
            right: 0;
        }

        .project-panel-header {
            padding: 20px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .project-panel-title {
            font-family: 'Spectral', serif;
            font-size: 18px;
            font-weight: 700;
        }

        .project-tabs {
            display: flex;
            border-bottom: 1px solid var(--stone-200);
        }

        .project-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            font-size: 13px;
            font-weight: 500;
            color: var(--stone-500);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .project-tab.active {
            color: var(--violet-600);
            border-bottom-color: var(--violet-600);
        }

        .project-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .project-list {
            margin-bottom: 20px;
        }

        .project-item {
            padding: 16px;
            background: var(--stone-50);
            border: 2px solid var(--stone-200);
            border-radius: 10px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .project-item:hover {
            border-color: var(--violet-500);
        }

        .project-item.selected {
            border-color: var(--violet-500);
            background: var(--violet-100);
        }

        .project-item-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .project-item-meta {
            font-size: 12px;
            color: var(--stone-500);
        }

        .project-item-count {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--stone-200);
            border-radius: 12px;
            font-size: 11px;
            margin-top: 8px;
        }

        .new-project-form {
            padding: 16px;
            background: var(--stone-50);
            border: 2px dashed var(--stone-300);
            border-radius: 10px;
        }

        .new-project-form input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--stone-200);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .new-project-form textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--stone-200);
            border-radius: 6px;
            font-size: 13px;
            resize: vertical;
            min-height: 80px;
            margin-bottom: 12px;
        }

        .add-idea-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--stone-200);
        }

        .add-idea-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .idea-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--stone-200);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .idea-input:focus {
            outline: none;
            border-color: var(--violet-500);
        }

        .project-panel-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--stone-200);
            display: flex;
            gap: 12px;
        }

        .project-panel-footer button {
            flex: 1;
        }

        /* Panel Overlay */
        .panel-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="index.html" class="logo">
                    <div class="logo-icon">
                        <div class="logo-grid">
                                <div class="logo-cell active"></div>
                                <div class="logo-cell"></div>
                                <div class="logo-cell active"></div>
                                <div class="logo-cell"></div>
                                <div class="logo-cell active"></div>
                                <div class="logo-cell"></div>
                                <div class="logo-cell active"></div>
                                <div class="logo-cell active"></div>
                                <div class="logo-cell active"></div>
                        </div>
                    </div>
                    <div class="logo-text-group">
                        <span class="logo-text">OppGrid</span>
                        <span class="logo-tagline">The Opportunity Intelligence Platform</span>
                    </div>
                </a>
                <nav class="header-nav">
                    <a href="index.html" class="nav-link">Home</a>
                    <a href="discover.html" class="nav-link">Browse Ideas</a>
                    <a href="pricing.html" class="nav-link">Pricing</a>
                </nav>
            </div>
            <div class="header-actions" id="header-actions">
                <a href="signin.html" class="btn guest-only">Sign In</a>
                <a href="signup.html" class="btn btn-primary guest-only">Get Started</a>
                <a href="dashboard.html" class="btn btn-primary auth-required" style="display: none;">Dashboard</a>
                <div class="user-menu auth-required" style="display: none; cursor: pointer;" onclick="window.location.href='account.html'">
                    <span id="user-avatar" style="width: 36px; height: 36px; border-radius: 50%; background: var(--violet-600); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px;">U</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-header-left">
                <div class="page-header-meta" id="opportunity-id">IDEA #...</div>
                <h1 id="opportunity-title">Loading...</h1>
            </div>
            <div class="validation-score">
                <div class="validation-score-label">Validation Score</div>
                <div class="validation-score-value" id="validation-score">--/100</div>
            </div>
        </div>
    </div>

    <!-- Tier Navigation -->
    <div class="tier-nav tier-detail" id="tier-nav">
        <div class="tier-nav-content">
            <button class="tier-tab active" data-tier="detail">Problem Detail</button>
            <button class="tier-tab" data-tier="research">Research Dashboard</button>
            <button class="tier-tab" data-tier="deep">Deep Dive</button>
        </div>
    </div>

    <!-- Access Info Banner (Time-Decay Pricing) -->
    <div id="access-info-banner" style="display: none; max-width: 1280px; margin: 0 auto; padding: 16px 32px;">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; padding: 16px 20px; border-radius: 12px; background: var(--stone-50); border: 1px solid var(--stone-200);">
            <div style="display: flex; align-items: center; gap: 16px;">
                <span id="freshness-badge" style="display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 600;"></span>
                <span id="access-message" style="font-size: 14px; color: var(--stone-600);"></span>
            </div>
            <div id="access-cta" style="display: flex; gap: 8px;"></div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- TIER 1: Problem Detail (Free) -->
        <div id="tier-detail" class="tier-content">
            <!-- Metrics -->
            <div class="metrics-grid fade-in-up stagger-1">
                <div class="metric-card">
                    <div class="metric-header">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <div class="metric-label">Submissions</div>
                    </div>
                    <div class="metric-value">2,847</div>
                    <div class="metric-change">↑ 34% this month</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                        <div class="metric-label">Market Size</div>
                    </div>
                    <div class="metric-value">$8.4B</div>
                    <div class="metric-change neutral">TAM estimate</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <div class="metric-label">Urgency</div>
                    </div>
                    <div class="metric-value">High</div>
                    <div class="metric-change neutral">Immediate need</div>
                </div>
            </div>

            <!-- Problem Statement -->
            <div class="content-card fade-in-up stagger-2">
                <h2>Problem Statement</h2>
                <p id="opportunity-description">Homeowners struggle with reactive, expensive emergency repairs and lack a reliable way to maintain their homes proactively. Finding trustworthy contractors, scheduling multiple services, and managing home maintenance creates significant friction and anxiety.</p>
            </div>

            <!-- Pain Points -->
            <div class="content-card fade-in-up stagger-3">
                <h2>Top Consumer Pain Points</h2>
                <div id="pain-points-container">
                    <div class="pain-point slide-in" style="animation-delay: 0.4s;">
                        <div class="pain-point-quote">Loading pain points...</div>
                        <div class="pain-point-severity">Severity: --</div>
                    </div>
                </div>
            </div>

            <!-- Source Data Section -->
            <div class="content-card fade-in-up" id="source-data-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="margin-bottom: 0;">Supporting Data</h2>
                    <button class="btn" onclick="toggleSourceData()" id="toggle-source-btn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        View Raw Data
                    </button>
                </div>
                <p style="color: var(--stone-500); font-size: 14px; margin-bottom: 16px;">
                    View the original source data used to generate this opportunity analysis.
                </p>
                <div id="source-data-content" style="display: none;">
                    <div style="background: var(--stone-100); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: var(--stone-500); margin-bottom: 8px;">SOURCE PLATFORM</div>
                        <div id="source-platform-display" style="font-weight: 500;">--</div>
                    </div>
                    <div style="background: var(--stone-100); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: var(--stone-500); margin-bottom: 8px;">ORIGINAL POST</div>
                        <div id="source-original-title" style="font-weight: 500; margin-bottom: 8px;">--</div>
                        <div id="source-original-body" style="color: var(--stone-600); font-size: 14px; line-height: 1.6;">--</div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                        <div style="background: var(--stone-100); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: var(--stone-500);">UPVOTES</div>
                            <div id="source-upvotes" style="font-size: 18px; font-weight: 600;">--</div>
                        </div>
                        <div style="background: var(--stone-100); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: var(--stone-500);">COMMENTS</div>
                            <div id="source-comments" style="font-size: 18px; font-weight: 600;">--</div>
                        </div>
                        <div style="background: var(--stone-100); border-radius: 8px; padding: 12px; text-align: center;">
                            <div style="font-size: 11px; color: var(--stone-500);">CONFIDENCE</div>
                            <div id="source-confidence" style="font-size: 18px; font-weight: 600;">--</div>
                        </div>
                    </div>
                    <a id="source-url-link" href="#" target="_blank" style="display: inline-block; margin-top: 16px; color: var(--violet-600); font-size: 14px; text-decoration: none;">
                        View Original Post →
                    </a>
                </div>
            </div>

            <!-- Geographic Market Selector (Tier 1 Feature) -->
            <div class="geo-section fade-in-up stagger-4" id="geo-selector">
                <h2>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="2" y1="12" x2="22" y2="12"></line>
                        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                    </svg>
                    Geographic Market Analysis
                </h2>
                <div class="geo-tabs" id="geo-tabs">
                    <button class="geo-tab active" data-region="us-national">US National</button>
                    <button class="geo-tab recommended" data-region="us-southwest">Southwest Region</button>
                    <button class="geo-tab" data-region="canada">Canada</button>
                    <button class="geo-tab" data-region="uk">UK</button>
                    <button class="geo-tab" data-region="australia">Australia</button>
                    <button class="geo-tab" data-region="global">Global</button>
                </div>
                <div class="geo-metrics" id="geo-metrics">
                    <div class="geo-metric">
                        <div class="geo-metric-label">Market Size</div>
                        <div class="geo-metric-value" id="geo-market-size">$8.4B</div>
                    </div>
                    <div class="geo-metric">
                        <div class="geo-metric-label">Submissions</div>
                        <div class="geo-metric-value" id="geo-submissions">2,847</div>
                    </div>
                    <div class="geo-metric">
                        <div class="geo-metric-label">Growth Rate</div>
                        <div class="geo-metric-value growth" id="geo-growth">+34%</div>
                    </div>
                    <div class="geo-metric">
                        <div class="geo-metric-label">Competition</div>
                        <div class="geo-metric-value" id="geo-competition">High</div>
                    </div>
                </div>
                <div class="geo-assessment high" id="geo-assessment">
                    <span class="applicability-badge high" id="geo-applicability">High</span>
                    <span class="geo-recommendation" id="geo-recommendation">National opportunity with strong metro-by-metro demand. Consider regional launch strategy.</span>
                </div>
            </div>

            <!-- Related Opportunities -->
            <div class="content-card fade-in-up" style="animation-delay: 0.5s;">
                <h2>Related Opportunities</h2>
                <ul class="related-list" id="related-opportunities-list">
                    <li class="related-item">
                        <span>Loading related opportunities...</span>
                    </li>
                </ul>
            </div>

            <!-- CTA Banner -->
            <div class="cta-banner">
                <div>
                    <h3>Ready to go deeper?</h3>
                    <p>Unlock Research Dashboard with full market analysis, demographics, and competitive landscape</p>
                </div>
                <button onclick="handleUnlockResearch()" class="btn btn-white">Unlock Research → $29</button>
            </div>
        </div>

        <!-- TIER 2: Research Dashboard -->
        <div id="tier-research" class="tier-content" style="display: none;">
            <div class="research-tabs-container fade-in-up">
                <!-- Tab Navigation -->
                <div class="research-tabs-nav">
                    <button class="research-tab active" data-tab="market">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                            <polyline points="17 6 23 6 23 12"></polyline>
                        </svg>
                        Market Validation
                    </button>
                    <button class="research-tab" data-tab="geography">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        Geographic Distribution
                    </button>
                    <button class="research-tab" data-tab="problem">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                            <polyline points="2 17 12 22 22 17"></polyline>
                            <polyline points="2 12 12 17 22 12"></polyline>
                        </svg>
                        Problem Analysis
                    </button>
                    <button class="research-tab" data-tab="opportunity">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        Opportunity Sizing
                    </button>
                    <button class="research-tab" data-tab="solution">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <circle cx="12" cy="12" r="6"></circle>
                            <circle cx="12" cy="12" r="2"></circle>
                        </svg>
                        Solution Pathways
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="research-tab-content">
                    <!-- Market Validation Panel -->
                    <div class="research-panel active" id="panel-market">
                        <div class="research-grid-2">
                            <div>
                                <h3 class="research-section-title">Demand Signals</h3>
                                <div class="research-stat-row">
                                    <span class="research-stat-label">Search Volume (monthly)</span>
                                    <span class="research-stat-value">127K</span>
                                </div>
                                <div class="research-stat-row">
                                    <span class="research-stat-label">YoY Growth</span>
                                    <span class="research-stat-value growth">+43%</span>
                                </div>
                                <div class="research-stat-row">
                                    <span class="research-stat-label">Social Mentions</span>
                                    <span class="research-stat-value">89K/mo</span>
                                </div>
                            </div>
                            <div>
                                <h3 class="research-section-title">Demographics</h3>
                                <div class="research-stat-row">
                                    <span class="research-stat-label">Primary Age Range</span>
                                    <span class="research-stat-value">35-54</span>
                                </div>
                                <div class="research-stat-row">
                                    <span class="research-stat-label">Income Level</span>
                                    <span class="research-stat-value">$75K-150K</span>
                                </div>
                                <div class="research-stat-row">
                                    <span class="research-stat-label">Home Ownership</span>
                                    <span class="research-stat-value">87%</span>
                                </div>
                            </div>
                        </div>
                        <div style="border-top: 1px solid var(--stone-200); margin-top: 24px; padding-top: 24px;">
                            <h3 class="research-section-title">Competitive Landscape</h3>
                            <div class="competitor-card">
                                <div class="competitor-header">
                                    <span class="competitor-name">American Home Shield</span>
                                    <span class="competitor-share">23% market share</span>
                                </div>
                                <p class="competitor-weakness">Key weakness: Poor service quality</p>
                            </div>
                            <div class="competitor-card">
                                <div class="competitor-header">
                                    <span class="competitor-name">HomeAdvisor</span>
                                    <span class="competitor-share">18% market share</span>
                                </div>
                                <p class="competitor-weakness">Key weakness: Lead generation only</p>
                            </div>
                            <div class="competitor-card">
                                <div class="competitor-header">
                                    <span class="competitor-name">Thumbtack</span>
                                    <span class="competitor-share">12% market share</span>
                                </div>
                                <p class="competitor-weakness">Key weakness: No ongoing relationship</p>
                            </div>
                        </div>
                    </div>

                    <!-- Geographic Distribution Panel -->
                    <div class="research-panel" id="panel-geography">
                        <h3 class="research-section-title">Market Applicability by Region</h3>
                        
                        <div class="region-card selected" data-region="us-southwest">
                            <div class="region-header">
                                <div>
                                    <div class="region-title">Southwest Region</div>
                                    <span class="applicability-badge very-high">Very High</span>
                                </div>
                                <div class="region-market-size">
                                    <div class="region-market-label">Market Size</div>
                                    <div class="region-market-value">$1.2B</div>
                                </div>
                            </div>
                            <div class="region-stats">
                                <div>
                                    <div class="region-stat-label">Submissions</div>
                                    <div class="region-stat-value">847</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Growth Rate</div>
                                    <div class="region-stat-value" style="color: var(--emerald-600);">+52%</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Competition</div>
                                    <div class="region-stat-value">Medium</div>
                                </div>
                            </div>
                            <div class="region-cities">
                                <div class="region-cities-label">Top Markets</div>
                                <div class="region-cities-list">
                                    <span class="region-city-tag">Austin, TX</span>
                                    <span class="region-city-tag">Phoenix, AZ</span>
                                    <span class="region-city-tag">Las Vegas, NV</span>
                                    <span class="region-city-tag">Albuquerque, NM</span>
                                </div>
                            </div>
                        </div>

                        <div class="region-card" data-region="us-national">
                            <div class="region-header">
                                <div>
                                    <div class="region-title">United States (National)</div>
                                    <span class="applicability-badge high">High</span>
                                </div>
                                <div class="region-market-size">
                                    <div class="region-market-label">Market Size</div>
                                    <div class="region-market-value">$8.4B</div>
                                </div>
                            </div>
                            <div class="region-stats">
                                <div>
                                    <div class="region-stat-label">Submissions</div>
                                    <div class="region-stat-value">2,847</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Growth Rate</div>
                                    <div class="region-stat-value" style="color: var(--emerald-600);">+34%</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Competition</div>
                                    <div class="region-stat-value">High</div>
                                </div>
                            </div>
                            <div class="region-cities">
                                <div class="region-cities-label">Top Markets</div>
                                <div class="region-cities-list">
                                    <span class="region-city-tag">Austin, TX</span>
                                    <span class="region-city-tag">Denver, CO</span>
                                    <span class="region-city-tag">Portland, OR</span>
                                    <span class="region-city-tag">Nashville, TN</span>
                                    <span class="region-city-tag">Charlotte, NC</span>
                                </div>
                            </div>
                        </div>

                        <div class="region-card" data-region="canada">
                            <div class="region-header">
                                <div>
                                    <div class="region-title">Canada</div>
                                    <span class="applicability-badge high">High</span>
                                </div>
                                <div class="region-market-size">
                                    <div class="region-market-label">Market Size</div>
                                    <div class="region-market-value">$2.1B CAD</div>
                                </div>
                            </div>
                            <div class="region-stats">
                                <div>
                                    <div class="region-stat-label">Submissions</div>
                                    <div class="region-stat-value">412</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Growth Rate</div>
                                    <div class="region-stat-value" style="color: var(--emerald-600);">+28%</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Competition</div>
                                    <div class="region-stat-value">Low</div>
                                </div>
                            </div>
                            <div class="region-cities">
                                <div class="region-cities-label">Top Markets</div>
                                <div class="region-cities-list">
                                    <span class="region-city-tag">Toronto, ON</span>
                                    <span class="region-city-tag">Vancouver, BC</span>
                                    <span class="region-city-tag">Calgary, AB</span>
                                    <span class="region-city-tag">Montreal, QC</span>
                                </div>
                            </div>
                        </div>

                        <div class="region-card" data-region="uk">
                            <div class="region-header">
                                <div>
                                    <div class="region-title">United Kingdom</div>
                                    <span class="applicability-badge medium">Medium</span>
                                </div>
                                <div class="region-market-size">
                                    <div class="region-market-label">Market Size</div>
                                    <div class="region-market-value">£1.8B</div>
                                </div>
                            </div>
                            <div class="region-stats">
                                <div>
                                    <div class="region-stat-label">Submissions</div>
                                    <div class="region-stat-value">234</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Growth Rate</div>
                                    <div class="region-stat-value" style="color: var(--emerald-600);">+19%</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Competition</div>
                                    <div class="region-stat-value">High</div>
                                </div>
                            </div>
                            <div class="region-cities">
                                <div class="region-cities-label">Top Markets</div>
                                <div class="region-cities-list">
                                    <span class="region-city-tag">London</span>
                                    <span class="region-city-tag">Manchester</span>
                                    <span class="region-city-tag">Birmingham</span>
                                    <span class="region-city-tag">Edinburgh</span>
                                </div>
                            </div>
                        </div>

                        <div class="region-card" data-region="australia">
                            <div class="region-header">
                                <div>
                                    <div class="region-title">Australia</div>
                                    <span class="applicability-badge medium">Medium</span>
                                </div>
                                <div class="region-market-size">
                                    <div class="region-market-label">Market Size</div>
                                    <div class="region-market-value">$1.4B AUD</div>
                                </div>
                            </div>
                            <div class="region-stats">
                                <div>
                                    <div class="region-stat-label">Submissions</div>
                                    <div class="region-stat-value">189</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Growth Rate</div>
                                    <div class="region-stat-value" style="color: var(--emerald-600);">+31%</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Competition</div>
                                    <div class="region-stat-value">Low</div>
                                </div>
                            </div>
                            <div class="region-cities">
                                <div class="region-cities-label">Top Markets</div>
                                <div class="region-cities-list">
                                    <span class="region-city-tag">Sydney</span>
                                    <span class="region-city-tag">Melbourne</span>
                                    <span class="region-city-tag">Brisbane</span>
                                    <span class="region-city-tag">Perth</span>
                                </div>
                            </div>
                        </div>

                        <div class="region-card" data-region="global">
                            <div class="region-header">
                                <div>
                                    <div class="region-title">Global Market</div>
                                    <span class="applicability-badge medium">Varies</span>
                                </div>
                                <div class="region-market-size">
                                    <div class="region-market-label">Market Size</div>
                                    <div class="region-market-value">$47B+</div>
                                </div>
                            </div>
                            <div class="region-stats">
                                <div>
                                    <div class="region-stat-label">Submissions</div>
                                    <div class="region-stat-value">4,821</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Growth Rate</div>
                                    <div class="region-stat-value" style="color: var(--emerald-600);">+29%</div>
                                </div>
                                <div>
                                    <div class="region-stat-label">Competition</div>
                                    <div class="region-stat-value">Highly variable</div>
                                </div>
                            </div>
                        </div>

                        <!-- Launch Strategy -->
                        <div class="launch-strategy-box">
                            <div class="launch-strategy-title">
                                <span>🎯</span> Recommended Launch Strategy
                            </div>
                            <div class="launch-phase-card">
                                <div class="launch-phase-header">
                                    <div class="launch-phase-number phase-1">1</div>
                                    <span class="launch-phase-name">Phase 1: Southwest US Launch</span>
                                </div>
                                <p class="launch-phase-desc">Highest growth (+52%), favorable regulations, medium competition. Start Austin → Phoenix.</p>
                            </div>
                            <div class="launch-phase-card">
                                <div class="launch-phase-header">
                                    <div class="launch-phase-number phase-2">2</div>
                                    <span class="launch-phase-name">Phase 2: National Expansion</span>
                                </div>
                                <p class="launch-phase-desc">Expand to top 20 metro areas. Address state licensing complexity.</p>
                            </div>
                            <div class="launch-phase-card">
                                <div class="launch-phase-header">
                                    <div class="launch-phase-number phase-3">3</div>
                                    <span class="launch-phase-name">Phase 3: International (Canada/Australia)</span>
                                </div>
                                <p class="launch-phase-desc">After US market leadership established. Similar demographics, lower competition.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Problem Analysis Panel -->
                    <div class="research-panel" id="panel-problem">
                        <h3 class="research-section-title">Pain Point Categorization</h3>
                        
                        <div class="pain-card">
                            <div class="pain-card-header">
                                <div>
                                    <div class="pain-category">Trust & Reliability</div>
                                    <p class="pain-quote">Can't find trustworthy contractors</p>
                                </div>
                                <div class="pain-severity">
                                    <div class="pain-severity-label">Severity</div>
                                    <div class="pain-severity-value">9.2/10</div>
                                </div>
                            </div>
                            <div class="pain-mentions">847 mentions</div>
                        </div>

                        <div class="pain-card">
                            <div class="pain-card-header">
                                <div>
                                    <div class="pain-category">Cost Predictability</div>
                                    <p class="pain-quote">Emergency repairs are financially devastating</p>
                                </div>
                                <div class="pain-severity">
                                    <div class="pain-severity-label">Severity</div>
                                    <div class="pain-severity-value">8.8/10</div>
                                </div>
                            </div>
                            <div class="pain-mentions">623 mentions</div>
                        </div>

                        <div class="pain-card">
                            <div class="pain-card-header">
                                <div>
                                    <div class="pain-category">Knowledge Gap</div>
                                    <p class="pain-quote">Don't know what maintenance is needed</p>
                                </div>
                                <div class="pain-severity">
                                    <div class="pain-severity-label">Severity</div>
                                    <div class="pain-severity-value">7.9/10</div>
                                </div>
                            </div>
                            <div class="pain-mentions">512 mentions</div>
                        </div>

                        <div class="pain-card">
                            <div class="pain-card-header">
                                <div>
                                    <div class="pain-category">Time & Convenience</div>
                                    <p class="pain-quote">Coordinating multiple services is exhausting</p>
                                </div>
                                <div class="pain-severity">
                                    <div class="pain-severity-label">Severity</div>
                                    <div class="pain-severity-value">7.4/10</div>
                                </div>
                            </div>
                            <div class="pain-mentions">421 mentions</div>
                        </div>
                    </div>

                    <!-- Opportunity Sizing Panel -->
                    <div class="research-panel" id="panel-opportunity">
                        <div class="tam-grid">
                            <div class="tam-card">
                                <div class="tam-label">TAM</div>
                                <div class="tam-value">$8.4B</div>
                                <div class="tam-desc">Total addressable</div>
                            </div>
                            <div class="tam-card">
                                <div class="tam-label">SAM</div>
                                <div class="tam-value">$2.1B</div>
                                <div class="tam-desc">Serviceable available</div>
                            </div>
                            <div class="tam-card">
                                <div class="tam-label">SOM</div>
                                <div class="tam-value">$187M</div>
                                <div class="tam-desc">5-year target</div>
                            </div>
                        </div>

                        <h3 class="research-section-title">Willingness to Pay</h3>
                        
                        <div class="pricing-tier">
                            <div>
                                <div class="pricing-tier-name">Basic Plan</div>
                                <div class="pricing-tier-adoption">67% would subscribe</div>
                            </div>
                            <div class="pricing-tier-price">$49/mo</div>
                        </div>

                        <div class="pricing-tier">
                            <div>
                                <div class="pricing-tier-name">Premium Plan</div>
                                <div class="pricing-tier-adoption">34% would subscribe</div>
                            </div>
                            <div class="pricing-tier-price">$99/mo</div>
                        </div>

                        <div class="pricing-tier">
                            <div>
                                <div class="pricing-tier-name">Comprehensive</div>
                                <div class="pricing-tier-adoption">18% would subscribe</div>
                            </div>
                            <div class="pricing-tier-price">$149/mo</div>
                        </div>
                    </div>

                    <!-- Solution Pathways Panel -->
                    <div class="research-panel" id="panel-solution">
                        <h3 class="research-section-title">Desired Solution Features</h3>
                        
                        <div class="feature-priority">
                            <div class="feature-priority-number">1</div>
                            <div class="feature-priority-content">
                                <div class="feature-priority-name">Vetted contractor network</div>
                                <div class="feature-priority-mentions">1,247 user mentions</div>
                            </div>
                        </div>

                        <div class="feature-priority">
                            <div class="feature-priority-number">2</div>
                            <div class="feature-priority-content">
                                <div class="feature-priority-name">Preventive maintenance scheduling</div>
                                <div class="feature-priority-mentions">1,089 user mentions</div>
                            </div>
                        </div>

                        <div class="feature-priority">
                            <div class="feature-priority-number">3</div>
                            <div class="feature-priority-content">
                                <div class="feature-priority-name">Fixed pricing guarantee</div>
                                <div class="feature-priority-mentions">923 user mentions</div>
                            </div>
                        </div>

                        <div class="feature-priority">
                            <div class="feature-priority-number">4</div>
                            <div class="feature-priority-content">
                                <div class="feature-priority-name">24/7 emergency support</div>
                                <div class="feature-priority-mentions">876 user mentions</div>
                            </div>
                        </div>

                        <div class="feature-priority">
                            <div class="feature-priority-number">5</div>
                            <div class="feature-priority-content">
                                <div class="feature-priority-name">Home systems monitoring</div>
                                <div class="feature-priority-mentions">734 user mentions</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upgrade to Deep Dive CTA -->
            <div class="cta-banner" style="margin-top: 32px;">
                <div>
                    <h3>Unlock Deep Dive Analysis</h3>
                    <p>Get actionable execution playbook, financial models, full competitive intelligence, and product roadmap</p>
                </div>
                <button class="btn btn-white" onclick="document.querySelector('[data-tier=deep]').click()">
                    Deep Dive
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        <!-- TIER 3: Deep Dive -->
        <div id="tier-deep" class="tier-content" style="display: none;">
            <div class="deep-dive-console">
                <!-- Left Sidebar - Analysis Categories -->
                <div class="deep-dive-sidebar" id="deep-dive-sidebar">
                    <div class="sidebar-header">
                        <div class="sidebar-header-top">
                            <h2 class="sidebar-title">Analysis Sections</h2>
                            <button class="sidebar-toggle" id="sidebar-toggle" title="Collapse sidebar">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <polyline points="15 18 9 12 15 6"></polyline>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="progress-section">
                            <div class="progress-header">
                                <span class="progress-label">Progress</span>
                                <span class="progress-percent" id="progress-percent">22%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill" style="width: 22%;"></div>
                            </div>
                            <div class="progress-count" id="progress-count">2 of 9 sections completed</div>
                        </div>

                        <div class="autosave-indicator" id="autosave-indicator" style="display: none;">
                            <span class="autosave-dot"></span>
                            <span id="autosave-text">Auto-saved 0 messages</span>
                        </div>
                    </div>

                    <div class="categories-list" id="categories-list">
                        <!-- Market Validation -->
                        <div class="category-card" data-category="market-validation">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                            <polyline points="17 6 23 6 23 12"></polyline>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Market Validation</div>
                                        <div class="category-meta">
                                            <span class="category-badge research">Research</span>
                                            <span class="category-interactions" data-interactions="0"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check" data-category="market-validation"></div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: var(--stone-400);">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview">Search volume: 127K/mo • +43% growth</div>
                        </div>

                        <!-- Geographic Distribution -->
                        <div class="category-card" data-category="geographic">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                            <circle cx="12" cy="10" r="3"></circle>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Geographic Distribution</div>
                                        <div class="category-meta">
                                            <span class="category-badge research">Research</span>
                                            <span class="category-interactions" data-interactions="5">5 interactions</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check completed" data-category="geographic">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 10px; height: 10px;">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: var(--stone-400);">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview">Priority: Southwest US ($1.2B, +52%)</div>
                        </div>

                        <!-- Problem Analysis -->
                        <div class="category-card" data-category="problem-analysis">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="12" y1="8" x2="12" y2="12"></line>
                                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Problem Analysis</div>
                                        <div class="category-meta">
                                            <span class="category-badge research">Research</span>
                                            <span class="category-interactions" data-interactions="0"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check" data-category="problem-analysis"></div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: var(--stone-400);">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview">Trust issues: 847 mentions (9.2/10)</div>
                        </div>

                        <!-- Opportunity Sizing -->
                        <div class="category-card" data-category="opportunity-sizing">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <line x1="12" y1="1" x2="12" y2="23"></line>
                                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Opportunity Sizing</div>
                                        <div class="category-meta">
                                            <span class="category-badge research">Research</span>
                                            <span class="category-interactions" data-interactions="2">2 interactions</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check" data-category="opportunity-sizing"></div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: var(--stone-400);">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview">TAM: $8.4B • SAM: $2.1B • SOM: $187M</div>
                        </div>

                        <!-- Solution Pathways -->
                        <div class="category-card" data-category="solution-pathways">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <circle cx="12" cy="12" r="6"></circle>
                                            <circle cx="12" cy="12" r="2"></circle>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Solution Pathways</div>
                                        <div class="category-meta">
                                            <span class="category-badge research">Research</span>
                                            <span class="category-interactions" data-interactions="0"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check" data-category="solution-pathways"></div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: var(--stone-400);">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview">Top: Vetted contractors (1,247 mentions)</div>
                        </div>

                        <!-- Executive Summary (Deep Dive) -->
                        <div class="category-card active" data-category="executive">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Executive Summary</div>
                                        <div class="category-meta">
                                            <span class="category-badge deep-dive">Deep Dive</span>
                                            <span class="category-interactions" data-interactions="3">3 interactions</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check completed" data-category="executive">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 10px; height: 10px;">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: #1c1917;">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview">$8.4B market • 18.4x LTV:CAC</div>
                        </div>

                        <!-- Financial Modeling (Deep Dive) -->
                        <div class="category-card" data-category="financial">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <line x1="12" y1="1" x2="12" y2="23"></line>
                                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Financial Modeling</div>
                                        <div class="category-meta">
                                            <span class="category-badge deep-dive">Deep Dive</span>
                                            <span class="category-interactions" data-interactions="1">1 interaction</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check" data-category="financial"></div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: var(--stone-400);">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview-grid">
                                <div class="preview-stat">
                                    <div class="preview-stat-label">Year 1</div>
                                    <div class="preview-stat-value">$4.6M</div>
                                </div>
                                <div class="preview-stat">
                                    <div class="preview-stat-label">Year 5</div>
                                    <div class="preview-stat-value success">$312M</div>
                                </div>
                            </div>
                        </div>

                        <!-- Execution Playbook (Deep Dive) -->
                        <div class="category-card" data-category="execution">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Execution Playbook</div>
                                        <div class="category-meta">
                                            <span class="category-badge deep-dive">Deep Dive</span>
                                            <span class="category-interactions" data-interactions="0"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check" data-category="execution"></div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: var(--stone-400);">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview">90-day plan • 3 phases</div>
                        </div>

                        <!-- Raw Data & Exports (Deep Dive) -->
                        <div class="category-card" data-category="data">
                            <div class="category-header">
                                <div class="category-left">
                                    <div class="category-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                            <line x1="18" y1="20" x2="18" y2="10"></line>
                                            <line x1="12" y1="20" x2="12" y2="4"></line>
                                            <line x1="6" y1="20" x2="6" y2="14"></line>
                                        </svg>
                                    </div>
                                    <div class="category-info">
                                        <div class="category-name">Raw Data & Exports</div>
                                        <div class="category-meta">
                                            <span class="category-badge deep-dive">Deep Dive</span>
                                            <span class="category-interactions" data-interactions="0"></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="category-right">
                                    <div class="category-check" data-category="data"></div>
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px; color: var(--stone-400);">
                                        <polyline points="9 18 15 12 9 6"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="category-preview" style="display: flex; gap: 4px;">
                                <span style="flex: 1; background: var(--stone-100); padding: 4px 8px; border-radius: 4px; text-align: center; font-size: 9px; font-weight: 500;">PDF</span>
                                <span style="flex: 1; background: var(--stone-100); padding: 4px 8px; border-radius: 4px; text-align: center; font-size: 9px; font-weight: 500;">CSV</span>
                                <span style="flex: 1; background: var(--stone-100); padding: 4px 8px; border-radius: 4px; text-align: center; font-size: 9px; font-weight: 500;">API</span>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-footer">
                        <div class="sidebar-footer-text">
                            <span class="sidebar-footer-dot"></span>
                            <span>All data current as of Dec 2024</span>
                        </div>
                    </div>
                </div>

                <!-- Main Console Area -->
                <div class="deep-dive-main">
                    <button class="sidebar-expand-btn" id="sidebar-expand-btn" title="Expand sidebar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>

                    <div class="console-header">
                        <div class="console-header-left">
                            <div class="console-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                </svg>
                            </div>
                            <div>
                                <div class="console-title">AI Research Console</div>
                                <div class="console-subtitle" id="console-subtitle">Executive Summary</div>
                            </div>
                            <button class="console-new-btn" id="console-new-btn" style="display: none;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                                New
                            </button>
                        </div>
                        <div class="console-header-right" style="position: relative;">
                            <button class="theme-toggle" id="theme-toggle" title="Toggle dark mode">
                                <svg id="theme-icon-light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                                <svg id="theme-icon-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                            </button>
                            <button class="theme-toggle" id="saved-threads-btn" title="Saved threads">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>
                                Saved
                            </button>
                            <button class="theme-toggle" id="project-btn" title="Save to project">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                                Projects
                            </button>
                            <button class="theme-toggle" id="share-btn" title="Share analysis">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                            </button>
                            <button class="save-export-btn" id="save-export-btn">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Save & Export
                            </button>
                            <div class="save-menu" id="save-menu">
                                <div class="save-menu-section">
                                    <div class="save-menu-title">Save This Conversation</div>
                                    <input type="text" class="save-name-input" id="save-name-input" placeholder="Name this analysis...">
                                    <button class="save-confirm-btn" id="save-confirm-btn">Save Conversation</button>
                                </div>
                                <div class="save-menu-section">
                                    <div class="save-menu-title">Export As</div>
                                    <div class="export-option" data-format="markdown">
                                        <div class="export-option-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="export-option-name">Markdown</div>
                                            <div class="export-option-desc">Formatted document</div>
                                        </div>
                                    </div>
                                    <div class="export-option" data-format="json">
                                        <div class="export-option-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                                <polyline points="16 18 22 12 16 6"></polyline>
                                                <polyline points="8 6 2 12 8 18"></polyline>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="export-option-name">JSON Data</div>
                                            <div class="export-option-desc">Raw structured data</div>
                                        </div>
                                    </div>
                                    <div class="export-option" data-format="text">
                                        <div class="export-option-icon">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                                <polyline points="10 9 9 9 8 9"></polyline>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="export-option-name">Plain Text</div>
                                            <div class="export-option-desc">Simple text file</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="console-messages" id="console-messages">
                        <div class="console-message ai">
                            <div class="console-message-content">
                                Welcome to the Deep Dive AI Research Console! I have access to comprehensive analysis across 2,847 validated data points. Select a category from the sidebar or ask me anything about this opportunity.
                                <div class="console-suggestions">
                                    <button class="console-suggestion" data-question="Give me an executive summary of this opportunity">Executive summary</button>
                                    <button class="console-suggestion" data-question="Build a detailed financial model with projections">Financial projections</button>
                                    <button class="console-suggestion" data-question="Create a 90-day execution playbook">Execution playbook</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="console-input-area">
                        <input type="text" class="console-input" id="console-input" placeholder="Ask about this opportunity...">
                        <button class="console-send-btn" id="console-send-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Panel Overlay -->
    <div class="panel-overlay" id="panel-overlay"></div>

    <!-- Saved Threads Panel -->
    <div class="saved-threads-panel" id="saved-threads-panel">
        <div class="saved-threads-header">
            <h2 class="saved-threads-title">Saved Threads</h2>
            <button class="close-panel-btn" id="close-threads-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="saved-threads-list" id="saved-threads-list">
            <p style="text-align: center; color: var(--stone-500); padding: 40px 20px;">No saved threads yet. Save a conversation to see it here.</p>
        </div>
    </div>

    <!-- Project Panel -->
    <div class="project-panel" id="project-panel">
        <div class="project-panel-header">
            <h2 class="project-panel-title">My Projects</h2>
            <button class="close-panel-btn" id="close-project-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="project-tabs">
            <button class="project-tab active" data-tab="existing">Existing Projects</button>
            <button class="project-tab" data-tab="new">Create New</button>
        </div>
        <div class="project-content" id="project-content">
            <div id="existing-projects-tab">
                <div class="project-list" id="project-list">
                    <div class="project-item" data-project-id="1">
                        <div class="project-item-name">Home Services Venture</div>
                        <div class="project-item-meta">Created Dec 10, 2024</div>
                        <span class="project-item-count">3 ideas saved</span>
                    </div>
                    <div class="project-item" data-project-id="2">
                        <div class="project-item-name">SaaS Ideas Q1 2025</div>
                        <div class="project-item-meta">Created Dec 8, 2024</div>
                        <span class="project-item-count">7 ideas saved</span>
                    </div>
                </div>
                <div class="add-idea-section">
                    <div class="add-idea-title">Add New Idea to Selected Project</div>
                    <input type="text" class="idea-input" id="new-idea-title" placeholder="Idea title...">
                    <textarea class="idea-input" id="new-idea-description" placeholder="Describe your idea..." style="min-height: 80px;"></textarea>
                </div>
            </div>
            <div id="new-project-tab" style="display: none;">
                <div class="new-project-form">
                    <input type="text" id="new-project-name" placeholder="Project name...">
                    <textarea id="new-project-description" placeholder="Describe what this project is about..."></textarea>
                    <button class="btn btn-primary" id="create-project-btn" style="width: 100%;">Create Project</button>
                </div>
            </div>
        </div>
        <div class="project-panel-footer">
            <button class="btn" id="cancel-project-btn">Cancel</button>
            <button class="btn btn-primary" id="save-to-project-btn">Save to Project</button>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 class="share-modal-title" style="margin: 0;">Share Analysis</h2>
                <button class="close-panel-btn" id="close-share-modal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <p style="color: var(--stone-600); margin-bottom: 16px;">Anyone with this link can view this analysis.</p>
            <div class="share-link-input">
                <input type="text" id="share-link" readonly value="https://oppgrid.com/share/abc123xyz">
                <button class="btn btn-primary" id="copy-share-link">Copy</button>
            </div>
            <div class="share-options">
                <button class="share-option-btn" data-share="email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    Email
                </button>
                <button class="share-option-btn" data-share="twitter">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
                    Twitter
                </button>
                <button class="share-option-btn" data-share="linkedin">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg>
                    LinkedIn
                </button>
            </div>
        </div>
    </div>

    <!-- Celebration Overlay -->
    <div class="celebration-overlay" id="celebration-overlay">
        <div class="celebration-card">
            <div class="celebration-icon">🎉</div>
            <h2 class="celebration-title">Deep Dive Complete!</h2>
            <p class="celebration-subtitle">You've explored all 9 analysis sections. Great work!</p>
            <button class="btn btn-primary" id="close-celebration" style="padding: 12px 32px;">Continue Exploring</button>
        </div>
    </div>

    <!-- AI Chat Toggle Button -->
    <button class="ai-chat-toggle" id="ai-chat-toggle" title="AI Research Assistant">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
    </button>

    <!-- AI Chat Panel -->
    <div class="ai-chat-panel" id="ai-chat-panel">
        <div class="ai-chat-header">
            <div class="ai-chat-header-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: white;">
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                </svg>
            </div>
            <div>
                <div class="ai-chat-header-title">AI Research Assistant</div>
                <div class="ai-chat-header-subtitle">Powered by deep analysis of 2,847 data points</div>
            </div>
        </div>
        <div class="ai-chat-messages" id="ai-chat-messages">
            <div class="ai-message ai">
                Hi! I'm your AI research assistant. I can help you explore this opportunity. Try asking me:
                <div class="ai-suggestions">
                    <button class="ai-suggestion" data-question="Where should I launch this geographically?">Where should I launch this geographically?</button>
                    <button class="ai-suggestion" data-question="What are the biggest risks?">What are the biggest risks?</button>
                    <button class="ai-suggestion" data-question="How should I price the product?">How should I price the product?</button>
                </div>
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="ai-chat-input" placeholder="Ask about this opportunity...">
            <button id="ai-send-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </button>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Geographic data
        const geoData = {
            'us-national': {
                marketSize: '$8.4B',
                submissions: '2,847',
                growth: '+34%',
                competition: 'High',
                applicability: 'High',
                applicabilityClass: 'high',
                recommendation: 'National opportunity with strong metro-by-metro demand. Consider regional launch strategy.'
            },
            'us-southwest': {
                marketSize: '$1.2B',
                submissions: '847',
                growth: '+52%',
                competition: 'Medium',
                applicability: 'Very High',
                applicabilityClass: 'very-high',
                recommendation: 'Best launch region - highest growth (+52%), favorable regulations, lower competition.'
            },
            'canada': {
                marketSize: '$2.1B CAD',
                submissions: '412',
                growth: '+28%',
                competition: 'Low',
                applicability: 'High',
                applicabilityClass: 'high',
                recommendation: 'Strong market but complex entry requirements. Provincial regulations + bilingual needs.'
            },
            'uk': {
                marketSize: '£1.8B',
                submissions: '234',
                growth: '+19%',
                competition: 'High',
                applicability: 'Medium',
                applicabilityClass: 'medium',
                recommendation: 'Established market but requires localization and different trade certifications.'
            },
            'australia': {
                marketSize: '$1.4B AUD',
                submissions: '189',
                growth: '+31%',
                competition: 'Low',
                applicability: 'Medium',
                applicabilityClass: 'medium',
                recommendation: 'Emerging opportunity with less competition but smaller market size.'
            },
            'global': {
                marketSize: '$47B+',
                submissions: '4,821',
                growth: '+29%',
                competition: 'Varies',
                applicability: 'Varies',
                applicabilityClass: 'medium',
                recommendation: 'Long-term expansion opportunity - prioritize proven markets first.'
            }
        };

        // Geographic tab switching
        document.querySelectorAll('.geo-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const region = tab.dataset.region;
                const data = geoData[region];
                
                document.querySelectorAll('.geo-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.getElementById('geo-market-size').textContent = data.marketSize;
                document.getElementById('geo-submissions').textContent = data.submissions;
                document.getElementById('geo-growth').textContent = data.growth;
                document.getElementById('geo-competition').textContent = data.competition;
                document.getElementById('geo-applicability').textContent = data.applicability;
                document.getElementById('geo-applicability').className = 'applicability-badge ' + data.applicabilityClass;
                document.getElementById('geo-assessment').className = 'geo-assessment ' + data.applicabilityClass;
                document.getElementById('geo-recommendation').textContent = data.recommendation;
            });
        });

        // Tier tab switching
        document.querySelectorAll('.tier-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tier = tab.dataset.tier;
                
                document.querySelectorAll('.tier-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.getElementById('tier-nav').className = 'tier-nav tier-' + tier;
                
                document.querySelectorAll('.tier-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById('tier-' + tier).style.display = 'block';
            });
        });

        // Research Dashboard tab switching
        document.querySelectorAll('.research-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                
                document.querySelectorAll('.research-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                document.querySelectorAll('.research-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                document.getElementById('panel-' + tabId).classList.add('active');
            });
        });

        // Region card selection in Research Dashboard
        document.querySelectorAll('.region-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.region-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            });
        });

        // AI Chat functionality
        const aiChatToggle = document.getElementById('ai-chat-toggle');
        const aiChatPanel = document.getElementById('ai-chat-panel');
        const aiChatInput = document.getElementById('ai-chat-input');
        const aiSendBtn = document.getElementById('ai-send-btn');
        const aiMessages = document.getElementById('ai-chat-messages');
        let conversationHistory = [];
        let currentOpportunityId = null;

        aiChatToggle.addEventListener('click', () => {
            aiChatPanel.classList.toggle('open');
        });

        function formatAIResponse(text) {
            return text
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- /gm, '• ')
                .replace(/^(\d+)\. /gm, '<strong>$1.</strong> ');
        }

        function addTypingIndicator() {
            const typing = document.createElement('div');
            typing.className = 'ai-message ai';
            typing.id = 'typing-indicator';
            typing.innerHTML = '<span style="opacity: 0.6;">Thinking...</span>';
            aiMessages.appendChild(typing);
            aiMessages.scrollTop = aiMessages.scrollHeight;
            return typing;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function renderSuggestions(suggestions) {
            if (!suggestions || suggestions.length === 0) return '';
            return `<div class="ai-suggestions">${suggestions.map(s => 
                `<button class="ai-suggestion" data-question="${s}">${s}</button>`
            ).join('')}</div>`;
        }

        async function sendMessage(text) {
            if (!text.trim()) return;
            
            if (!currentOpportunityId) {
                const errorMsg = document.createElement('div');
                errorMsg.className = 'ai-message ai';
                errorMsg.innerHTML = '<span style="color: #b91c1c;">Please wait for the opportunity to load before asking questions.</span>';
                aiMessages.appendChild(errorMsg);
                aiMessages.scrollTop = aiMessages.scrollHeight;
                return;
            }
            
            const userMsg = document.createElement('div');
            userMsg.className = 'ai-message user';
            userMsg.textContent = text;
            aiMessages.appendChild(userMsg);
            aiChatInput.value = '';
            aiMessages.scrollTop = aiMessages.scrollHeight;
            
            conversationHistory.push({ role: 'user', content: text });
            addTypingIndicator();
            
            try {
                const response = await api.sendAIMessage(text, currentOpportunityId, conversationHistory);
                
                conversationHistory.push({ role: 'assistant', content: response.response });
                
                const aiMsg = document.createElement('div');
                aiMsg.className = 'ai-message ai';
                aiMsg.innerHTML = formatAIResponse(response.response);
                
                if (response.suggestions && response.suggestions.length > 0) {
                    aiMsg.innerHTML += renderSuggestions(response.suggestions);
                }
                
                aiMessages.appendChild(aiMsg);
                aiMessages.scrollTop = aiMessages.scrollHeight;
                
                aiMsg.querySelectorAll('.ai-suggestion').forEach(btn => {
                    btn.addEventListener('click', () => sendMessage(btn.dataset.question));
                });
                
            } catch (error) {
                conversationHistory.pop();
                console.error('AI chat error:', error);
                
                const errorMsg = document.createElement('div');
                errorMsg.className = 'ai-message ai';
                errorMsg.innerHTML = '<span style="color: #b91c1c;">Sorry, I encountered an error. Please try again.</span>';
                aiMessages.appendChild(errorMsg);
                aiMessages.scrollTop = aiMessages.scrollHeight;
            } finally {
                removeTypingIndicator();
            }
        }

        aiSendBtn.addEventListener('click', () => sendMessage(aiChatInput.value));
        aiChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage(aiChatInput.value);
        });

        document.querySelectorAll('.ai-suggestion').forEach(btn => {
            btn.addEventListener('click', () => {
                sendMessage(btn.dataset.question);
            });
        });

        // User subscription state
        let userSubscription = {
            tier: 'free',
            isUnlocked: false,
            viewsRemaining: 0
        };

        // Load opportunity data from API
        async function loadOpportunityData() {
            const urlParams = new URLSearchParams(window.location.search);
            const opportunityId = urlParams.get('id');
            
            if (!opportunityId) {
                console.log('No opportunity ID provided');
                return;
            }
            
            currentOpportunityId = parseInt(opportunityId, 10);
            
            // Check user subscription status
            await checkUserSubscription();
            
            try {
                const opp = await api.getOpportunity(opportunityId);
                
                document.getElementById('opportunity-id').textContent = `IDEA #${opp.id}`;
                document.getElementById('opportunity-title').textContent = opp.ai_generated_title || opp.title;
                document.title = `${opp.title} · OppGrid`;
                
                // Use AI score if available, otherwise calculate
                const score = opp.ai_opportunity_score || Math.min(100, Math.round(50 + (opp.validation_count / 10) + (opp.growth_rate || 0)));
                document.getElementById('validation-score').textContent = `${score}/100`;
                
                document.getElementById('opportunity-description').textContent = opp.ai_problem_statement || opp.description;
                
                // Populate metrics cards from API data
                populateMetrics(opp);
                
                // Load source data if available (only if raw_source_data exists)
                if (opp.raw_source_data) {
                    loadSourceData(opp.id);
                }
                
                // Update page with AI insights if available
                updatePageWithAIInsights(opp);
                
                // Populate pain points from description
                populatePainPoints(opp);
                
                // Load related opportunities
                loadRelatedOpportunities(opp.category, opp.id);
                
                // Apply subscription-based gating
                applySubscriptionGating();
                
                // Display access info banner
                displayAccessInfo(opp);
                
                loadAISuggestions(opp);
                
            } catch (error) {
                console.error('Failed to load opportunity:', error);
            }
        }

        function displayAccessInfo(opp) {
            const banner = document.getElementById('access-info-banner');
            const badge = document.getElementById('freshness-badge');
            const message = document.getElementById('access-message');
            const cta = document.getElementById('access-cta');
            
            if (!banner) return;
            
            // Check if we have access_info from API
            if (opp.access_info) {
                const info = opp.access_info;
                const fb = info.freshness_badge;
                
                // Set freshness badge
                badge.innerHTML = `${fb.icon} ${fb.label}`;
                badge.style.background = `${fb.color}15`;
                badge.style.color = fb.color;
                badge.style.border = `1px solid ${fb.color}30`;
                
                // Set access message
                if (info.is_accessible || info.is_unlocked) {
                    message.innerHTML = `<span style="color: #22c55e;">✓</span> Full access available · <strong>${info.age_days} days old</strong>`;
                    cta.innerHTML = '';
                } else if (info.can_pay_to_unlock) {
                    message.innerHTML = `Archive opportunity · <strong>${info.age_days} days old</strong>`;
                    cta.innerHTML = `
                        <button onclick="handlePayPerUnlock()" class="btn" style="background: #f59e0b; color: white; border: none; padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; cursor: pointer;">
                            🔓 Unlock for $${(info.unlock_price / 100).toFixed(0)}
                        </button>
                        <a href="pricing.html" class="btn" style="background: var(--violet-600); color: white; border: none; padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; text-decoration: none;">
                            Upgrade to Pro
                        </a>
                    `;
                } else if (info.days_until_unlock > 0) {
                    message.innerHTML = `Unlocks for ${info.user_tier || 'your tier'} in <strong style="color: var(--violet-600);">${info.days_until_unlock} days</strong>`;
                    cta.innerHTML = `
                        <a href="pricing.html" class="btn" style="background: var(--violet-600); color: white; border: none; padding: 8px 16px; font-size: 13px; font-weight: 600; border-radius: 8px; text-decoration: none;">
                            Get Earlier Access
                        </a>
                    `;
                }
                
                banner.style.display = 'block';
            } else {
                // Fallback to calculating locally
                const createdAt = opp.created_at ? new Date(opp.created_at) : new Date();
                const now = new Date();
                const ageDays = Math.floor((now - createdAt) / (1000 * 60 * 60 * 24));
                
                let fb = { icon: '📚', label: 'ARCHIVE', color: '#6b7280' };
                if (ageDays <= 7) fb = { icon: '🔥', label: 'HOT', color: '#ef4444' };
                else if (ageDays <= 30) fb = { icon: '⚡', label: 'FRESH', color: '#f97316' };
                else if (ageDays <= 90) fb = { icon: '✓', label: 'VALIDATED', color: '#22c55e' };
                
                badge.innerHTML = `${fb.icon} ${fb.label}`;
                badge.style.background = `${fb.color}15`;
                badge.style.color = fb.color;
                badge.style.border = `1px solid ${fb.color}30`;
                
                message.innerHTML = `<strong>${ageDays} days old</strong>`;
                
                banner.style.display = 'block';
            }
        }

        async function checkUserSubscription() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                userSubscription = { tier: 'free', isUnlocked: false, viewsRemaining: 0 };
                return;
            }
            
            try {
                const response = await fetch('/api/v1/subscriptions/my-subscription', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    userSubscription.tier = data.tier || 'free';
                    userSubscription.viewsRemaining = data.views_remaining || 0;
                }
                
                // Check if this specific opportunity is unlocked
                const unlockResponse = await fetch(`/api/v1/subscriptions/unlocked/${currentOpportunityId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (unlockResponse.ok) {
                    const unlockData = await unlockResponse.json();
                    userSubscription.isUnlocked = unlockData.unlocked;
                    userSubscription.viewsRemaining = unlockData.remaining_unlocks;
                }
            } catch (error) {
                console.log('Could not check subscription status');
            }
        }

        function populateMetrics(opp) {
            // Submissions = validation_count
            const submissionsValue = opp.validation_count || 0;
            const submissionsFormatted = submissionsValue >= 1000 
                ? (submissionsValue / 1000).toFixed(submissionsValue >= 10000 ? 1 : 0) + 'K'
                : submissionsValue.toLocaleString();
            
            // Market Size from AI analysis
            const marketSize = opp.ai_market_size_estimate || opp.market_size || '$10M-$50M';
            
            // Urgency from AI analysis
            const urgency = opp.ai_urgency_level 
                ? opp.ai_urgency_level.charAt(0).toUpperCase() + opp.ai_urgency_level.slice(1) 
                : 'Medium';
            
            // Growth rate for submissions change
            const growthRate = opp.growth_rate || 0;
            const growthText = growthRate > 0 ? `↑ ${growthRate}% this month` : 'Trending';
            
            // Update the metrics grid HTML
            const metricsGrid = document.querySelector('.metrics-grid');
            if (metricsGrid) {
                metricsGrid.innerHTML = `
                    <div class="metric-card">
                        <div class="metric-header">
                            <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <div class="metric-label">Submissions</div>
                        </div>
                        <div class="metric-value">${submissionsFormatted}</div>
                        <div class="metric-change">${growthText}</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-header">
                            <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                <polyline points="17 6 23 6 23 12"></polyline>
                            </svg>
                            <div class="metric-label">Market Size</div>
                        </div>
                        <div class="metric-value">${marketSize}</div>
                        <div class="metric-change neutral">TAM estimate</div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-header">
                            <svg class="metric-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            <div class="metric-label">Urgency</div>
                        </div>
                        <div class="metric-value">${urgency}</div>
                        <div class="metric-change neutral">${urgency === 'Critical' || urgency === 'High' ? 'Immediate need' : 'Growing demand'}</div>
                    </div>
                `;
            }
        }

        function updatePageWithAIInsights(opp) {
            // AI insights now displayed in the metrics cards, no separate banner needed
        }

        let sourceDataLoaded = false;
        let sourceDataVisible = false;

        async function loadSourceData(opportunityId) {
            try {
                const response = await fetch(`/api/v1/scraper/source-data/${opportunityId}`);
                if (!response.ok) return;
                
                const data = await response.json();
                
                if (data.has_source_data && data.raw_data) {
                    document.getElementById('source-data-section').style.display = 'block';
                    
                    document.getElementById('source-platform-display').textContent = 
                        (data.source_platform || 'Unknown').charAt(0).toUpperCase() + 
                        (data.source_platform || 'unknown').slice(1);
                    
                    document.getElementById('source-original-title').textContent = 
                        data.raw_data.original_title || 'No title';
                    document.getElementById('source-original-body').textContent = 
                        data.raw_data.original_body || 'No content';
                    
                    document.getElementById('source-upvotes').textContent = 
                        data.raw_data.upvotes || 0;
                    document.getElementById('source-comments').textContent = 
                        data.raw_data.comments || 0;
                    document.getElementById('source-confidence').textContent = 
                        ((data.raw_data.confidence_score || 0) * 100).toFixed(0) + '%';
                    
                    const urlLink = document.getElementById('source-url-link');
                    if (data.source_url) {
                        urlLink.href = data.source_url;
                        urlLink.style.display = 'inline-block';
                    } else {
                        urlLink.style.display = 'none';
                    }
                    
                    sourceDataLoaded = true;
                }
            } catch (error) {
                console.log('Could not load source data');
            }
        }

        function toggleSourceData() {
            const content = document.getElementById('source-data-content');
            const btn = document.getElementById('toggle-source-btn');
            sourceDataVisible = !sourceDataVisible;
            
            if (sourceDataVisible) {
                content.style.display = 'block';
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                        <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                    Hide Raw Data
                `;
            } else {
                content.style.display = 'none';
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    View Raw Data
                `;
            }
        }

        function populatePainPoints(opp) {
            const container = document.getElementById('pain-points-container');
            if (!container) return;
            
            const painPoints = extractPainPoints(opp.description);
            const severities = ['Critical', 'High', 'High', 'Medium'];
            
            container.innerHTML = painPoints.map((point, index) => `
                <div class="pain-point slide-in" style="animation-delay: ${0.4 + index * 0.1}s;">
                    <div class="pain-point-quote">"${point}"</div>
                    <div class="pain-point-severity">Severity: ${severities[index] || 'Medium'}</div>
                </div>
            `).join('');
        }

        function extractPainPoints(description) {
            if (!description) return ['No pain points available'];
            
            const sentences = description.split(/[.!?]+/).filter(s => s.trim().length > 10);
            const painPhrases = sentences.filter(s => 
                /struggle|difficult|hard|frustrat|problem|issue|pain|lack|unable|can't|cannot|wish|need|want/i.test(s)
            );
            
            if (painPhrases.length >= 2) {
                return painPhrases.slice(0, 4).map(s => s.trim());
            }
            
            return sentences.slice(0, 3).map(s => s.trim());
        }

        async function loadRelatedOpportunities(category, currentId) {
            const container = document.getElementById('related-opportunities-list');
            if (!container) return;
            
            try {
                const response = await fetch(`/api/v1/opportunities?category=${encodeURIComponent(category)}&limit=5`);
                if (!response.ok) throw new Error('Failed to fetch');
                
                const data = await response.json();
                const related = (data.opportunities || data).filter(o => o.id !== currentId).slice(0, 3);
                
                if (related.length === 0) {
                    container.innerHTML = '<li class="related-item"><span>No related opportunities found</span></li>';
                    return;
                }
                
                container.innerHTML = related.map(opp => `
                    <li class="related-item">
                        <a href="opportunity.html?id=${opp.id}" style="display: flex; justify-content: space-between; align-items: center; width: 100%; text-decoration: none; color: inherit;">
                            <span>${opp.title}</span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </a>
                    </li>
                `).join('');
            } catch (error) {
                console.log('Could not load related opportunities');
                container.innerHTML = '<li class="related-item"><span>Related opportunities unavailable</span></li>';
            }
        }

        function applySubscriptionGating() {
            const isFullAccess = userSubscription.tier !== 'free' || userSubscription.isUnlocked;
            
            // Research tier - requires Pro or higher
            const researchTab = document.querySelector('.tier-tab[data-tier="research"]');
            const deepTab = document.querySelector('.tier-tab[data-tier="deep"]');
            
            if (userSubscription.tier === 'free' && !userSubscription.isUnlocked) {
                // Add lock icons and disable premium tabs for free users
                if (researchTab) {
                    researchTab.classList.add('locked');
                    if (!researchTab.querySelector('.lock-icon')) {
                        researchTab.innerHTML += ` <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>`;
                    }
                }
                if (deepTab) {
                    deepTab.classList.add('locked');
                    if (!deepTab.querySelector('.lock-icon')) {
                        deepTab.innerHTML += ` <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>`;
                    }
                }
                
                // Add paywall overlays to locked tiers
                addPaywallOverlay('tier-research', 'Pro');
                addPaywallOverlay('tier-deep', 'Business');
            }
        }

        function addPaywallOverlay(sectionId, requiredTier) {
            const section = document.getElementById(sectionId);
            if (!section || section.querySelector('.paywall-overlay')) return;
            
            const overlay = document.createElement('div');
            overlay.className = 'paywall-overlay';
            overlay.innerHTML = `
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,0.95) 30%, rgba(255,255,255,0.98) 100%); z-index: 10; display: flex; align-items: center; justify-content: center; pointer-events: all;">
                    <div style="text-align: center; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); max-width: 400px;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#292524" stroke-width="2" style="margin-bottom: 16px;">
                            <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                        <h3 style="font-family: 'Spectral', serif; font-size: 24px; color: #1c1917; margin-bottom: 8px;">Unlock Full Analysis</h3>
                        <p style="color: #78716c; font-size: 14px; margin-bottom: 24px; line-height: 1.6;">
                            Get access to detailed market research, competitive analysis, and AI-powered business recommendations.
                        </p>
                        ${userSubscription.viewsRemaining > 0 ? `
                            <button onclick="unlockOpportunity()" class="btn btn-primary" style="width: 100%; margin-bottom: 12px; justify-content: center;">
                                Unlock This Opportunity (${userSubscription.viewsRemaining} views left)
                            </button>
                            <p style="font-size: 12px; color: #a8a29e;">or</p>
                        ` : ''}
                        <a href="pricing.html" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #292524, #292524); color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; margin-top: 8px;">
                            Upgrade to ${requiredTier}
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M5 12h14"/>
                                <path d="m12 5 7 7-7 7"/>
                            </svg>
                        </a>
                    </div>
                </div>
            `;
            section.style.position = 'relative';
            section.appendChild(overlay);
        }

        async function unlockOpportunity() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'signin.html';
                return;
            }
            
            try {
                const response = await fetch('/api/v1/subscriptions/unlock', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ opportunity_id: currentOpportunityId })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userSubscription.isUnlocked = true;
                    userSubscription.viewsRemaining = data.remaining_unlocks;
                    
                    // Remove paywall overlays
                    document.querySelectorAll('.paywall-overlay').forEach(el => el.remove());
                    document.querySelectorAll('.tier-tab.locked').forEach(tab => {
                        tab.classList.remove('locked');
                        const lockIcon = tab.querySelector('.lock-icon');
                        if (lockIcon) lockIcon.remove();
                    });
                    
                    // Reload to show full content
                    location.reload();
                } else {
                    const error = await response.json();
                    alert(error.detail || 'Unable to unlock. Please try again.');
                }
            } catch (error) {
                console.error('Unlock error:', error);
                alert('Unable to unlock. Please try again.');
            }
        }

        async function handleUnlockResearch() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                // Not logged in - redirect to sign-in and return here
                OppGridAuth.redirectToSignin({ redirect: window.location.href });
                return;
            }
            
            try {
                // User is logged in - create checkout session for pro tier
                const response = await fetch('/api/v1/subscriptions/checkout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tier: 'pro',
                        success_url: window.location.href,
                        cancel_url: window.location.href
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Redirect to Stripe checkout
                    window.location.href = data.url || data.checkout_url;
                } else {
                    const error = await response.json();
                    if (error.detail && error.detail.includes('already')) {
                        // User already has pro or higher - just switch to research tab
                        switchTier('research');
                    } else {
                        alert(error.detail || 'Unable to start checkout. Please try again.');
                    }
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Unable to start checkout. Please try again.');
            }
        }

        // Pay-per-unlock for archive opportunities ($15)
        let stripeInstance = null;
        
        async function initStripe() {
            if (stripeInstance) return stripeInstance;
            try {
                const response = await fetch('/api/v1/subscriptions/stripe-key');
                if (response.ok) {
                    const data = await response.json();
                    if (window.Stripe && data.publishable_key) {
                        stripeInstance = window.Stripe(data.publishable_key);
                    }
                }
            } catch (e) {
                console.log('Stripe init skipped');
            }
            return stripeInstance;
        }

        async function handlePayPerUnlock() {
            const token = localStorage.getItem('access_token');
            
            if (!token) {
                OppGridAuth.redirectToSignin({ redirect: window.location.href });
                return;
            }
            
            try {
                // Create payment intent
                const response = await fetch('/api/v1/subscriptions/pay-per-unlock', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ opportunity_id: currentOpportunityId })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    if (error.detail && error.detail.includes('91+')) {
                        // Opportunity not old enough - show upgrade prompt
                        alert('This opportunity is not yet available for pay-per-unlock. Upgrade to Pro for immediate access.');
                    } else if (error.detail && error.detail.includes('already')) {
                        location.reload();
                    } else {
                        alert(error.detail || 'Unable to process. Please try again.');
                    }
                    return;
                }
                
                const data = await response.json();
                
                // Initialize Stripe and confirm payment
                const stripe = await initStripe();
                if (!stripe) {
                    alert('Payment system not available. Please try again later.');
                    return;
                }
                
                // Show payment element (simplified - uses Stripe's payment sheet)
                const { error } = await stripe.confirmPayment({
                    clientSecret: data.client_secret,
                    confirmParams: {
                        return_url: window.location.href + '?payment_intent=' + data.payment_intent_id,
                    }
                });
                
                if (error) {
                    alert(error.message);
                }
            } catch (error) {
                console.error('Pay-per-unlock error:', error);
                alert('Unable to process payment. Please try again.');
            }
        }

        // Check for successful payment on page load
        async function checkPaymentSuccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentIntentId = urlParams.get('payment_intent');
            
            if (paymentIntentId) {
                const token = localStorage.getItem('access_token');
                if (!token) return;
                
                try {
                    const response = await fetch(`/api/v1/subscriptions/confirm-pay-per-unlock?payment_intent_id=${paymentIntentId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        // Remove payment_intent from URL and reload
                        const newUrl = window.location.pathname + '?id=' + currentOpportunityId;
                        window.history.replaceState({}, '', newUrl);
                        location.reload();
                    }
                } catch (e) {
                    console.error('Payment confirmation error:', e);
                }
            }
        }
        
        async function loadAISuggestions(opportunity) {
            try {
                const data = await api.getAISuggestions(opportunity.id);
                
                const greetingHtml = `
                    <div class="ai-message ai">
                        ${data.greeting}
                        ${renderSuggestions(data.suggestions)}
                    </div>
                `;
                aiMessages.innerHTML = greetingHtml;
                
                aiMessages.querySelectorAll('.ai-suggestion').forEach(btn => {
                    btn.addEventListener('click', () => sendMessage(btn.dataset.question));
                });
                
            } catch (error) {
                console.log('Could not load AI suggestions:', error);
            }
        }

        // Deep Dive Console Functionality
        const deepDiveState = {
            activeCategory: 'executive',
            sidebarOpen: true,
            messages: [],
            categoryCompletion: {
                'market-validation': { completed: false, interactions: 0 },
                'geographic': { completed: true, interactions: 5 },
                'problem-analysis': { completed: false, interactions: 0 },
                'opportunity-sizing': { completed: false, interactions: 2 },
                'solution-pathways': { completed: false, interactions: 0 },
                'executive': { completed: true, interactions: 3 },
                'financial': { completed: false, interactions: 1 },
                'execution': { completed: false, interactions: 0 },
                'data': { completed: false, interactions: 0 }
            },
            savedThreads: []
        };

        const categoryNames = {
            'market-validation': 'Market Validation',
            'geographic': 'Geographic Distribution',
            'problem-analysis': 'Problem Analysis',
            'opportunity-sizing': 'Opportunity Sizing',
            'solution-pathways': 'Solution Pathways',
            'executive': 'Executive Summary',
            'financial': 'Financial Modeling',
            'execution': 'Execution Playbook',
            'data': 'Raw Data & Exports'
        };

        const categoryQuestions = {
            'market-validation': 'Analyze market validation signals and demand trends',
            'geographic': 'Where should I launch this business geographically?',
            'problem-analysis': 'Break down the problem categories and pain point severity',
            'opportunity-sizing': 'Calculate TAM, SAM, and SOM for this opportunity',
            'solution-pathways': 'What features should the solution prioritize?',
            'executive': 'Give me an executive summary of this opportunity',
            'financial': 'Build a detailed financial model with projections',
            'execution': 'Create a 90-day execution playbook',
            'data': 'What raw data and exports are available?'
        };

        function initDeepDiveConsole() {
            const sidebar = document.getElementById('deep-dive-sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebarExpandBtn = document.getElementById('sidebar-expand-btn');
            const consoleInput = document.getElementById('console-input');
            const consoleSendBtn = document.getElementById('console-send-btn');
            const saveExportBtn = document.getElementById('save-export-btn');
            const saveMenu = document.getElementById('save-menu');
            const consoleNewBtn = document.getElementById('console-new-btn');

            if (!sidebar) return;

            // Sidebar toggle
            sidebarToggle?.addEventListener('click', () => {
                sidebar.classList.add('collapsed');
                sidebarExpandBtn.style.display = 'block';
                deepDiveState.sidebarOpen = false;
            });

            sidebarExpandBtn?.addEventListener('click', () => {
                sidebar.classList.remove('collapsed');
                sidebarExpandBtn.style.display = 'none';
                deepDiveState.sidebarOpen = true;
            });

            // Category card clicks
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.category-check')) return;
                    const category = card.dataset.category;
                    setActiveCategory(category);
                });
            });

            // Category completion toggles
            document.querySelectorAll('.category-check').forEach(check => {
                check.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const category = check.dataset.category;
                    toggleCompletion(category);
                });
            });

            // Console input
            consoleInput?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendConsoleMessage();
            });

            consoleSendBtn?.addEventListener('click', sendConsoleMessage);

            // Console suggestions
            document.querySelectorAll('.console-suggestion').forEach(btn => {
                btn.addEventListener('click', () => {
                    const question = btn.dataset.question;
                    document.getElementById('console-input').value = question;
                    sendConsoleMessage();
                });
            });

            // Save & Export menu
            saveExportBtn?.addEventListener('click', () => {
                saveMenu.classList.toggle('open');
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.console-header-right')) {
                    saveMenu?.classList.remove('open');
                }
            });

            document.getElementById('save-confirm-btn')?.addEventListener('click', saveConversation);

            document.querySelectorAll('.export-option').forEach(opt => {
                opt.addEventListener('click', () => {
                    exportConversation(opt.dataset.format);
                });
            });

            // New conversation button
            consoleNewBtn?.addEventListener('click', () => {
                if (deepDiveState.messages.length > 0) {
                    if (confirm('Start a new conversation? Current conversation will be saved.')) {
                        saveConversation();
                        deepDiveState.messages = [];
                        renderConsoleMessages();
                        consoleNewBtn.style.display = 'none';
                    }
                }
            });

            updateProgress();
            loadSavedThreads();
        }

        function setActiveCategory(category) {
            deepDiveState.activeCategory = category;
            
            // Update UI
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.toggle('active', card.dataset.category === category);
            });

            document.getElementById('console-subtitle').textContent = categoryNames[category];

            // Track interaction
            deepDiveState.categoryCompletion[category].interactions++;
            updateCategoryInteractions(category);

            // Set suggested question
            document.getElementById('console-input').value = categoryQuestions[category];
        }

        function toggleCompletion(category) {
            const completion = deepDiveState.categoryCompletion[category];
            completion.completed = !completion.completed;

            const check = document.querySelector(`.category-check[data-category="${category}"]`);
            if (completion.completed) {
                check.classList.add('completed');
                check.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 10px; height: 10px;"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            } else {
                check.classList.remove('completed');
                check.innerHTML = '';
            }

            updateProgress();
        }

        function updateProgress() {
            const completed = Object.values(deepDiveState.categoryCompletion).filter(c => c.completed).length;
            const total = 9;
            const percent = Math.round((completed / total) * 100);

            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-count').textContent = `${completed} of ${total} sections completed`;
        }

        function updateCategoryInteractions(category) {
            const count = deepDiveState.categoryCompletion[category].interactions;
            const el = document.querySelector(`.category-card[data-category="${category}"] .category-interactions`);
            if (el) {
                el.textContent = count > 0 ? `${count} interactions` : '';
            }
        }

        function updateAutosave() {
            const indicator = document.getElementById('autosave-indicator');
            const text = document.getElementById('autosave-text');
            if (deepDiveState.messages.length > 0) {
                indicator.style.display = 'flex';
                text.textContent = `Auto-saved ${deepDiveState.messages.length} messages`;
                document.getElementById('console-new-btn').style.display = 'flex';
            } else {
                indicator.style.display = 'none';
                document.getElementById('console-new-btn').style.display = 'none';
            }
        }

        async function sendConsoleMessage() {
            const input = document.getElementById('console-input');
            const text = input.value.trim();
            if (!text) return;

            input.value = '';

            // Add user message
            deepDiveState.messages.push({ type: 'user', content: text, timestamp: new Date() });
            renderConsoleMessages();

            // Track interaction
            if (deepDiveState.activeCategory) {
                deepDiveState.categoryCompletion[deepDiveState.activeCategory].interactions++;
                updateCategoryInteractions(deepDiveState.activeCategory);
            }

            // Show thinking indicator
            showThinking();

            try {
                if (currentOpportunityId) {
                    // Get bookmarked message contents for AI context
                    const bookmarkedContents = bookmarkedMessages
                        .filter(idx => deepDiveState.messages[idx])
                        .map(idx => deepDiveState.messages[idx].content)
                        .slice(0, 5);
                    
                    const response = await api.sendAIMessage(
                        text, 
                        currentOpportunityId, 
                        deepDiveState.messages.map(m => ({
                            role: m.type === 'user' ? 'user' : 'assistant',
                            content: m.content
                        })),
                        deepDiveState.activeCategory,
                        bookmarkedContents
                    );
                    
                    hideThinking();
                    deepDiveState.messages.push({ 
                        type: 'ai', 
                        content: response.response, 
                        suggestions: response.suggestions,
                        timestamp: new Date() 
                    });
                } else {
                    // Fallback response if no opportunity loaded
                    hideThinking();
                    deepDiveState.messages.push({ 
                        type: 'ai', 
                        content: `Based on the Deep Dive analysis for "${text}", the platform has analyzed 2,847 consumer submissions to validate this opportunity. This analysis provides comprehensive insights across market validation, geographic distribution, problem analysis, opportunity sizing, and solution pathways.`,
                        timestamp: new Date() 
                    });
                }
            } catch (error) {
                console.error('Console AI error:', error);
                hideThinking();
                deepDiveState.messages.push({ 
                    type: 'ai', 
                    content: 'Sorry, I encountered an error processing your request. Please try again.',
                    timestamp: new Date() 
                });
            }

            renderConsoleMessages();
            updateAutosave();
        }

        function showThinking() {
            const messagesEl = document.getElementById('console-messages');
            const thinking = document.createElement('div');
            thinking.id = 'console-thinking';
            thinking.className = 'console-thinking';
            thinking.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10" stroke-dasharray="30" stroke-dashoffset="10"></circle></svg> Thinking...';
            messagesEl.appendChild(thinking);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function hideThinking() {
            document.getElementById('console-thinking')?.remove();
        }

        let bookmarkedMessages = JSON.parse(localStorage.getItem('oppgrid_bookmarks') || '[]');

        function renderConsoleMessages() {
            const messagesEl = document.getElementById('console-messages');
            
            let html = '<div class="console-message ai"><div class="console-message-content">Welcome to the Deep Dive AI Research Console! I have access to comprehensive analysis across 2,847 validated data points. Select a category from the sidebar or ask me anything about this opportunity.</div></div>';
            
            deepDiveState.messages.forEach((msg, idx) => {
                const isBookmarked = bookmarkedMessages.includes(idx);
                const isLong = msg.content && msg.content.length > 500;
                
                html += `<div class="console-message ${msg.type}" data-msg-idx="${idx}">`;
                html += `<div class="console-message-content${isLong ? ' collapsed' : ''}" data-msg-idx="${idx}">${formatAIResponse(msg.content)}`;
                
                if (msg.suggestions && msg.suggestions.length > 0) {
                    html += '<div class="console-suggestions">';
                    msg.suggestions.forEach(s => {
                        html += `<button class="console-suggestion" data-question="${s}">${s}</button>`;
                    });
                    html += '</div>';
                }
                html += '</div>';
                
                if (isLong) {
                    html += `<button class="expand-message-btn" data-msg-idx="${idx}">Show more</button>`;
                }
                
                html += `<div class="message-actions">`;
                html += `<button class="message-action-btn copy-btn" data-msg-idx="${idx}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copy</button>`;
                html += `<button class="message-action-btn bookmark-btn ${isBookmarked ? 'bookmarked' : ''}" data-msg-idx="${idx}"><svg viewBox="0 0 24 24" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg> ${isBookmarked ? 'Bookmarked' : 'Bookmark'}</button>`;
                html += `</div>`;
                html += '</div>';
            });

            messagesEl.innerHTML = html;
            messagesEl.scrollTop = messagesEl.scrollHeight;

            // Re-attach suggestion listeners
            messagesEl.querySelectorAll('.console-suggestion').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('console-input').value = btn.dataset.question;
                    sendConsoleMessage();
                });
            });
            
            // Attach message action listeners
            messagesEl.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.msgIdx);
                    const msg = deepDiveState.messages[idx];
                    if (msg) {
                        navigator.clipboard.writeText(msg.content).then(() => {
                            btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg> Copied!';
                            setTimeout(() => {
                                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copy';
                            }, 1500);
                        });
                    }
                });
            });
            
            messagesEl.querySelectorAll('.bookmark-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = parseInt(btn.dataset.msgIdx);
                    if (bookmarkedMessages.includes(idx)) {
                        bookmarkedMessages = bookmarkedMessages.filter(i => i !== idx);
                    } else {
                        bookmarkedMessages.push(idx);
                    }
                    localStorage.setItem('oppgrid_bookmarks', JSON.stringify(bookmarkedMessages));
                    renderConsoleMessages();
                });
            });
            
            messagesEl.querySelectorAll('.expand-message-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = btn.dataset.msgIdx;
                    const content = messagesEl.querySelector(`.console-message-content[data-msg-idx="${idx}"]`);
                    if (content) {
                        const isCollapsed = content.classList.contains('collapsed');
                        content.classList.toggle('collapsed');
                        btn.textContent = isCollapsed ? 'Show less' : 'Show more';
                    }
                });
            });
        }

        function saveConversation() {
            if (deepDiveState.messages.length === 0) return;
            
            const nameInput = document.getElementById('save-name-input');
            const name = nameInput.value.trim() || `Analysis ${new Date().toLocaleDateString()}`;
            
            const thread = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString().split('T')[0],
                messages: [...deepDiveState.messages],
                category: deepDiveState.activeCategory
            };
            
            deepDiveState.savedThreads.push(thread);
            
            // Persist to localStorage
            try {
                const saved = JSON.parse(localStorage.getItem('oppgrid_saved_threads') || '[]');
                saved.push(thread);
                localStorage.setItem('oppgrid_saved_threads', JSON.stringify(saved));
            } catch (e) {
                console.log('Could not save to localStorage:', e);
            }

            nameInput.value = '';
            document.getElementById('save-menu').classList.remove('open');
            alert(`Saved as "${name}"`);
        }
        
        function loadSavedThreads() {
            try {
                const saved = JSON.parse(localStorage.getItem('oppgrid_saved_threads') || '[]');
                deepDiveState.savedThreads = saved;
            } catch (e) {
                console.log('Could not load saved threads:', e);
            }
        }

        function exportConversation(format) {
            if (deepDiveState.messages.length === 0) {
                alert('No conversation to export');
                return;
            }

            const opportunityTitle = document.getElementById('opportunity-title')?.textContent || 'Opportunity Analysis';
            const exportDate = new Date().toISOString();

            const exportData = {
                opportunity: opportunityTitle,
                date: exportDate,
                category: deepDiveState.activeCategory,
                messages: deepDiveState.messages
            };

            if (format === 'json') {
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `oppgrid-analysis-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'markdown') {
                let md = `# ${opportunityTitle}\n\n`;
                md += `**Date:** ${new Date(exportDate).toLocaleDateString()}\n`;
                md += `**Category:** ${deepDiveState.activeCategory || 'General'}\n\n`;
                md += `---\n\n## Conversation\n\n`;
                
                deepDiveState.messages.forEach((msg, idx) => {
                    const speaker = msg.type === 'user' ? '**You:**' : '**AI:**';
                    md += `${speaker}\n\n${msg.content}\n\n`;
                    if (idx < deepDiveState.messages.length - 1) md += '---\n\n';
                });
                
                const blob = new Blob([md], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `oppgrid-analysis-${Date.now()}.md`;
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'text') {
                let txt = `${opportunityTitle}\n${'='.repeat(opportunityTitle.length)}\n\n`;
                txt += `Date: ${new Date(exportDate).toLocaleDateString()}\n`;
                txt += `Category: ${deepDiveState.activeCategory || 'General'}\n\n`;
                txt += `-`.repeat(50) + `\n\n`;
                
                deepDiveState.messages.forEach((msg) => {
                    const speaker = msg.type === 'user' ? 'You:' : 'AI:';
                    txt += `${speaker}\n${msg.content}\n\n`;
                });
                
                const blob = new Blob([txt], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `oppgrid-analysis-${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);
            }

            document.getElementById('save-menu').classList.remove('open');
        }

        // ============ NEW FEATURES ============

        // Dark Mode Toggle
        function initThemeToggle() {
            const toggle = document.getElementById('theme-toggle');
            const lightIcon = document.getElementById('theme-icon-light');
            const darkIcon = document.getElementById('theme-icon-dark');
            
            const savedTheme = localStorage.getItem('oppgrid_theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                lightIcon.style.display = 'none';
                darkIcon.style.display = 'block';
            }
            
            toggle?.addEventListener('click', () => {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                if (isDark) {
                    document.documentElement.removeAttribute('data-theme');
                    lightIcon.style.display = 'block';
                    darkIcon.style.display = 'none';
                    localStorage.setItem('oppgrid_theme', 'light');
                } else {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    lightIcon.style.display = 'none';
                    darkIcon.style.display = 'block';
                    localStorage.setItem('oppgrid_theme', 'dark');
                }
            });
        }

        // Keyboard Shortcuts
        function initKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                const cmdKey = isMac ? e.metaKey : e.ctrlKey;
                
                // Cmd+Enter to send message
                if (cmdKey && e.key === 'Enter') {
                    e.preventDefault();
                    const consoleInput = document.getElementById('console-input');
                    if (document.activeElement === consoleInput || consoleInput.value.trim()) {
                        sendConsoleMessage();
                    }
                }
                
                // Cmd+S to save conversation
                if (cmdKey && e.key === 's') {
                    e.preventDefault();
                    if (deepDiveState.messages.length > 0) {
                        saveConversation();
                    }
                }
                
                // Arrow keys for category navigation
                if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                    const categories = ['market-validation', 'geographic', 'problem-analysis', 'opportunity-sizing', 'solution-pathways', 'executive', 'financial', 'execution', 'data'];
                    const currentIndex = categories.indexOf(deepDiveState.activeCategory);
                    
                    if (e.key === 'ArrowUp' && currentIndex > 0) {
                        setActiveCategory(categories[currentIndex - 1]);
                    } else if (e.key === 'ArrowDown' && currentIndex < categories.length - 1) {
                        setActiveCategory(categories[currentIndex + 1]);
                    }
                }

                // Escape to close panels
                if (e.key === 'Escape') {
                    closePanels();
                }
            });
        }

        // Saved Threads Panel
        function initSavedThreadsPanel() {
            const btn = document.getElementById('saved-threads-btn');
            const panel = document.getElementById('saved-threads-panel');
            const closeBtn = document.getElementById('close-threads-btn');
            const overlay = document.getElementById('panel-overlay');
            
            btn?.addEventListener('click', () => {
                panel.classList.add('open');
                overlay.classList.add('active');
                renderSavedThreadsList();
            });
            
            closeBtn?.addEventListener('click', closePanels);
            overlay?.addEventListener('click', closePanels);
        }
        
        function renderSavedThreadsList() {
            const list = document.getElementById('saved-threads-list');
            const threads = deepDiveState.savedThreads;
            
            if (threads.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--stone-500); padding: 40px 20px;">No saved threads yet. Save a conversation to see it here.</p>';
                return;
            }
            
            list.innerHTML = threads.map(thread => `
                <div class="saved-thread-item" data-thread-id="${thread.id}">
                    <div class="saved-thread-name">${thread.name}</div>
                    <div class="saved-thread-meta">
                        <span>${thread.date}</span>
                        <span>${thread.messages?.length || 0} messages</span>
                    </div>
                    <div class="saved-thread-actions">
                        <button class="btn" onclick="loadThread(${thread.id})" style="padding: 6px 12px; font-size: 11px;">Load</button>
                        <button class="btn" onclick="deleteThread(${thread.id})" style="padding: 6px 12px; font-size: 11px; color: #dc2626;">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function loadThread(threadId) {
            const thread = deepDiveState.savedThreads.find(t => t.id === threadId);
            if (thread) {
                deepDiveState.messages = [...thread.messages];
                deepDiveState.activeCategory = thread.category;
                setActiveCategory(thread.category);
                renderConsoleMessages();
                closePanels();
            }
        }
        
        function deleteThread(threadId) {
            if (!confirm('Delete this saved thread?')) return;
            deepDiveState.savedThreads = deepDiveState.savedThreads.filter(t => t.id !== threadId);
            localStorage.setItem('oppgrid_saved_threads', JSON.stringify(deepDiveState.savedThreads));
            renderSavedThreadsList();
        }

        // Project Panel
        let selectedProjectId = null;
        let userProjects = JSON.parse(localStorage.getItem('oppgrid_projects') || '[]');
        
        function initProjectPanel() {
            const btn = document.getElementById('project-btn');
            const panel = document.getElementById('project-panel');
            const closeBtn = document.getElementById('close-project-btn');
            const cancelBtn = document.getElementById('cancel-project-btn');
            const saveBtn = document.getElementById('save-to-project-btn');
            const createBtn = document.getElementById('create-project-btn');
            const overlay = document.getElementById('panel-overlay');
            
            btn?.addEventListener('click', () => {
                panel.classList.add('open');
                overlay.classList.add('active');
                renderProjectList();
            });
            
            closeBtn?.addEventListener('click', closePanels);
            cancelBtn?.addEventListener('click', closePanels);
            
            // Project tabs
            document.querySelectorAll('.project-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.project-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    const tabName = tab.dataset.tab;
                    document.getElementById('existing-projects-tab').style.display = tabName === 'existing' ? 'block' : 'none';
                    document.getElementById('new-project-tab').style.display = tabName === 'new' ? 'block' : 'none';
                });
            });
            
            createBtn?.addEventListener('click', () => {
                const name = document.getElementById('new-project-name').value.trim();
                const desc = document.getElementById('new-project-description').value.trim();
                if (!name) { alert('Please enter a project name'); return; }
                
                const project = {
                    id: Date.now(),
                    name: name,
                    description: desc,
                    createdAt: new Date().toISOString(),
                    ideas: []
                };
                userProjects.push(project);
                localStorage.setItem('oppgrid_projects', JSON.stringify(userProjects));
                document.getElementById('new-project-name').value = '';
                document.getElementById('new-project-description').value = '';
                document.querySelector('[data-tab="existing"]').click();
                renderProjectList();
            });
            
            saveBtn?.addEventListener('click', () => {
                if (!selectedProjectId) { alert('Please select a project first'); return; }
                const title = document.getElementById('new-idea-title').value.trim();
                const desc = document.getElementById('new-idea-description').value.trim();
                const opportunityTitle = document.getElementById('opportunity-title')?.textContent || 'Untitled';
                
                const project = userProjects.find(p => p.id === selectedProjectId);
                if (project) {
                    project.ideas.push({
                        id: Date.now(),
                        title: title || opportunityTitle,
                        description: desc || `Saved from analysis: ${opportunityTitle}`,
                        savedAt: new Date().toISOString(),
                        opportunityId: currentOpportunityId
                    });
                    localStorage.setItem('oppgrid_projects', JSON.stringify(userProjects));
                    alert(`Saved to "${project.name}"!`);
                    closePanels();
                }
            });
        }
        
        function renderProjectList() {
            const list = document.getElementById('project-list');
            if (userProjects.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--stone-500); padding: 20px;">No projects yet. Create one to get started.</p>';
                return;
            }
            
            list.innerHTML = userProjects.map(p => `
                <div class="project-item ${selectedProjectId === p.id ? 'selected' : ''}" data-project-id="${p.id}" onclick="selectProject(${p.id})">
                    <div class="project-item-name">${p.name}</div>
                    <div class="project-item-meta">Created ${new Date(p.createdAt).toLocaleDateString()}</div>
                    <span class="project-item-count">${p.ideas?.length || 0} ideas saved</span>
                </div>
            `).join('');
        }
        
        function selectProject(projectId) {
            selectedProjectId = projectId;
            renderProjectList();
        }

        // Share Modal
        function initShareModal() {
            const btn = document.getElementById('share-btn');
            const modal = document.getElementById('share-modal');
            const closeBtn = document.getElementById('close-share-modal');
            const copyBtn = document.getElementById('copy-share-link');
            
            btn?.addEventListener('click', () => {
                const shareId = Math.random().toString(36).substring(2, 15);
                document.getElementById('share-link').value = `https://oppgrid.com/share/${shareId}`;
                modal.classList.add('active');
            });
            
            closeBtn?.addEventListener('click', () => modal.classList.remove('active'));
            modal?.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
            
            copyBtn?.addEventListener('click', () => {
                const link = document.getElementById('share-link');
                link.select();
                document.execCommand('copy');
                copyBtn.textContent = 'Copied!';
                setTimeout(() => copyBtn.textContent = 'Copy', 2000);
            });
        }

        // Celebration Animation
        function checkCelebration() {
            const completed = Object.values(deepDiveState.categoryCompletion).filter(c => c.completed).length;
            if (completed === 9 && !localStorage.getItem('oppgrid_celebrated')) {
                document.getElementById('celebration-overlay').classList.add('active');
                localStorage.setItem('oppgrid_celebrated', 'true');
            }
        }
        
        function initCelebration() {
            document.getElementById('close-celebration')?.addEventListener('click', () => {
                document.getElementById('celebration-overlay').classList.remove('active');
            });
        }

        // Close all panels
        function closePanels() {
            document.getElementById('saved-threads-panel')?.classList.remove('open');
            document.getElementById('project-panel')?.classList.remove('open');
            document.getElementById('panel-overlay')?.classList.remove('active');
        }

        // Override updateProgress to check for celebration
        const originalUpdateProgress = updateProgress;
        updateProgress = function() {
            originalUpdateProgress();
            checkCelebration();
        };

        // Auth-aware UI
        document.addEventListener('DOMContentLoaded', async () => {
            loadOpportunityData();
            initDeepDiveConsole();
            initThemeToggle();
            initKeyboardShortcuts();
            initSavedThreadsPanel();
            initProjectPanel();
            initShareModal();
            initCelebration();
            
            const token = localStorage.getItem('access_token');
            if (token) {
                try {
                    const user = await api.getCurrentUser();
                    document.querySelectorAll('.auth-required').forEach(el => el.style.display = 'flex');
                    document.querySelectorAll('.guest-only').forEach(el => el.style.display = 'none');
                    
                    const avatar = document.getElementById('user-avatar');
                    if (avatar && user) {
                        const initials = user.name 
                            ? user.name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2)
                            : user.email[0].toUpperCase();
                        avatar.textContent = initials;
                    }
                } catch (error) {
                    localStorage.removeItem('access_token');
                }
            }
        });
    </script>
</body>
</html>
