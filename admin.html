<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - OppGrid</title>
    <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --stone-50: #fafaf9;
            --stone-100: #f5f5f4;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-400: #a8a29e;
            --stone-500: #78716c;
            --stone-600: #57534e;
            --stone-700: #44403c;
            --stone-800: #292524;
            --stone-900: #1c1917;
            --violet-50: #f5f3ff;
            --violet-100: #ede9fe;
            --violet-200: #ddd6fe;
            --violet-600: #7c3aed;
            --violet-700: #6d28d9;
            --red-50: #fef2f2;
            --red-100: #fee2e2;
            --red-500: #ef4444;
            --red-600: #dc2626;
            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-500: #22c55e;
            --green-600: #16a34a;
            --amber-50: #fffbeb;
            --amber-100: #fef3c7;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--stone-100);
            color: var(--stone-900);
            min-height: 100vh;
            line-height: 1.6;
        }

        .spektral {
            font-family: 'Spectral', serif;
        }

        nav {
            background: var(--stone-900);
            border-bottom: 1px solid var(--stone-700);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .logo-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--white);
        }

        .admin-badge {
            background: var(--violet-600);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-user span {
            color: var(--stone-300);
            font-size: 14px;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--stone-600);
            color: var(--stone-300);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: var(--stone-800);
            border-color: var(--stone-500);
        }

        .admin-layout {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        .sidebar {
            width: 240px;
            background: var(--white);
            border-right: 1px solid var(--stone-200);
            padding: 24px 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            text-decoration: none;
            color: var(--stone-600);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-nav li a:hover {
            background: var(--stone-50);
            color: var(--stone-900);
        }

        .sidebar-nav li a.active {
            background: var(--violet-50);
            color: var(--violet-700);
            border-left-color: var(--violet-600);
        }

        .sidebar-nav li a svg {
            width: 20px;
            height: 20px;
        }

        .main-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-family: 'Spectral', serif;
            font-size: 28px;
            color: var(--stone-900);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--stone-500);
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--stone-200);
        }

        .stat-card .stat-label {
            font-size: 13px;
            color: var(--stone-500);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .stat-card .stat-change {
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-card .stat-change.positive {
            color: var(--green-600);
        }

        .stat-card .stat-change.negative {
            color: var(--red-500);
        }

        .content-section {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--stone-200);
            margin-bottom: 24px;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .section-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            padding: 8px 16px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
            width: 250px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--violet-600);
        }

        .filter-select {
            padding: 8px 16px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
            background: var(--white);
            cursor: pointer;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 14px 24px;
            background: var(--stone-50);
            font-size: 12px;
            font-weight: 600;
            color: var(--stone-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--stone-200);
        }

        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--stone-100);
            font-size: 14px;
        }

        .data-table tr:hover {
            background: var(--stone-50);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--violet-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--violet-700);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            color: var(--stone-900);
        }

        .user-email {
            font-size: 12px;
            color: var(--stone-500);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-admin {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-verified {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-banned {
            background: var(--red-100);
            color: var(--red-600);
        }

        .badge-free {
            background: var(--stone-100);
            color: var(--stone-600);
        }

        .badge-pro {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .badge-business {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-enterprise {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        .badge-active {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-canceled {
            background: var(--red-100);
            color: var(--red-600);
        }

        .badge-pending {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--violet-600);
            color: white;
        }

        .btn-primary:hover {
            background: var(--violet-700);
        }

        .btn-danger {
            background: var(--red-50);
            color: var(--red-600);
            border: 1px solid var(--red-200);
        }

        .btn-danger:hover {
            background: var(--red-100);
        }

        .btn-secondary {
            background: var(--stone-100);
            color: var(--stone-700);
            border: 1px solid var(--stone-200);
        }

        .btn-secondary:hover {
            background: var(--stone-200);
        }

        .btn-success {
            background: var(--green-50);
            color: var(--green-600);
            border: 1px solid var(--green-200);
        }

        .btn-success:hover {
            background: var(--green-100);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--stone-500);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--stone-500);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--white);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--stone-500);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--stone-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--stone-700);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--violet-600);
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: var(--green-600);
            color: white;
        }

        .toast-error {
            background: var(--red-600);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <div style="display: flex; align-items: center;">
                <a href="index.html" class="logo">
                    <span class="logo-text">OppGrid</span>
                </a>
                <span class="admin-badge">Admin Panel</span>
            </div>
            <div class="nav-user">
                <span id="admin-name">Loading...</span>
                <button class="btn-logout" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </nav>

    <div class="admin-layout">
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li>
                    <a href="#dashboard" class="active" data-section="dashboard">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#users" data-section="users">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                        Users
                    </a>
                </li>
                <li>
                    <a href="#opportunities" data-section="opportunities">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        Opportunities
                    </a>
                </li>
                <li>
                    <a href="#subscriptions" data-section="subscriptions">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                        Subscriptions
                    </a>
                </li>
                <li>
                    <a href="#reports" data-section="reports">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Reports
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <section id="section-dashboard">
                <div class="page-header">
                    <h1 class="spektral">Dashboard</h1>
                    <p>Platform overview and key metrics</p>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="stat-users">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Verified Users</div>
                        <div class="stat-value" id="stat-verified">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Opportunities</div>
                        <div class="stat-value" id="stat-opportunities">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Banned Users</div>
                        <div class="stat-value" id="stat-banned">--</div>
                    </div>
                </div>
            </section>

            <section id="section-users" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">User Management</h1>
                    <p>Manage platform users, roles, and permissions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Users</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="user-search" placeholder="Search users...">
                            <select class="filter-select" id="user-filter">
                                <option value="">All Users</option>
                                <option value="admin">Admins</option>
                                <option value="banned">Banned</option>
                                <option value="verified">Verified</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="5" class="loading">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-opportunities" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Opportunity Management</h1>
                    <p>Review and moderate user-submitted opportunities</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Opportunities</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="opp-search" placeholder="Search opportunities...">
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Status</th>
                                <th>Validations</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="opportunities-table-body">
                            <tr><td colspan="6" class="loading">Loading opportunities...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-subscriptions" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Subscription Management</h1>
                    <p>View and manage user subscriptions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Subscriptions</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="sub-tier-filter">
                                <option value="">All Tiers</option>
                                <option value="free">Free</option>
                                <option value="pro">Pro</option>
                                <option value="business">Business</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Tier</th>
                                <th>Status</th>
                                <th>Period End</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptions-table-body">
                            <tr><td colspan="5" class="loading">Loading subscriptions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-reports" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Content Reports</h1>
                    <p>Review reported content and take moderation actions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Pending Reports</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="report-status-filter">
                                <option value="pending">Pending</option>
                                <option value="reviewing">Reviewing</option>
                                <option value="resolved">Resolved</option>
                                <option value="dismissed">Dismissed</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Content</th>
                                <th>Reason</th>
                                <th>Reporter</th>
                                <th>Status</th>
                                <th>Reported</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body">
                            <tr><td colspan="6" class="loading">Loading reports...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script>
        const API_BASE_URL = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : '/api/v1';
        let currentUser = null;

        async function init() {
            console.log('[Admin] Initializing admin panel...');
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            console.log('[Admin] Token found:', !!token);
            
            if (!token) {
                console.log('[Admin] No token, redirecting to signin');
                window.location.href = 'signin.html?redirect=admin.html';
                return;
            }

            try {
                console.log('[Admin] Fetching user info...');
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                console.log('[Admin] Response status:', response.status);
                if (!response.ok) throw new Error('Not authenticated');

                currentUser = await response.json();
                console.log('[Admin] User data:', JSON.stringify(currentUser));
                console.log('[Admin] is_admin value:', currentUser.is_admin, 'type:', typeof currentUser.is_admin);

                if (!currentUser.is_admin) {
                    console.log('[Admin] User is not admin, redirecting...');
                    showToast('Access denied: Admin privileges required', 'error');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }

                console.log('[Admin] Admin access granted!');
                document.getElementById('admin-name').textContent = currentUser.name;

                setupNavigation();
                loadDashboard();
            } catch (error) {
                console.error('[Admin] Auth error:', error);
                window.location.href = 'signin.html';
            }
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    document.querySelectorAll('[id^="section-"]').forEach(s => s.classList.add('hidden'));
                    document.getElementById(`section-${section}`).classList.remove('hidden');
                    
                    loadSection(section);
                });
            });

            document.getElementById('user-search').addEventListener('input', debounce(() => loadUsers(), 300));
            document.getElementById('user-filter').addEventListener('change', () => loadUsers());
            document.getElementById('opp-search').addEventListener('input', debounce(() => loadOpportunities(), 300));
            document.getElementById('sub-tier-filter').addEventListener('change', () => loadSubscriptions());
            document.getElementById('report-status-filter').addEventListener('change', () => loadReports());
        }

        function loadSection(section) {
            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'users': loadUsers(); break;
                case 'opportunities': loadOpportunities(); break;
                case 'subscriptions': loadSubscriptions(); break;
                case 'reports': loadReports(); break;
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetchWithAuth('/api/v1/admin/stats');
                const stats = await response.json();

                document.getElementById('stat-users').textContent = stats.total_users;
                document.getElementById('stat-verified').textContent = stats.verified_users;
                document.getElementById('stat-opportunities').textContent = stats.total_opportunities;
                document.getElementById('stat-banned').textContent = stats.banned_users;
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function loadUsers() {
            const search = document.getElementById('user-search').value;
            const filter = document.getElementById('user-filter').value;
            const tbody = document.getElementById('users-table-body');
            
            try {
                let url = '/api/v1/admin/users?limit=50';
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (filter === 'admin') url += '&is_admin=true';
                if (filter === 'banned') url += '&is_banned=true';
                if (filter === 'verified') url += '&is_verified=true';

                const response = await fetchWithAuth(url);
                const users = await response.json();

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
                                <div class="user-info">
                                    <span class="user-name">${escapeHtml(user.name)}</span>
                                    <span class="user-email">${escapeHtml(user.email)}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${user.is_verified ? '<span class="badge badge-verified">Verified</span>' : ''}
                            ${user.is_banned ? '<span class="badge badge-banned">Banned</span>' : ''}
                        </td>
                        <td>
                            ${user.is_admin ? '<span class="badge badge-admin">Admin</span>' : '<span class="badge badge-free">User</span>'}
                        </td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                ${!user.is_admin ? `
                                    <button class="btn-sm btn-primary" onclick="promoteUser(${user.id})">Make Admin</button>
                                ` : user.id !== currentUser.id ? `
                                    <button class="btn-sm btn-secondary" onclick="demoteUser(${user.id})">Remove Admin</button>
                                ` : ''}
                                ${!user.is_banned && user.id !== currentUser.id ? `
                                    <button class="btn-sm btn-danger" onclick="showBanModal(${user.id}, '${escapeHtml(user.name)}')">Ban</button>
                                ` : user.is_banned ? `
                                    <button class="btn-sm btn-success" onclick="unbanUser(${user.id})">Unban</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load users:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load users</td></tr>';
            }
        }

        async function loadOpportunities() {
            const search = document.getElementById('opp-search').value;
            const tbody = document.getElementById('opportunities-table-body');
            
            try {
                let url = '/api/v1/admin/opportunities?limit=50';
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await fetchWithAuth(url);
                const opportunities = await response.json();

                if (opportunities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No opportunities found</td></tr>';
                    return;
                }

                tbody.innerHTML = opportunities.map(opp => `
                    <tr>
                        <td>
                            <a href="opportunity.html?id=${opp.id}" style="color: var(--violet-600); text-decoration: none;">
                                ${escapeHtml(opp.title.substring(0, 50))}${opp.title.length > 50 ? '...' : ''}
                            </a>
                        </td>
                        <td>${escapeHtml(opp.author_name)}</td>
                        <td><span class="badge badge-${opp.status === 'published' ? 'active' : 'pending'}">${opp.status}</span></td>
                        <td>${opp.validation_count}</td>
                        <td>${formatDate(opp.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-sm btn-danger" onclick="deleteOpportunity(${opp.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load opportunities:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Failed to load opportunities</td></tr>';
            }
        }

        async function loadSubscriptions() {
            const tierFilter = document.getElementById('sub-tier-filter').value;
            const tbody = document.getElementById('subscriptions-table-body');
            
            try {
                let url = '/api/v1/admin/subscriptions?limit=50';
                if (tierFilter) url += `&tier_filter=${tierFilter}`;

                const response = await fetchWithAuth(url);
                const subscriptions = await response.json();

                if (subscriptions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No subscriptions found</td></tr>';
                    return;
                }

                tbody.innerHTML = subscriptions.map(sub => `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${sub.user_name.charAt(0).toUpperCase()}</div>
                                <div class="user-info">
                                    <span class="user-name">${escapeHtml(sub.user_name)}</span>
                                    <span class="user-email">${escapeHtml(sub.user_email)}</span>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge badge-${sub.tier}">${sub.tier.toUpperCase()}</span></td>
                        <td><span class="badge badge-${sub.status}">${sub.status}</span></td>
                        <td>${sub.current_period_end ? formatDate(sub.current_period_end) : 'N/A'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-sm btn-secondary" onclick="showTierModal(${sub.id}, ${sub.user_id}, '${sub.tier}')">Change Tier</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load subscriptions:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load subscriptions</td></tr>';
            }
        }

        async function loadReports() {
            const status = document.getElementById('report-status-filter').value;
            const tbody = document.getElementById('reports-table-body');
            
            try {
                const response = await fetchWithAuth(`/api/v1/moderation/reports?status_filter=${status}&limit=50`);
                const reports = await response.json();

                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No reports found</td></tr>';
                    return;
                }

                tbody.innerHTML = reports.map(report => `
                    <tr>
                        <td>${report.content_type} #${report.content_id}</td>
                        <td>${report.reason}</td>
                        <td>User #${report.reporter_id}</td>
                        <td><span class="badge badge-${report.status}">${report.status}</span></td>
                        <td>${formatDate(report.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                ${report.status === 'pending' || report.status === 'reviewing' ? `
                                    <button class="btn-sm btn-primary" onclick="resolveReport(${report.id})">Resolve</button>
                                    <button class="btn-sm btn-secondary" onclick="dismissReport(${report.id})">Dismiss</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load reports:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Failed to load reports</td></tr>';
            }
        }

        async function promoteUser(userId) {
            if (!confirm('Are you sure you want to make this user an admin?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/promote`, { method: 'POST' });
                showToast('User promoted to admin', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to promote user', 'error');
            }
        }

        async function demoteUser(userId) {
            if (!confirm('Are you sure you want to remove admin privileges?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/demote`, { method: 'POST' });
                showToast('Admin privileges removed', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to demote user', 'error');
            }
        }

        function showBanModal(userId, userName) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Ban User: ${escapeHtml(userName)}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="ban-reason">Reason for ban</label>
                            <textarea id="ban-reason" rows="3" placeholder="Enter the reason for banning this user..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-danger" onclick="banUser(${userId})">Ban User</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        async function banUser(userId) {
            const reason = document.getElementById('ban-reason').value;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/ban`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ban_reason: reason })
                });
                closeModal();
                showToast('User banned successfully', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to ban user', 'error');
            }
        }

        async function unbanUser(userId) {
            if (!confirm('Are you sure you want to unban this user?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/unban`, { method: 'POST' });
                showToast('User unbanned successfully', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to unban user', 'error');
            }
        }

        async function deleteOpportunity(id) {
            if (!confirm('Are you sure you want to delete this opportunity? This cannot be undone.')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/opportunities/${id}`, { method: 'DELETE' });
                showToast('Opportunity deleted', 'success');
                loadOpportunities();
            } catch (error) {
                showToast('Failed to delete opportunity', 'error');
            }
        }

        function showTierModal(subscriptionId, userId, currentTier) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Change Subscription Tier</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-tier">New Tier</label>
                            <select id="new-tier">
                                <option value="free" ${currentTier === 'free' ? 'selected' : ''}>Free</option>
                                <option value="pro" ${currentTier === 'pro' ? 'selected' : ''}>Pro</option>
                                <option value="business" ${currentTier === 'business' ? 'selected' : ''}>Business</option>
                                <option value="enterprise" ${currentTier === 'enterprise' ? 'selected' : ''}>Enterprise</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-primary" onclick="updateTier(${subscriptionId}, ${userId})">Update Tier</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        async function updateTier(subscriptionId, userId) {
            const newTier = document.getElementById('new-tier').value;
            
            try {
                if (subscriptionId) {
                    await fetchWithAuth(`/api/v1/admin/subscriptions/${subscriptionId}/tier?tier=${newTier}`, { method: 'PATCH' });
                } else {
                    await fetchWithAuth(`/api/v1/admin/users/${userId}/grant-subscription?tier=${newTier}`, { method: 'POST' });
                }
                closeModal();
                showToast('Subscription updated', 'success');
                loadSubscriptions();
            } catch (error) {
                showToast('Failed to update subscription', 'error');
            }
        }

        async function resolveReport(reportId) {
            try {
                await fetchWithAuth(`/api/v1/moderation/reports/${reportId}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action_taken: 'Content reviewed and action taken', moderator_notes: '' })
                });
                showToast('Report resolved', 'success');
                loadReports();
            } catch (error) {
                showToast('Failed to resolve report', 'error');
            }
        }

        async function dismissReport(reportId) {
            try {
                await fetchWithAuth(`/api/v1/moderation/reports/${reportId}/dismiss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ moderator_notes: 'Report dismissed' })
                });
                showToast('Report dismissed', 'success');
                loadReports();
            } catch (error) {
                showToast('Failed to dismiss report', 'error');
            }
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('access_token') || localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}${url}`, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            return response;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('token');
            window.location.href = 'signin.html';
        }

        init();
    </script>
</body>
</html>
