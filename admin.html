<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - OppGrid</title>
    <link href="https://fonts.googleapis.com/css2?family=Spectral:wght@400;600;700;800&family=Inter:wght@300;400;500;600;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">
    <style>
        :root {
            --stone-50: #fafaf9;
            --stone-100: #f5f5f4;
            --stone-200: #e7e5e4;
            --stone-300: #d6d3d1;
            --stone-400: #a8a29e;
            --stone-500: #78716c;
            --stone-600: #57534e;
            --stone-700: #44403c;
            --stone-800: #292524;
            --stone-900: #1c1917;
            --violet-50: #f5f3ff;
            --violet-100: #ede9fe;
            --violet-200: #ddd6fe;
            --violet-600: #1c1917;
            --violet-700: #292524;
            --red-50: #fef2f2;
            --red-100: #fee2e2;
            --red-500: #ef4444;
            --red-600: #dc2626;
            --green-50: #f0fdf4;
            --green-100: #dcfce7;
            --green-500: #22c55e;
            --green-600: #16a34a;
            --amber-50: #fffbeb;
            --amber-100: #fef3c7;
            --amber-500: #f59e0b;
            --amber-600: #d97706;
            --blue-50: #eff6ff;
            --blue-100: #dbeafe;
            --blue-500: #3b82f6;
            --blue-600: #2563eb;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--stone-100);
            color: var(--stone-900);
            min-height: 100vh;
            line-height: 1.6;
        }

        .spektral {
            font-family: 'Spectral', serif;
        }

        nav {
            background: var(--stone-900);
            border-bottom: 1px solid var(--stone-700);
        }

        .nav-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .logo-text {
            font-family: 'Roboto Mono', monospace;
            font-size: 20px;
            font-weight: 700;
            color: var(--white);
        }

        .admin-badge {
            background: var(--violet-600);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 12px;
        }

        .nav-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .nav-user span {
            color: var(--stone-300);
            font-size: 14px;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid var(--stone-600);
            color: var(--stone-300);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: var(--stone-800);
            border-color: var(--stone-500);
        }

        .admin-layout {
            display: flex;
            min-height: calc(100vh - 65px);
        }

        .sidebar {
            width: 240px;
            background: var(--white);
            border-right: 1px solid var(--stone-200);
            padding: 24px 0;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            text-decoration: none;
            color: var(--stone-600);
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-nav li a:hover {
            background: var(--stone-50);
            color: var(--stone-900);
        }

        .sidebar-nav li a.active {
            background: var(--violet-50);
            color: var(--violet-700);
            border-left-color: var(--violet-600);
        }

        .sidebar-nav li a svg {
            width: 20px;
            height: 20px;
        }

        .main-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-header h1 {
            font-family: 'Spectral', serif;
            font-size: 28px;
            color: var(--stone-900);
            margin-bottom: 8px;
        }

        .page-header p {
            color: var(--stone-500);
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--white);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--stone-200);
        }

        .stat-card .stat-label {
            font-size: 13px;
            color: var(--stone-500);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--stone-900);
        }

        .stat-card .stat-change {
            font-size: 12px;
            margin-top: 8px;
        }

        .stat-card .stat-change.positive {
            color: var(--green-600);
        }

        .stat-card .stat-change.negative {
            color: var(--red-500);
        }

        .content-section {
            background: var(--white);
            border-radius: 12px;
            border: 1px solid var(--stone-200);
            margin-bottom: 24px;
        }

        .section-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 18px;
            font-weight: 600;
        }

        .section-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            padding: 8px 16px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
            width: 250px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--violet-600);
        }

        .filter-select {
            padding: 8px 16px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
            background: var(--white);
            cursor: pointer;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 14px 24px;
            background: var(--stone-50);
            font-size: 12px;
            font-weight: 600;
            color: var(--stone-500);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--stone-200);
        }

        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--stone-100);
            font-size: 14px;
        }

        .data-table tr:hover {
            background: var(--stone-50);
        }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--violet-100);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--violet-700);
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 500;
            color: var(--stone-900);
        }

        .user-email {
            font-size: 12px;
            color: var(--stone-500);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-admin {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-verified {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-banned {
            background: var(--red-100);
            color: var(--red-600);
        }

        .badge-free {
            background: var(--stone-100);
            color: var(--stone-600);
        }

        .badge-pro {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .badge-business {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-enterprise {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        .badge-active {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-canceled {
            background: var(--red-100);
            color: var(--red-600);
        }

        .badge-pending {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        /* Partner outreach statuses */
        .badge-identified {
            background: var(--stone-100);
            color: var(--stone-600);
        }

        .badge-contacted {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .badge-in_talks {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-paused {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        .badge-rejected {
            background: var(--red-100);
            color: var(--red-600);
        }

        /* Job run statuses */
        .badge-running {
            background: var(--amber-100);
            color: var(--amber-600);
        }

        .badge-succeeded {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-failed {
            background: var(--red-100);
            color: var(--red-600);
        }

        /* Lead statuses */
        .badge-new {
            background: var(--blue-100);
            color: var(--blue-600);
        }

        .badge-qualified {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-nurturing {
            background: var(--violet-100);
            color: var(--violet-700);
        }

        .badge-converted {
            background: var(--green-100);
            color: var(--green-600);
        }

        .badge-lost {
            background: var(--red-100);
            color: var(--red-600);
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--violet-600);
            color: white;
        }

        .btn-primary:hover {
            background: var(--violet-700);
        }

        .btn-danger {
            background: var(--red-50);
            color: var(--red-600);
            border: 1px solid var(--red-200);
        }

        .btn-danger:hover {
            background: var(--red-100);
        }

        .btn-secondary {
            background: var(--stone-100);
            color: var(--stone-700);
            border: 1px solid var(--stone-200);
        }

        .btn-secondary:hover {
            background: var(--stone-200);
        }

        .btn-success {
            background: var(--green-50);
            color: var(--green-600);
            border: 1px solid var(--green-200);
        }

        .btn-success:hover {
            background: var(--green-100);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--stone-500);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--stone-500);
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: var(--white);
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stone-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--stone-500);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--stone-200);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--stone-700);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--stone-300);
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--violet-600);
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }

        .toast-success {
            background: var(--green-600);
            color: white;
        }

        .toast-error {
            background: var(--red-600);
            color: white;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-content">
            <div style="display: flex; align-items: center;">
                <a href="index.html" class="logo">
                    <span class="logo-text">OppGrid</span>
                </a>
                <span class="admin-badge">Admin Panel</span>
            </div>
            <div class="nav-user">
                <span id="admin-name">Loading...</span>
                <button class="btn-logout" onclick="logout()">Sign Out</button>
            </div>
        </div>
    </nav>

    <div class="admin-layout">
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <li>
                    <a href="#dashboard" class="active" data-section="dashboard">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                        Dashboard
                    </a>
                </li>
                <li>
                    <a href="#tracking" data-section="tracking">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3v18h18"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 14l3-3 4 4 6-6"/>
                        </svg>
                        Tracking
                    </a>
                </li>
                <li>
                    <a href="#ops" data-section="ops">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V3m0 3a3 3 0 1 0 0 6m0-6a3 3 0 1 1 0 6m0 6v3m0-3a3 3 0 1 0 0-6m0 6a3 3 0 1 1 0-6M6 12H3m3 0a3 3 0 1 0 6 0m-6 0a3 3 0 1 1 6 0m12 0h-3m3 0a3 3 0 1 0-6 0m6 0a3 3 0 1 1-6 0"/>
                        </svg>
                        Ops
                    </a>
                </li>
                <li>
                    <a href="#users" data-section="users">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                        Users
                    </a>
                </li>
                <li>
                    <a href="#opportunities" data-section="opportunities">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                        Opportunities
                    </a>
                </li>
                <li>
                    <a href="#subscriptions" data-section="subscriptions">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                        Subscriptions
                    </a>
                </li>
                <li>
                    <a href="#partners" data-section="partners">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                            <circle cx="9" cy="7" r="4"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M22 21v-2a4 4 0 0 0-3-3.87"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                        Partners
                    </a>
                </li>
                <li>
                    <a href="#leads" data-section="leads">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                        Leads
                    </a>
                </li>
                <li>
                    <a href="#reports" data-section="reports">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                        Reports
                    </a>
                </li>
                <li>
                    <a href="#scraper" data-section="scraper">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"/></svg>
                        Scraper Data
                    </a>
                </li>
            </ul>
        </aside>

        <main class="main-content">
            <section id="section-dashboard">
                <div class="page-header">
                    <h1 class="spektral">Dashboard</h1>
                    <p>Platform overview and key metrics</p>
                </div>

                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Users</div>
                        <div class="stat-value" id="stat-users">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Verified Users</div>
                        <div class="stat-value" id="stat-verified">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Opportunities</div>
                        <div class="stat-value" id="stat-opportunities">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Banned Users</div>
                        <div class="stat-value" id="stat-banned">--</div>
                    </div>
                </div>
            </section>

            <section id="section-tracking" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Tracking</h1>
                    <p>Product analytics (best-effort pageview capture + event debugging)</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Summary</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="tracking-days">
                                <option value="1">Last 1 day</option>
                                <option value="7" selected>Last 7 days</option>
                                <option value="30">Last 30 days</option>
                            </select>
                            <button class="btn-sm btn-primary" onclick="loadTracking()">Refresh</button>
                        </div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="stats-grid" style="margin-bottom: 0;">
                            <div class="stat-card">
                                <div class="stat-label">Total Events</div>
                                <div class="stat-value" id="tracking-total">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Page Views</div>
                                <div class="stat-value" id="tracking-pageviews">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Top Event</div>
                                <div class="stat-value" id="tracking-top-event">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Top Path</div>
                                <div class="stat-value" id="tracking-top-path">--</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Recent Events</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="tracking-event-filter">
                                <option value="">All events</option>
                                <option value="page_view">page_view</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>When</th>
                                <th>Name</th>
                                <th>Path</th>
                                <th>User</th>
                            </tr>
                        </thead>
                        <tbody id="tracking-events-body">
                            <tr><td colspan="4" class="loading">Loading events...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-ops" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Ops</h1>
                    <p>Background jobs and audit logs</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Job Runs</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="jobruns-name" placeholder="job name (e.g. escrow_release)">
                            <select class="filter-select" id="jobruns-status">
                                <option value="">All statuses</option>
                                <option value="running">running</option>
                                <option value="succeeded">succeeded</option>
                                <option value="failed">failed</option>
                            </select>
                            <button class="btn-sm btn-primary" onclick="loadJobRuns()">Refresh</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>When</th>
                                <th>Job</th>
                                <th>Status</th>
                                <th>Duration</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody id="jobruns-body">
                            <tr><td colspan="5" class="loading">Loading job runs...</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Audit Logs</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="audit-action" placeholder="action (e.g. agreement.trigger_payout)">
                            <input type="text" class="search-input" id="audit-resource-type" placeholder="resource_type (e.g. agreement)">
                            <input type="text" class="search-input" id="audit-resource-id" placeholder="resource_id (e.g. 123)">
                            <button class="btn-sm btn-primary" onclick="loadAuditLogs()">Refresh</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>When</th>
                                <th>Actor</th>
                                <th>Action</th>
                                <th>Resource</th>
                                <th>IP</th>
                            </tr>
                        </thead>
                        <tbody id="audit-body">
                            <tr><td colspan="5" class="loading">Loading audit logs...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-users" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">User Management</h1>
                    <p>Manage platform users, roles, and permissions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Users</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="user-search" placeholder="Search users...">
                            <select class="filter-select" id="user-filter">
                                <option value="">All Users</option>
                                <option value="admin">Admins</option>
                                <option value="banned">Banned</option>
                                <option value="verified">Verified</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Role</th>
                                <th>Joined</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr><td colspan="5" class="loading">Loading users...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-opportunities" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Opportunity Management</h1>
                    <p>Review and moderate user-submitted opportunities</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Opportunities</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="opp-search" placeholder="Search opportunities...">
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Status</th>
                                <th>Validations</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="opportunities-table-body">
                            <tr><td colspan="6" class="loading">Loading opportunities...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-subscriptions" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Subscription Management</h1>
                    <p>View and manage user subscriptions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>All Subscriptions</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="sub-tier-filter">
                                <option value="">All Tiers</option>
                                <option value="free">Free</option>
                                <option value="pro">Pro</option>
                                <option value="business">Business</option>
                                <option value="enterprise">Enterprise</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Tier</th>
                                <th>Status</th>
                                <th>Period End</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="subscriptions-table-body">
                            <tr><td colspan="5" class="loading">Loading subscriptions...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-partners" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Partner Outreach</h1>
                    <p>Track integration/tool partners and outreach progress</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Partners</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="partner-search" placeholder="Search partners...">
                            <select class="filter-select" id="partner-status-filter">
                                <option value="">All statuses</option>
                                <option value="identified">Identified</option>
                                <option value="contacted">Contacted</option>
                                <option value="in_talks">In talks</option>
                                <option value="active">Active</option>
                                <option value="paused">Paused</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <button class="btn-sm btn-primary" onclick="showPartnerModal()">Add Partner</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Contact</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partners-table-body">
                            <tr><td colspan="6" class="loading">Loading partners...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-leads" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Lead Management</h1>
                    <p>Manage potential customers and lead nurturing campaigns</p>
                </div>

                <div class="stats-grid" id="leads-stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Leads</div>
                        <div class="stat-value" id="leads-total">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">New</div>
                        <div class="stat-value" id="leads-new">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Qualified</div>
                        <div class="stat-value" id="leads-qualified">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Conversion Rate</div>
                        <div class="stat-value" id="leads-conversion">--%</div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Leads Pipeline</h2>
                        <div class="section-actions">
                            <input type="text" class="search-input" id="lead-search" placeholder="Search leads...">
                            <select class="filter-select" id="lead-status-filter">
                                <option value="">All statuses</option>
                                <option value="new">New</option>
                                <option value="contacted">Contacted</option>
                                <option value="qualified">Qualified</option>
                                <option value="nurturing">Nurturing</option>
                                <option value="converted">Converted</option>
                                <option value="lost">Lost</option>
                            </select>
                            <button class="btn-sm btn-success" onclick="bulkNurtureLeads()">Send Nurture Emails</button>
                            <button class="btn-sm btn-primary" onclick="showLeadModal()">Add Lead</button>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Company</th>
                                <th>Status</th>
                                <th>Source</th>
                                <th>Sequence</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="leads-table-body">
                            <tr><td colspan="8" class="loading">Loading leads...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-reports" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Content Reports</h1>
                    <p>Review reported content and take moderation actions</p>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Pending Reports</h2>
                        <div class="section-actions">
                            <select class="filter-select" id="report-status-filter">
                                <option value="pending">Pending</option>
                                <option value="reviewing">Reviewing</option>
                                <option value="resolved">Resolved</option>
                                <option value="dismissed">Dismissed</option>
                            </select>
                        </div>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Content</th>
                                <th>Reason</th>
                                <th>Reporter</th>
                                <th>Status</th>
                                <th>Reported</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reports-table-body">
                            <tr><td colspan="6" class="loading">Loading reports...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="section-scraper" class="hidden">
                <div class="page-header">
                    <h1 class="spektral">Scraper Data Import</h1>
                    <p>Upload and analyze scraper data to discover business opportunities</p>
                </div>

                <!-- Webhook Calendar -->
                <div class="content-section" style="margin-bottom: 24px;">
                    <div class="section-header">
                        <h2>Data Import Calendar</h2>
                        <div class="section-actions">
                            <button class="btn-sm btn-primary" onclick="loadWebhookCalendar()">Refresh</button>
                        </div>
                    </div>
                    <div id="webhook-calendar-container">
                        <div style="padding: 40px; text-align: center; color: var(--stone-400);">Loading calendar...</div>
                    </div>
                </div>

                <div class="content-section">
                    <div class="section-header">
                        <h2>Upload Scraper Data</h2>
                    </div>
                    <div style="padding: 20px; background: #1a1a2e; border-radius: 12px; margin-bottom: 20px;">
                        <p style="margin-bottom: 15px; color: #a0a0a0;">Upload a JSON file from Reddit scraper (e.g., Apify Reddit Scraper Pro)</p>
                        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="scraper-file" accept=".json" style="color: #fff;">
                            <label style="display: flex; align-items: center; gap: 8px; color: #fff;">
                                <input type="checkbox" id="auto-import-checkbox">
                                Auto-import valid opportunities
                            </label>
                            <button class="btn btn-primary" onclick="analyzeScraperData()">Analyze Data</button>
                        </div>
                    </div>

                    <div id="scraper-stats" style="display: none; margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px;">Analysis Results</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-label">Total Posts</div>
                                <div class="stat-value" id="scraper-total">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Valid Opportunities</div>
                                <div class="stat-value" id="scraper-valid">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Imported</div>
                                <div class="stat-value" id="scraper-imported">--</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Skipped</div>
                                <div class="stat-value" id="scraper-skipped">--</div>
                            </div>
                        </div>
                    </div>

                    <div id="scraper-results" style="display: none;">
                        <h3 style="margin-bottom: 15px;">Discovered Opportunities</h3>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Score</th>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Subreddit</th>
                                    <th>Upvotes</th>
                                </tr>
                            </thead>
                            <tbody id="scraper-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <script src="js/config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        const API_BASE_URL = (typeof CONFIG !== 'undefined' && CONFIG.API_BASE_URL) ? CONFIG.API_BASE_URL : '/api/v1';
        let currentUser = null;

        async function init() {
            if (!OppGridAuth.requireAuth({ redirect: 'admin.html' })) return;
            const token = OppGridAuth.getAccessToken();

            try {
                const response = await fetch(`${API_BASE_URL}/users/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Not authenticated');

                currentUser = await response.json();

                if (!currentUser.is_admin) {
                    showToast('Access denied: Admin privileges required', 'error');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                    return;
                }

                document.getElementById('admin-name').textContent = currentUser.name;

                setupNavigation();
                loadDashboard();
            } catch (error) {
                console.error('Auth error:', error);
                OppGridAuth.redirectToSignin({ redirect: 'admin.html' });
            }
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('.sidebar-nav a');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    document.querySelectorAll('[id^="section-"]').forEach(s => s.classList.add('hidden'));
                    document.getElementById(`section-${section}`).classList.remove('hidden');
                    
                    loadSection(section);
                });
            });

            document.getElementById('user-search').addEventListener('input', debounce(() => loadUsers(), 300));
            document.getElementById('user-filter').addEventListener('change', () => loadUsers());
            document.getElementById('opp-search').addEventListener('input', debounce(() => loadOpportunities(), 300));
            document.getElementById('sub-tier-filter').addEventListener('change', () => loadSubscriptions());
            document.getElementById('report-status-filter').addEventListener('change', () => loadReports());
            document.getElementById('partner-search')?.addEventListener('input', debounce(() => loadPartners(), 300));
            document.getElementById('partner-status-filter')?.addEventListener('change', () => loadPartners());
            document.getElementById('tracking-event-filter')?.addEventListener('change', () => loadTrackingEvents());
            document.getElementById('tracking-days')?.addEventListener('change', () => loadTracking());

            document.getElementById('jobruns-name')?.addEventListener('input', debounce(() => loadJobRuns(), 300));
            document.getElementById('jobruns-status')?.addEventListener('change', () => loadJobRuns());
            document.getElementById('audit-action')?.addEventListener('input', debounce(() => loadAuditLogs(), 300));
            document.getElementById('audit-resource-type')?.addEventListener('input', debounce(() => loadAuditLogs(), 300));
            document.getElementById('audit-resource-id')?.addEventListener('input', debounce(() => loadAuditLogs(), 300));
        }

        function loadSection(section) {
            switch(section) {
                case 'dashboard': loadDashboard(); break;
                case 'tracking': loadTracking(); break;
                case 'ops': loadOps(); break;
                case 'users': loadUsers(); break;
                case 'opportunities': loadOpportunities(); break;
                case 'subscriptions': loadSubscriptions(); break;
                case 'partners': loadPartners(); break;
                case 'leads': loadLeads(); loadLeadStats(); break;
                case 'reports': loadReports(); break;
                case 'scraper': loadWebhookCalendar(); break;
            }
        }

        async function loadDashboard() {
            try {
                const response = await fetchWithAuth('/api/v1/admin/stats');
                const stats = await response.json();

                document.getElementById('stat-users').textContent = stats.total_users;
                document.getElementById('stat-verified').textContent = stats.verified_users;
                document.getElementById('stat-opportunities').textContent = stats.total_opportunities;
                document.getElementById('stat-banned').textContent = stats.banned_users;
            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        async function loadTracking() {
            await Promise.all([loadTrackingSummary(), loadTrackingEvents()]);
        }

        async function loadOps() {
            await Promise.all([loadJobRuns(), loadAuditLogs()]);
        }

        function _formatDurationMs(start, end) {
            if (!start || !end) return '';
            const ms = new Date(end).getTime() - new Date(start).getTime();
            if (!Number.isFinite(ms) || ms < 0) return '';
            if (ms < 1000) return `${ms}ms`;
            const s = Math.round(ms / 1000);
            if (s < 60) return `${s}s`;
            const m = Math.floor(s / 60);
            const r = s % 60;
            return `${m}m ${r}s`;
        }

        async function loadJobRuns() {
            const tbody = document.getElementById('jobruns-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading job runs...</td></tr>';

            try {
                let url = '/api/v1/admin/job-runs?limit=50';
                const jobName = document.getElementById('jobruns-name')?.value?.trim();
                const statusFilter = document.getElementById('jobruns-status')?.value;
                if (jobName) url += `&job_name=${encodeURIComponent(jobName)}`;
                if (statusFilter) url += `&status_filter=${encodeURIComponent(statusFilter)}`;

                const response = await fetchWithAuth(url);
                const data = await response.json();
                const items = data.items || [];

                tbody.innerHTML = '';
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">No job runs yet.</td></tr>';
                    return;
                }

                items.forEach(r => {
                    const status = (r.status || 'unknown').toLowerCase();
                    const badgeClass = ['running', 'succeeded', 'failed'].includes(status) ? status : 'pending';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDateTime(r.started_at)}</td>
                        <td><code>${escapeHtml(r.job_name || '')}</code></td>
                        <td><span class="badge badge-${escapeHtml(badgeClass)}">${escapeHtml(status)}</span></td>
                        <td>${escapeHtml(_formatDurationMs(r.started_at, r.finished_at))}</td>
                        <td style="max-width: 520px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(r.error || '')}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Failed to load job runs.</td></tr>';
            }
        }

        async function loadAuditLogs() {
            const tbody = document.getElementById('audit-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading audit logs...</td></tr>';

            try {
                let url = '/api/v1/admin/audit-logs?limit=50';
                const action = document.getElementById('audit-action')?.value?.trim();
                const rt = document.getElementById('audit-resource-type')?.value?.trim();
                const rid = document.getElementById('audit-resource-id')?.value?.trim();
                if (action) url += `&action=${encodeURIComponent(action)}`;
                if (rt) url += `&resource_type=${encodeURIComponent(rt)}`;
                if (rid) url += `&resource_id=${encodeURIComponent(rid)}`;

                const response = await fetchWithAuth(url);
                const data = await response.json();
                const items = data.items || [];

                tbody.innerHTML = '';
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="loading">No audit logs yet.</td></tr>';
                    return;
                }

                items.forEach(a => {
                    const actor = a.actor_user_id ? `#${a.actor_user_id} (${a.actor_type || 'user'})` : (a.actor_type || 'system');
                    const resource = a.resource_type ? `${a.resource_type}${a.resource_id ? `#${a.resource_id}` : ''}` : '';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDateTime(a.created_at)}</td>
                        <td>${escapeHtml(actor)}</td>
                        <td><code>${escapeHtml(a.action || '')}</code></td>
                        <td>${escapeHtml(resource)}</td>
                        <td>${escapeHtml(a.ip_address || '')}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">Failed to load audit logs.</td></tr>';
            }
        }

        async function loadTrackingSummary() {
            try {
                const days = document.getElementById('tracking-days')?.value || '7';
                const response = await fetchWithAuth(`/api/v1/admin/tracking/summary?days=${encodeURIComponent(days)}`);
                const data = await response.json();

                document.getElementById('tracking-total').textContent = data.total_events ?? '--';
                document.getElementById('tracking-pageviews').textContent = data.page_views ?? '--';
                document.getElementById('tracking-top-event').textContent = (data.top_events && data.top_events[0]) ? data.top_events[0].name : '--';
                document.getElementById('tracking-top-path').textContent = (data.top_paths && data.top_paths[0]) ? data.top_paths[0].path : '--';
            } catch (e) {
                console.error('Failed to load tracking summary', e);
            }
        }

        async function loadTrackingEvents() {
            const tbody = document.getElementById('tracking-events-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="4" class="loading">Loading events...</td></tr>';

            try {
                const name = document.getElementById('tracking-event-filter')?.value || '';
                const url = name
                    ? `/api/v1/admin/tracking/events?limit=50&name=${encodeURIComponent(name)}`
                    : '/api/v1/admin/tracking/events?limit=50';
                const response = await fetchWithAuth(url);
                const data = await response.json();
                const items = data.items || [];

                tbody.innerHTML = '';
                if (!items.length) {
                    tbody.innerHTML = '<tr><td colspan="4" class="loading">No events yet.</td></tr>';
                    return;
                }
                items.forEach(ev => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${formatDate(ev.created_at)}</td>
                        <td><code>${escapeHtml(ev.name || '')}</code></td>
                        <td>${escapeHtml(ev.path || '')}</td>
                        <td>${ev.user_id ? `#${ev.user_id}` : ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="4" class="loading">Failed to load events.</td></tr>';
            }
        }

        async function loadUsers() {
            const search = document.getElementById('user-search').value;
            const filter = document.getElementById('user-filter').value;
            const tbody = document.getElementById('users-table-body');
            
            try {
                let url = '/api/v1/admin/users?limit=50';
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (filter === 'admin') url += '&is_admin=true';
                if (filter === 'banned') url += '&is_banned=true';
                if (filter === 'verified') url += '&is_verified=true';

                const response = await fetchWithAuth(url);
                const users = await response.json();

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${user.name.charAt(0).toUpperCase()}</div>
                                <div class="user-info">
                                    <span class="user-name">${escapeHtml(user.name)}</span>
                                    <span class="user-email">${escapeHtml(user.email)}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            ${user.is_verified ? '<span class="badge badge-verified">Verified</span>' : ''}
                            ${user.is_banned ? '<span class="badge badge-banned">Banned</span>' : ''}
                        </td>
                        <td>
                            ${user.is_admin ? '<span class="badge badge-admin">Admin</span>' : '<span class="badge badge-free">User</span>'}
                        </td>
                        <td>${formatDate(user.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                ${!user.is_admin ? `
                                    <button class="btn-sm btn-primary" onclick="promoteUser(${user.id})">Make Admin</button>
                                ` : user.id !== currentUser.id ? `
                                    <button class="btn-sm btn-secondary" onclick="demoteUser(${user.id})">Remove Admin</button>
                                ` : ''}
                                ${!user.is_banned && user.id !== currentUser.id ? `
                                    <button class="btn-sm btn-danger" onclick="showBanModal(${user.id}, '${escapeHtml(user.name)}')">Ban</button>
                                ` : user.is_banned ? `
                                    <button class="btn-sm btn-success" onclick="unbanUser(${user.id})">Unban</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load users:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load users</td></tr>';
            }
        }

        async function loadOpportunities() {
            const search = document.getElementById('opp-search').value;
            const tbody = document.getElementById('opportunities-table-body');
            
            try {
                let url = '/api/v1/admin/opportunities?limit=50';
                if (search) url += `&search=${encodeURIComponent(search)}`;

                const response = await fetchWithAuth(url);
                const opportunities = await response.json();

                if (opportunities.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No opportunities found</td></tr>';
                    return;
                }

                tbody.innerHTML = opportunities.map(opp => `
                    <tr>
                        <td>
                            <a href="opportunity.html?id=${opp.id}" style="color: var(--violet-600); text-decoration: none;">
                                ${escapeHtml(opp.title.substring(0, 50))}${opp.title.length > 50 ? '...' : ''}
                            </a>
                        </td>
                        <td>${escapeHtml(opp.author_name)}</td>
                        <td><span class="badge badge-${opp.status === 'published' ? 'active' : 'pending'}">${opp.status}</span></td>
                        <td>${opp.validation_count}</td>
                        <td>${formatDate(opp.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-sm btn-danger" onclick="deleteOpportunity(${opp.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load opportunities:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Failed to load opportunities</td></tr>';
            }
        }

        async function loadSubscriptions() {
            const tierFilter = document.getElementById('sub-tier-filter').value;
            const tbody = document.getElementById('subscriptions-table-body');
            
            try {
                let url = '/api/v1/admin/subscriptions?limit=50';
                if (tierFilter) url += `&tier_filter=${tierFilter}`;

                const response = await fetchWithAuth(url);
                const subscriptions = await response.json();

                if (subscriptions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No subscriptions found</td></tr>';
                    return;
                }

                tbody.innerHTML = subscriptions.map(sub => `
                    <tr>
                        <td>
                            <div class="user-cell">
                                <div class="user-avatar">${sub.user_name.charAt(0).toUpperCase()}</div>
                                <div class="user-info">
                                    <span class="user-name">${escapeHtml(sub.user_name)}</span>
                                    <span class="user-email">${escapeHtml(sub.user_email)}</span>
                                </div>
                            </div>
                        </td>
                        <td><span class="badge badge-${sub.tier}">${sub.tier.toUpperCase()}</span></td>
                        <td><span class="badge badge-${sub.status}">${sub.status}</span></td>
                        <td>${sub.current_period_end ? formatDate(sub.current_period_end) : 'N/A'}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-sm btn-secondary" onclick="showTierModal(${sub.id}, ${sub.user_id}, '${sub.tier}')">Change Tier</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load subscriptions:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Failed to load subscriptions</td></tr>';
            }
        }

        async function loadReports() {
            const status = document.getElementById('report-status-filter').value;
            const tbody = document.getElementById('reports-table-body');
            
            try {
                const response = await fetchWithAuth(`/api/v1/moderation/reports?status_filter=${status}&limit=50`);
                const reports = await response.json();

                if (reports.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No reports found</td></tr>';
                    return;
                }

                tbody.innerHTML = reports.map(report => `
                    <tr>
                        <td>${report.content_type} #${report.content_id}</td>
                        <td>${report.reason}</td>
                        <td>User #${report.reporter_id}</td>
                        <td><span class="badge badge-${report.status}">${report.status}</span></td>
                        <td>${formatDate(report.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                ${report.status === 'pending' || report.status === 'reviewing' ? `
                                    <button class="btn-sm btn-primary" onclick="resolveReport(${report.id})">Resolve</button>
                                    <button class="btn-sm btn-secondary" onclick="dismissReport(${report.id})">Dismiss</button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load reports:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">Failed to load reports</td></tr>';
            }
        }

        async function promoteUser(userId) {
            if (!confirm('Are you sure you want to make this user an admin?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/promote`, { method: 'POST' });
                showToast('User promoted to admin', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to promote user', 'error');
            }
        }

        async function demoteUser(userId) {
            if (!confirm('Are you sure you want to remove admin privileges?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/demote`, { method: 'POST' });
                showToast('Admin privileges removed', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to demote user', 'error');
            }
        }

        function showBanModal(userId, userName) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Ban User: ${escapeHtml(userName)}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="ban-reason">Reason for ban</label>
                            <textarea id="ban-reason" rows="3" placeholder="Enter the reason for banning this user..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-danger" onclick="banUser(${userId})">Ban User</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        async function banUser(userId) {
            const reason = document.getElementById('ban-reason').value;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/ban`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ban_reason: reason })
                });
                closeModal();
                showToast('User banned successfully', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to ban user', 'error');
            }
        }

        async function unbanUser(userId) {
            if (!confirm('Are you sure you want to unban this user?')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/users/${userId}/unban`, { method: 'POST' });
                showToast('User unbanned successfully', 'success');
                loadUsers();
            } catch (error) {
                showToast('Failed to unban user', 'error');
            }
        }

        async function deleteOpportunity(id) {
            if (!confirm('Are you sure you want to delete this opportunity? This cannot be undone.')) return;
            
            try {
                await fetchWithAuth(`/api/v1/admin/opportunities/${id}`, { method: 'DELETE' });
                showToast('Opportunity deleted', 'success');
                loadOpportunities();
            } catch (error) {
                showToast('Failed to delete opportunity', 'error');
            }
        }

        function showTierModal(subscriptionId, userId, currentTier) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>Change Subscription Tier</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="new-tier">New Tier</label>
                            <select id="new-tier">
                                <option value="free" ${currentTier === 'free' ? 'selected' : ''}>Free</option>
                                <option value="pro" ${currentTier === 'pro' ? 'selected' : ''}>Pro</option>
                                <option value="business" ${currentTier === 'business' ? 'selected' : ''}>Business</option>
                                <option value="enterprise" ${currentTier === 'enterprise' ? 'selected' : ''}>Enterprise</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-primary" onclick="updateTier(${subscriptionId}, ${userId})">Update Tier</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        async function updateTier(subscriptionId, userId) {
            const newTier = document.getElementById('new-tier').value;
            
            try {
                if (subscriptionId) {
                    await fetchWithAuth(`/api/v1/admin/subscriptions/${subscriptionId}/tier?tier=${newTier}`, { method: 'PATCH' });
                } else {
                    await fetchWithAuth(`/api/v1/admin/users/${userId}/grant-subscription?tier=${newTier}`, { method: 'POST' });
                }
                closeModal();
                showToast('Subscription updated', 'success');
                loadSubscriptions();
            } catch (error) {
                showToast('Failed to update subscription', 'error');
            }
        }

        async function loadPartners() {
            const tbody = document.getElementById('partners-table-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="6" class="loading">Loading partners...</td></tr>';

            try {
                window._partnersById = window._partnersById || {};
                let url = '/api/v1/admin/partners?limit=50';
                const search = document.getElementById('partner-search')?.value?.trim();
                const statusFilter = document.getElementById('partner-status-filter')?.value;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (statusFilter) url += `&status_filter=${encodeURIComponent(statusFilter)}`;

                const response = await fetchWithAuth(url);
                const partners = await response.json();
                tbody.innerHTML = '';
                window._partnersById = {};
                (partners || []).forEach(p => { if (p && p.id != null) window._partnersById[p.id] = p; });

                if (!partners || partners.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">No partners yet.</td></tr>';
                    return;
                }

                partners.forEach(p => {
                    const contact = [p.contact_name, p.contact_email].filter(Boolean).join('  ') || '';
                    const website = p.website_url ? `<a href="${escapeHtml(p.website_url)}" target="_blank" rel="noopener noreferrer" style="color:#2563eb;text-decoration:none;">Website</a>` : '';
                    const nameCell = `${escapeHtml(p.name)} ${website ? `<div style="font-size:12px;color:#78716c;margin-top:4px;">${website}</div>` : ''}`;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${nameCell}</td>
                        <td>${escapeHtml(p.category || '')}</td>
                        <td><span class="badge badge-${escapeHtml(p.status || 'identified')}">${escapeHtml(p.status || 'identified')}</span></td>
                        <td>${escapeHtml(contact)}</td>
                        <td>${formatDate(p.created_at)}</td>
                        <td>
                            <button class="btn-sm btn-secondary" onclick="showPartnerEditModal(${p.id})">Edit</button>
                            <button class="btn-sm btn-danger" onclick="deletePartner(${p.id})">Delete</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">Failed to load partners.</td></tr>';
            }
        }

        function showPartnerEditModal(id) {
            const p = (window._partnersById || {})[id];
            if (!p) {
                showToast('Partner not found in list. Refreshing...', 'error');
                loadPartners();
                return;
            }
            showPartnerModal(
                p.id,
                p.name || '',
                p.category || '',
                p.website_url || '',
                p.contact_name || '',
                p.contact_email || '',
                p.status || 'identified',
                p.notes || ''
            );
        }

        function showPartnerModal(id = null, name = '', category = '', website_url = '', contact_name = '', contact_email = '', status = 'identified', notes = '') {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${id ? 'Edit Partner' : 'Add Partner'}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="partner-name">Name</label>
                            <input id="partner-name" value="${escapeAttr(name)}" />
                        </div>
                        <div class="form-group">
                            <label for="partner-category">Category</label>
                            <input id="partner-category" value="${escapeAttr(category)}" placeholder="e.g. payments, analytics, CRM" />
                        </div>
                        <div class="form-group">
                            <label for="partner-website">Website URL</label>
                            <input id="partner-website" value="${escapeAttr(website_url)}" placeholder="https://..." />
                        </div>
                        <div class="form-group">
                            <label for="partner-contact-name">Contact name</label>
                            <input id="partner-contact-name" value="${escapeAttr(contact_name)}" />
                        </div>
                        <div class="form-group">
                            <label for="partner-contact-email">Contact email</label>
                            <input id="partner-contact-email" value="${escapeAttr(contact_email)}" />
                        </div>
                        <div class="form-group">
                            <label for="partner-status">Status</label>
                            <select id="partner-status">
                                <option value="identified" ${status === 'identified' ? 'selected' : ''}>Identified</option>
                                <option value="contacted" ${status === 'contacted' ? 'selected' : ''}>Contacted</option>
                                <option value="in_talks" ${status === 'in_talks' ? 'selected' : ''}>In talks</option>
                                <option value="active" ${status === 'active' ? 'selected' : ''}>Active</option>
                                <option value="paused" ${status === 'paused' ? 'selected' : ''}>Paused</option>
                                <option value="rejected" ${status === 'rejected' ? 'selected' : ''}>Rejected</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="partner-notes">Notes</label>
                            <textarea id="partner-notes" rows="4" placeholder="Outreach notes, dates, next step...">${escapeHtml(notes)}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-primary" onclick="savePartner(${id || 'null'})">${id ? 'Save changes' : 'Add partner'}</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }

        async function savePartner(id) {
            const payload = {
                name: document.getElementById('partner-name').value.trim(),
                category: document.getElementById('partner-category').value.trim() || null,
                website_url: document.getElementById('partner-website').value.trim() || null,
                contact_name: document.getElementById('partner-contact-name').value.trim() || null,
                contact_email: document.getElementById('partner-contact-email').value.trim() || null,
                status: document.getElementById('partner-status').value,
                notes: document.getElementById('partner-notes').value.trim() || null,
            };

            if (!payload.name) {
                showToast('Partner name is required', 'error');
                return;
            }

            try {
                if (id) {
                    await fetchWithAuth(`/api/v1/admin/partners/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showToast('Partner updated', 'success');
                } else {
                    await fetchWithAuth('/api/v1/admin/partners', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showToast('Partner added', 'success');
                }
                closeModal();
                loadPartners();
            } catch (error) {
                showToast('Failed to save partner', 'error');
            }
        }

        async function deletePartner(id) {
            if (!confirm('Delete this partner entry?')) return;
            try {
                await fetchWithAuth(`/api/v1/admin/partners/${id}`, { method: 'DELETE' });
                showToast('Partner deleted', 'success');
                loadPartners();
            } catch (error) {
                showToast('Failed to delete partner', 'error');
            }
        }

        async function loadLeadStats() {
            try {
                const response = await fetchWithAuth('/api/v1/admin/leads/stats');
                const stats = await response.json();
                document.getElementById('leads-total').textContent = stats.total;
                document.getElementById('leads-new').textContent = stats.new;
                document.getElementById('leads-qualified').textContent = stats.qualified;
                document.getElementById('leads-conversion').textContent = stats.conversion_rate + '%';
            } catch (error) {
                console.error('Failed to load lead stats:', error);
            }
        }

        async function loadLeads() {
            const search = document.getElementById('lead-search').value;
            const statusFilter = document.getElementById('lead-status-filter').value;
            const tbody = document.getElementById('leads-table-body');
            
            try {
                let url = '/api/v1/admin/leads/?limit=50';
                if (search) url += `&search=${encodeURIComponent(search)}`;
                if (statusFilter) url += `&status_filter=${statusFilter}`;

                const response = await fetchWithAuth(url);
                const data = await response.json();
                const leads = data.items || [];

                if (leads.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No leads found</td></tr>';
                    return;
                }

                tbody.innerHTML = leads.map(lead => `
                    <tr>
                        <td>${escapeHtml(lead.email)}</td>
                        <td>${escapeHtml(lead.name || '-')}</td>
                        <td>${escapeHtml(lead.company || '-')}</td>
                        <td><span class="badge badge-${lead.status}">${lead.status}</span></td>
                        <td>${lead.source}</td>
                        <td>Step ${lead.email_sequence_step}/3</td>
                        <td>${formatDate(lead.created_at)}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-sm btn-secondary" onclick="showLeadModal(${lead.id})">Edit</button>
                                <button class="btn-sm btn-primary" onclick="sendNurtureEmail(${lead.id})" ${lead.email_sequence_step >= 3 || !lead.email_opt_in ? 'disabled' : ''}>Nurture</button>
                                <button class="btn-sm btn-danger" onclick="deleteLead(${lead.id})">Delete</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Failed to load leads:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">Failed to load leads</td></tr>';
            }
        }

        function showLeadModal(id = null, data = null) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            
            const email = data?.email || '';
            const name = data?.name || '';
            const company = data?.company || '';
            const phone = data?.phone || '';
            const source = data?.source || 'organic';
            const status = data?.status || 'new';
            const interest = data?.interest_category || '';
            const notes = data?.notes || '';
            const emailOptIn = data?.email_opt_in !== false;

            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${id ? 'Edit Lead' : 'Add Lead'}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="lead-email">Email *</label>
                            <input id="lead-email" value="${escapeAttr(email)}" type="email" required />
                        </div>
                        <div class="form-group">
                            <label for="lead-name">Name</label>
                            <input id="lead-name" value="${escapeAttr(name)}" />
                        </div>
                        <div class="form-group">
                            <label for="lead-company">Company</label>
                            <input id="lead-company" value="${escapeAttr(company)}" />
                        </div>
                        <div class="form-group">
                            <label for="lead-phone">Phone</label>
                            <input id="lead-phone" value="${escapeAttr(phone)}" />
                        </div>
                        <div class="form-group">
                            <label for="lead-source">Source</label>
                            <select id="lead-source">
                                <option value="organic" ${source === 'organic' ? 'selected' : ''}>Organic</option>
                                <option value="referral" ${source === 'referral' ? 'selected' : ''}>Referral</option>
                                <option value="paid_ads" ${source === 'paid_ads' ? 'selected' : ''}>Paid Ads</option>
                                <option value="social" ${source === 'social' ? 'selected' : ''}>Social</option>
                                <option value="partner" ${source === 'partner' ? 'selected' : ''}>Partner</option>
                                <option value="direct" ${source === 'direct' ? 'selected' : ''}>Direct</option>
                                <option value="other" ${source === 'other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        ${id ? `
                        <div class="form-group">
                            <label for="lead-status">Status</label>
                            <select id="lead-status">
                                <option value="new" ${status === 'new' ? 'selected' : ''}>New</option>
                                <option value="contacted" ${status === 'contacted' ? 'selected' : ''}>Contacted</option>
                                <option value="qualified" ${status === 'qualified' ? 'selected' : ''}>Qualified</option>
                                <option value="nurturing" ${status === 'nurturing' ? 'selected' : ''}>Nurturing</option>
                                <option value="converted" ${status === 'converted' ? 'selected' : ''}>Converted</option>
                                <option value="lost" ${status === 'lost' ? 'selected' : ''}>Lost</option>
                            </select>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label for="lead-interest">Interest Category</label>
                            <input id="lead-interest" value="${escapeAttr(interest)}" placeholder="e.g., SaaS, FinTech, HealthTech" />
                        </div>
                        <div class="form-group">
                            <label for="lead-notes">Notes</label>
                            <textarea id="lead-notes" rows="3" placeholder="Additional notes...">${escapeHtml(notes)}</textarea>
                        </div>
                        <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="lead-email-opt-in" ${emailOptIn ? 'checked' : ''} />
                            <label for="lead-email-opt-in" style="margin: 0;">Email opt-in (receives nurture emails)</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn-sm btn-secondary" onclick="closeModal()">Cancel</button>
                        <button class="btn-sm btn-primary" onclick="saveLead(${id || 'null'})">${id ? 'Save changes' : 'Add lead'}</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);

            if (id && !data) {
                fetchWithAuth(`/api/v1/admin/leads/${id}`).then(r => r.json()).then(leadData => {
                    document.getElementById('lead-email').value = leadData.email || '';
                    document.getElementById('lead-name').value = leadData.name || '';
                    document.getElementById('lead-company').value = leadData.company || '';
                    document.getElementById('lead-phone').value = leadData.phone || '';
                    document.getElementById('lead-source').value = leadData.source || 'organic';
                    document.getElementById('lead-status').value = leadData.status || 'new';
                    document.getElementById('lead-interest').value = leadData.interest_category || '';
                    document.getElementById('lead-notes').value = leadData.notes || '';
                    document.getElementById('lead-email-opt-in').checked = leadData.email_opt_in !== false;
                });
            }
        }

        async function saveLead(id) {
            const payload = {
                email: document.getElementById('lead-email').value.trim(),
                name: document.getElementById('lead-name').value.trim() || null,
                company: document.getElementById('lead-company').value.trim() || null,
                phone: document.getElementById('lead-phone').value.trim() || null,
                source: document.getElementById('lead-source').value,
                interest_category: document.getElementById('lead-interest').value.trim() || null,
                notes: document.getElementById('lead-notes').value.trim() || null,
                email_opt_in: document.getElementById('lead-email-opt-in').checked,
            };

            if (id) {
                payload.status = document.getElementById('lead-status').value;
            }

            if (!payload.email) {
                showToast('Email is required', 'error');
                return;
            }

            try {
                if (id) {
                    await fetchWithAuth(`/api/v1/admin/leads/${id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showToast('Lead updated', 'success');
                } else {
                    await fetchWithAuth('/api/v1/admin/leads/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    showToast('Lead added', 'success');
                }
                closeModal();
                loadLeads();
                loadLeadStats();
            } catch (error) {
                showToast('Failed to save lead', 'error');
            }
        }

        async function deleteLead(id) {
            if (!confirm('Delete this lead?')) return;
            try {
                await fetchWithAuth(`/api/v1/admin/leads/${id}`, { method: 'DELETE' });
                showToast('Lead deleted', 'success');
                loadLeads();
                loadLeadStats();
            } catch (error) {
                showToast('Failed to delete lead', 'error');
            }
        }

        async function sendNurtureEmail(id) {
            try {
                const response = await fetchWithAuth(`/api/v1/admin/leads/${id}/send-nurture-email`, { method: 'POST' });
                const result = await response.json();
                showToast(result.message || 'Nurture email sent', 'success');
                loadLeads();
            } catch (error) {
                showToast('Failed to send nurture email', 'error');
            }
        }

        async function bulkNurtureLeads() {
            if (!confirm('Send nurture emails to all eligible leads (status=nurturing, opted in, not at step 3)?')) return;
            try {
                const response = await fetchWithAuth('/api/v1/admin/leads/bulk-nurture', { method: 'POST' });
                const result = await response.json();
                showToast(`${result.sent_count} nurture emails sent`, 'success');
                loadLeads();
                loadLeadStats();
            } catch (error) {
                showToast('Failed to send bulk nurture emails', 'error');
            }
        }

        async function resolveReport(reportId) {
            try {
                await fetchWithAuth(`/api/v1/moderation/reports/${reportId}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action_taken: 'Content reviewed and action taken', moderator_notes: '' })
                });
                showToast('Report resolved', 'success');
                loadReports();
            } catch (error) {
                showToast('Failed to resolve report', 'error');
            }
        }

        async function dismissReport(reportId) {
            try {
                await fetchWithAuth(`/api/v1/moderation/reports/${reportId}/dismiss`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ moderator_notes: 'Report dismissed' })
                });
                showToast('Report dismissed', 'success');
                loadReports();
            } catch (error) {
                showToast('Failed to dismiss report', 'error');
            }
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        async function fetchWithAuth(url, options = {}) {
            const token = OppGridAuth.getAccessToken();
            const response = await fetch(`${API_BASE_URL}${url}`, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            
            return response;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttr(text) {
            return escapeHtml(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }


        const SOURCE_COLORS = {
            twitter: { bg: 'rgba(59, 130, 246, 0.2)', border: '#3b82f6', text: '#60a5fa' },
            reddit: { bg: 'rgba(249, 115, 22, 0.2)', border: '#f97316', text: '#fb923c' },
            google_maps: { bg: 'rgba(34, 197, 94, 0.2)', border: '#22c55e', text: '#4ade80' },
            yelp: { bg: 'rgba(239, 68, 68, 0.2)', border: '#ef4444', text: '#f87171' },
            craigslist: { bg: 'rgba(168, 85, 247, 0.2)', border: '#a855f7', text: '#c084fc' },
            custom: { bg: 'rgba(156, 163, 175, 0.2)', border: '#9ca3af', text: '#d1d5db' },
            nextdoor: { bg: 'rgba(16, 185, 129, 0.2)', border: '#10b981', text: '#34d399' },
            linkedin: { bg: 'rgba(59, 130, 246, 0.2)', border: '#0077b5', text: '#0ea5e9' },
            angel_list: { bg: 'rgba(0, 0, 0, 0.2)', border: '#333', text: '#a1a1aa' },
            crunchbase: { bg: 'rgba(39, 95, 255, 0.2)', border: '#275fff', text: '#60a5fa' },
            facebook: { bg: 'rgba(24, 119, 242, 0.2)', border: '#1877f2', text: '#3b82f6' },
            instagram: { bg: 'rgba(225, 48, 108, 0.2)', border: '#e1306c', text: '#f472b6' },
            youtube: { bg: 'rgba(255, 0, 0, 0.2)', border: '#ff0000', text: '#f87171' },
            tiktok: { bg: 'rgba(0, 0, 0, 0.2)', border: '#000', text: '#a1a1aa' },
            glassdoor: { bg: 'rgba(12, 170, 65, 0.2)', border: '#0caa41', text: '#4ade80' },
            indeed: { bg: 'rgba(0, 63, 153, 0.2)', border: '#003f99', text: '#60a5fa' },
            apify: { bg: 'rgba(0, 148, 133, 0.2)', border: '#009485', text: '#2dd4bf' },
        };

        function getSourceColor(source) {
            return SOURCE_COLORS[source] || SOURCE_COLORS.custom;
        }

        async function loadWebhookCalendar() {
            const container = document.getElementById('webhook-calendar-container');
            
            try {
                const response = await fetch('/api/v1/webhooks/calendar?days=30');
                if (!response.ok) throw new Error('Failed to fetch calendar data');
                const data = await response.json();
                
                const days = [];
                const today = new Date();
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    days.push({
                        date: dateStr,
                        dayOfWeek: date.getDay(),
                        dayOfMonth: date.getDate(),
                        month: date.toLocaleDateString('en-US', { month: 'short' }),
                        isToday: i === 0,
                    });
                }

                let sourceBadgesHtml = data.sources.map(source => {
                    const colors = getSourceColor(source);
                    const count = data.source_totals[source] || 0;
                    return `<div style="padding: 6px 12px; border-radius: 20px; background: ${colors.bg}; border: 1px solid ${colors.border}; color: ${colors.text}; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                        <span style="text-transform: capitalize;">${source.replace('_', ' ')}</span>
                        <span style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 11px;">${count.toLocaleString()}</span>
                    </div>`;
                }).join('');

                let calendarHtml = `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
                        <div>
                            <h3 style="color: #fff; margin: 0;">Last 30 Days</h3>
                            <p style="color: var(--stone-400); font-size: 13px; margin-top: 4px;">Data imports by source</p>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 28px; font-weight: 700; color: #fff;">${data.total_items.toLocaleString()}</div>
                            <div style="font-size: 12px; color: var(--stone-400);">Total Items</div>
                        </div>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">${sourceBadgesHtml}</div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-bottom: 8px;">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => `<div style="text-align: center; font-size: 11px; color: var(--stone-500); padding: 4px;">${d}</div>`).join('')}
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px;">
                `;

                if (days[0].dayOfWeek > 0) {
                    for (let i = 0; i < days[0].dayOfWeek; i++) {
                        calendarHtml += `<div style="height: 80px;"></div>`;
                    }
                }

                days.forEach(day => {
                    const dayData = data.calendar[day.date] || {};
                    const hasData = Object.keys(dayData).length > 0;
                    const totalCount = Object.values(dayData).reduce((sum, count) => sum + count, 0);
                    
                    let barsHtml = Object.entries(dayData).slice(0, 4).map(([source, count]) => {
                        const colors = getSourceColor(source);
                        return `<div style="width: 100%; height: 4px; border-radius: 2px; background: ${colors.bg}; border: 1px solid ${colors.border};" title="${source}: ${count}"></div>`;
                    }).join('');

                    calendarHtml += `
                        <div style="height: 80px; padding: 6px; border-radius: 8px; border: 1px solid ${day.isToday ? '#3b82f6' : 'var(--stone-700)'}; background: ${hasData ? 'rgba(255,255,255,0.03)' : 'transparent'}; ${day.isToday ? 'background: rgba(59,130,246,0.1);' : ''} cursor: pointer;" onclick="showDayDetails('${day.date}', ${JSON.stringify(dayData).replace(/"/g, '&quot;')})">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <span style="font-size: 11px; font-weight: 500; color: ${day.isToday ? '#60a5fa' : 'var(--stone-400)'};">
                                    ${day.dayOfMonth === 1 ? day.month + ' ' + day.dayOfMonth : day.dayOfMonth}
                                </span>
                                ${totalCount > 0 ? `<span style="font-size: 11px; font-weight: 700; color: #fff; background: var(--stone-700); padding: 2px 6px; border-radius: 4px;">${totalCount}</span>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 2px; margin-top: 6px;">${barsHtml}</div>
                        </div>
                    `;
                });

                calendarHtml += '</div><div id="day-details-container"></div>';
                container.innerHTML = calendarHtml;
                
            } catch (error) {
                container.innerHTML = `<div style="padding: 40px; text-align: center; color: #ef4444;">Error: ${error.message}</div>`;
            }
        }

        function showDayDetails(dateStr, dayData) {
            const container = document.getElementById('day-details-container');
            if (!dayData || Object.keys(dayData).length === 0) {
                container.innerHTML = '';
                return;
            }

            const date = new Date(dateStr + 'T00:00:00');
            const formattedDate = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            let cardsHtml = Object.entries(dayData).map(([source, count]) => {
                const colors = getSourceColor(source);
                return `<div style="padding: 16px; border-radius: 8px; background: ${colors.bg}; border: 1px solid ${colors.border};">
                    <p style="font-size: 13px; text-transform: capitalize; color: ${colors.text}; margin: 0;">${source.replace('_', ' ')}</p>
                    <p style="font-size: 28px; font-weight: 700; color: #fff; margin: 8px 0 4px;">${count.toLocaleString()}</p>
                    <p style="font-size: 11px; color: var(--stone-400); margin: 0;">items imported</p>
                </div>`;
            }).join('');

            container.innerHTML = `
                <div style="margin-top: 16px; padding: 16px; background: var(--stone-800); border-radius: 8px; border: 1px solid var(--stone-700);">
                    <h3 style="color: #fff; margin: 0 0 12px;">${formattedDate}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px;">${cardsHtml}</div>
                </div>
            `;
        }

        async function analyzeScraperData() {
            const fileInput = document.getElementById('scraper-file');
            const autoImport = document.getElementById('auto-import-checkbox').checked;
            
            if (!fileInput.files || !fileInput.files[0]) {
                showToast('Please select a JSON file', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showToast('Analyzing scraper data...', 'info');
                
                const url = `/api/v1/scraper/analyze?auto_import=${autoImport}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Analysis failed');
                }
                
                const result = await response.json();
                
                document.getElementById('scraper-stats').style.display = 'block';
                document.getElementById('scraper-total').textContent = result.total_posts;
                document.getElementById('scraper-valid').textContent = result.valid_opportunities;
                document.getElementById('scraper-imported').textContent = result.imported;
                document.getElementById('scraper-skipped').textContent = result.skipped;
                
                if (result.opportunities && result.opportunities.length > 0) {
                    document.getElementById('scraper-results').style.display = 'block';
                    const tbody = document.getElementById('scraper-table-body');
                    tbody.innerHTML = result.opportunities.map(opp => `
                        <tr>
                            <td><span class="badge ${opp.confidence_score >= 0.9 ? 'badge-pro' : opp.confidence_score >= 0.8 ? 'badge-plus' : 'badge-free'}">${opp.confidence_score.toFixed(2)}</span></td>
                            <td>${escapeHtml(opp.title.substring(0, 80))}${opp.title.length > 80 ? '...' : ''}</td>
                            <td>${escapeHtml(opp.category)}</td>
                            <td>r/${escapeHtml(opp.subreddit || 'unknown')}</td>
                            <td>${opp.upvotes}</td>
                        </tr>
                    `).join('');
                }
                
                if (autoImport && result.imported > 0) {
                    showToast(`Imported ${result.imported} opportunities!`, 'success');
                } else {
                    showToast(`Found ${result.valid_opportunities} valid opportunities`, 'success');
                }
                
            } catch (error) {
                console.error('Scraper analysis error:', error);
                showToast(error.message || 'Failed to analyze data', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('token');
            window.location.href = 'signin.html';
        }

        init();
    </script>
</body>
</html>
